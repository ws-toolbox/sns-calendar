<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SNSÊäïÁ®ø„Ç´„É¨„É≥„ÉÄ„ÉºÁÆ°ÁêÜ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
</head>
<body class="bg-gradient-to-br from-purple-50 to-blue-50 min-h-screen">
    <div id="app" class="max-w-[1920px] mx-auto p-6"></div>

    <script>
        const CLIENT_ID = '417822818519-8imosvo7c9e2gem7cp0rse0vm8vrjlou.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/spreadsheets';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const FOLDER_NAME = 'SNSÊäïÁ®øÁÆ°ÁêÜ';
        const SHARED_DRIVE_ID = '0AHJk3pS7tSEgUk9PVA';
        const TARGET_FOLDER_ID = '1I23qmcfZ_x8c15NtW54vjhKQb7waJi-E';
        const SPREADSHEET_ID = '1QOwpEbvttoE51vjBNy79IEwPEUqAPBWMXYTB9on_NIw';
        const VIDEO_FOLDER_ID = '1085XOWlyw--O2ITRwS2kum2dXKZ8s87c';
        const APP_VERSION = '2025/01/15 17:15';

        let gapiInited = false;
        let gisInited = false;
        let tokenClient;
        let accessToken = null;
        let fileId = null;

        let state = {
            currentDate: new Date(),
            posts: {},
            selectedDate: null,
            editingPostId: null,
            viewMode: 'edit',
            isSignedIn: false,
            isSaving: false,
            folderId: null,
            lastUpdated: null,
            currentYear: new Date().getFullYear(), // ËøΩÂä†
            formData: {title: '', platforms: [], text: '', images: [], checks: [], completedChecks: []}
        };

        async function findAndDownloadVideo(productNumber) {
            if (!state.isSignedIn || !productNumber) {
                showMessage('ÂïÜÂìÅÁï™Âè∑„ÅåÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
                return;
            }
        
            try {
                showMessage('ÂãïÁîª„ÇíÊ§úÁ¥¢‰∏≠...', 'success');
        
                // ÂãïÁîª„Éï„Ç°„Ç§„É´„ÇíÊ§úÁ¥¢
                const response = await gapi.client.drive.files.list({
                    q: `name='${productNumber}.mp4' and '${VIDEO_FOLDER_ID}' in parents and trashed=false`,
                    fields: 'files(id, name, webContentLink)',
                    spaces: 'drive',
                    supportsAllDrives: true,
                    includeItemsFromAllDrives: true
                });
        
                if (response.result.files && response.result.files.length > 0) {
                    const fileId = response.result.files[0].id;
                    const downloadUrl = `https://drive.google.com/uc?export=download&id=${fileId}`;
                    
                    // „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„ÇíÈñãÂßã
                    window.open(downloadUrl, '_blank');
                    showMessage('ÂãïÁîª„ÅÆ„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„ÇíÈñãÂßã„Åó„Åæ„Åó„Åü', 'success');
                } else {
                    showMessage(`ÂãïÁîª„Éï„Ç°„Ç§„É´„Äå${productNumber}.mp4„Äç„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü`, 'error');
                }
            } catch (error) {
                console.error('ÂãïÁîªÊ§úÁ¥¢„Ç®„É©„Éº:', error);
                showMessage('ÂãïÁîª„ÅÆÊ§úÁ¥¢„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }

        async function changeMonth(offset) {
            const oldYear = state.currentDate.getFullYear();
            state.currentDate.setMonth(state.currentDate.getMonth() + offset);
            const newYear = state.currentDate.getFullYear();
            
            // Âπ¥„ÅåÂ§â„Çè„Å£„ÅüÂ†¥Âêà„ÅÆ„ÅøÂÜçË™≠„ÅøËæº„Åø
            if (oldYear !== newYear && state.currentYear !== newYear) {
                state.currentYear = newYear;
                await loadYearData();
            }
            
            render();
        }
        
        function copyProductUrl(productNumber) {
            const url = `https://winds-score.com/products/${productNumber}`;
            copyToClipboard(url);
        }

        function getCurrentYearFileName() {
            const currentYear = new Date().getFullYear();
            return `sns_calendar_data_${currentYear}.json`;
        }

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                discoveryDocs: [
                    DISCOVERY_DOC,
                    'https://sheets.googleapis.com/$discovery/rest?version=v4'
                ]
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        async function uploadMediaToDrive(file) {
            if (!state.isSignedIn) return null;
        
            try {
                const metadata = {
                    name: file.name,
                    parents: [VIDEO_FOLDER_ID] // ÂãïÁîªÁî®„ÅÆ„Éï„Ç©„É´„ÉÄID„ÇíÂÆöÁæ©
                };
        
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', file);
        
                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&supportsAllDrives=true', {
                    method: 'POST',
                    headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
                    body: form
                });
        
                if (!response.ok) {
                    throw new Error(`„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Å´Â§±Êïó: ${response.status}`);
                }
        
                const result = await response.json();
                return result.id; // „Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Åü„Éï„Ç°„Ç§„É´„ÅÆID
            } catch (error) {
                console.error('„É°„Éá„Ç£„Ç¢„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Ç®„É©„Éº:', error);
                showMessage('„É°„Éá„Ç£„Ç¢„ÅÆ„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Å´Â§±Êïó', 'error');
                return null;
            }
        }

        async function exportToSpreadsheet() {
            if (!state.isSignedIn) {
                showMessage('ÂÖà„Å´Google Drive„Å´Êé•Á∂ö„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }
        
            if (Object.keys(state.posts).length === 0) {
                showMessage('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„Çã„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'error');
                return;
            }
        
            try {
                showMessage('„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„Å´Êõ∏„ÅçËæº„Åø‰∏≠...', 'success');
        
                // „Éá„Éº„Çø„ÇíÊ∫ñÂÇô
                const headers = [['ÊäïÁ®øÊó•', '„Çø„Ç§„Éà„É´', 'ÂïÜÂìÅÁï™Âè∑', 'ÂãïÁîªÂüãËæº', 'ÊäïÁ®øÂÖà', 'ÊäïÁ®ø„ÉÜ„Ç≠„Çπ„Éà', '„É™„É≥„ÇØÂÖà', 'ÂÇôËÄÉ', '„ÉÅ„Çß„ÉÉ„ÇØÂÆå‰∫ÜËÄÖ', 'ÊúÄÁµÇÊõ¥Êñ∞Êó•ÊôÇ']];
                const rows = [];
                
                Object.keys(state.posts).sort().forEach(date => {
                    state.posts[date].forEach(post => {
                        const platforms = (post.platforms || [post.platform]).map(p => {
                            const badges = {
                                x: 'ùïè',
                                instagram: 'Instagram',
                                line: 'LINE',
                                stumaga: '„Çπ„Çø„Éû„Ç¨',
                                youtube: 'YouTube'
                            };
                            return badges[p] || p;
                        }).join(', ');
                        
                        const checks = (post.checks || []).join(', ');
                        const links = (post.links || []).join('\n');
                        
                        rows.push([
                            date,
                            post.title || 'ÁÑ°È°å',
                            post.productNumber || '',
                            post.embedProduct ? '„ÅØ„ÅÑ' : '',
                            platforms,
                            post.text || '',
                            links,
                            post.remarks || '',
                            checks,
                            new Date().toLocaleString('ja-JP')
                        ]);
                    });
                });
        
                // „Ç∑„Éº„Éà„Çí„ÇØ„É™„Ç¢„Åó„Å¶„Éá„Éº„Çø„ÇíÊõ∏„ÅçËæº„Åø
                await gapi.client.sheets.spreadsheets.values.clear({
                    spreadsheetId: SPREADSHEET_ID,
                    range: '„Ç∑„Éº„Éà1!A1:Z'
                });
        
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: '„Ç∑„Éº„Éà1!A1',
                    valueInputOption: 'RAW',
                    resource: {
                        values: [...headers, ...rows]
                    }
                });
        
                // „Éò„ÉÉ„ÉÄ„ÉºË°å„ÇíÂ§™Â≠ó„Å´„Éï„Ç©„Éº„Éû„ÉÉ„Éà
                await gapi.client.sheets.spreadsheets.batchUpdate({
                    spreadsheetId: SPREADSHEET_ID,
                    resource: {
                        requests: [{
                            repeatCell: {
                                range: {
                                    sheetId: 0,
                                    startRowIndex: 0,
                                    endRowIndex: 1
                                },
                                cell: {
                                    userEnteredFormat: {
                                        textFormat: {
                                            bold: true
                                        }
                                    }
                                },
                                fields: 'userEnteredFormat.textFormat.bold'
                            }
                        }]
                    }
                });
        
                // „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„ÇíÈñã„Åè
                window.open(`https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}`, '_blank');
                showMessage('„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„Å´Êõ∏„ÅçËæº„Åø„Åæ„Åó„ÅüÔºÅ', 'success');
        
            } catch (error) {
                console.error('„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàÊõ∏„ÅçËæº„Åø„Ç®„É©„Éº:', error);
                showMessage('„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„Å∏„ÅÆÊõ∏„ÅçËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (error.result?.error?.message || error.message), 'error');
            }
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: ''
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                tryAutoSignIn();
            }
        }
        
        function addVideoPath() {
            if (!state.formData.videoPaths) {
                state.formData.videoPaths = [];
            }
            
            if (state.formData.videoPaths.length < 3) {
                state.formData.videoPaths.push({
                    name: `ÂãïÁîª ${state.formData.videoPaths.length + 1}`,
                    path: '',
                    uploadDate: new Date().toISOString()
                });
                render();
            } else {
                showMessage('ÂãïÁîª„Éë„Çπ„ÅØÊúÄÂ§ß3„Å§„Åæ„ÅßËøΩÂä†„Åß„Åç„Åæ„Åô', 'error');
            }
        }

        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                accessToken = gapi.client.getToken().access_token;
                state.isSignedIn = true;
                localStorage.setItem('google_access_token', JSON.stringify(gapi.client.getToken()));
                await loadFromDrive();
                render();
            };
        
            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        async function tryAutoSignIn() {
            const savedToken = localStorage.getItem('google_access_token');
            if (savedToken) {
                try {
                    const token = JSON.parse(savedToken);
                    gapi.client.setToken(token);
                    accessToken = token.access_token;
                    await gapi.client.drive.files.list({
                        pageSize: 1,
                        supportsAllDrives: true
                    });
                    state.isSignedIn = true;
                    await loadFromDrive();
                    render();
                } catch (error) {
                    console.log('Saved token expired');
                    localStorage.removeItem('google_access_token');
                    render();
                }
            } else {
                render();
            }
        }

        function handleSignOut() {
            gapi.client.setToken(null);
            localStorage.removeItem('google_access_token');
            accessToken = null;
            state.isSignedIn = false;
            state.posts = {};
            state.folderId = null;
            fileId = null;
            render();
            showMessage('„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü', 'success');
        }

        async function loadFromDrive() {
            try {
                let folderId = null;
                console.log('üîç ÊåáÂÆö„Éï„Ç©„É´„ÉÄÂÜÖ„ÇíÊ§úÁ¥¢ÈñãÂßã...');
                
                const folderResponse = await gapi.client.drive.files.list({
                    q: `name='${FOLDER_NAME}' and mimeType='application/vnd.google-apps.folder' and trashed=false and '${TARGET_FOLDER_ID}' in parents`,
                    fields: 'files(id, name)',
                    spaces: 'drive',
                    supportsAllDrives: true,
                    includeItemsFromAllDrives: true,
                    corpora: 'drive',
                    driveId: SHARED_DRIVE_ID
                });
        
                if (folderResponse.result.files && folderResponse.result.files.length > 0) {
                    folderId = folderResponse.result.files[0].id;
                    console.log('‚úÖ ÊåáÂÆö„Éï„Ç©„É´„ÉÄÂÜÖ„Åß„Éï„Ç©„É´„ÉÄÁô∫Ë¶ã');
                    showMessage('ÊåáÂÆö„Éï„Ç©„É´„ÉÄÂÜÖ„ÅÆ„Éï„Ç©„É´„ÉÄ„Å´Êé•Á∂ö„Åó„Åæ„Åó„Åü', 'success');
                } else {
                    console.log('‚ùå „Éï„Ç©„É´„ÉÄ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                    showMessage('„ÄåSNSÊäïÁ®øÁÆ°ÁêÜ„Äç„Éï„Ç©„É´„ÉÄ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇÁÆ°ÁêÜËÄÖ„Å´ÈÄ£Áµ°„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
                    state.isSignedIn = false;
                    handleSignOut();
                    return;
                }
        
                state.folderId = folderId;
                state.currentYear = state.currentDate.getFullYear(); // „Åì„ÅÆË°å„ÇíËøΩÂä†
                
                // ÁèæÂú®Ë°®Á§∫‰∏≠„ÅÆÂπ¥„ÅÆ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„ÇÄ
                await loadYearData();
                
                console.log('‚úÖ „Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÂÆå‰∫Ü');
            } catch (error) {
                console.error('‚ùå ÂÖ±Êúâ„Éâ„É©„Ç§„ÉñË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                showMessage('„Ç®„É©„Éº: ' + (error.result?.error?.message || error.message), 'error');
            }
        }
        
        async function loadYearData() {
            if (!state.folderId) return;
            
            const currentYear = state.currentDate.getFullYear();
            const fileName = `sns_calendar_data_${currentYear}.json`;
            
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name='${fileName}' and '${state.folderId}' in parents and trashed=false`,
                    fields: 'files(id, name)',
                    spaces: 'drive',
                    supportsAllDrives: true,
                    includeItemsFromAllDrives: true
                });
        
                const files = response.result.files;
                if (files && files.length > 0) {
                    fileId = files[0].id;
                    const fileContent = await gapi.client.drive.files.get({
                        fileId: fileId,
                        alt: 'media',
                        supportsAllDrives: true
                    });
        
                    if (fileContent.body) {
                        const data = JSON.parse(fileContent.body);
                        state.posts = data.posts || {};
                        state.lastUpdated = data.lastUpdated || null;
                        console.log(`‚úÖ ${currentYear}Âπ¥„ÅÆ„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÊàêÂäü`);
                        showMessage(`${currentYear}Âπ¥„ÅÆ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü`, 'success');
                    }
                } else {
                    // JSON„Éï„Ç°„Ç§„É´„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅØÁ©∫„ÅÆ„Éá„Éº„Çø„ÅßÈñãÂßã
                    console.log(`üìù ${currentYear}Âπ¥„ÅÆJSON„Éï„Ç°„Ç§„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ`);
                    state.posts = {};
                    state.lastUpdated = null;
                    fileId = null;
                    showMessage(`${currentYear}Âπ¥„ÅÆÊñ∞Ë¶è„Éá„Éº„Çø„Çí‰ΩúÊàê„Åó„Åæ„Åô`, 'success');
                }
            } catch (error) {
                console.error('Âπ¥„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                state.posts = {};
                state.lastUpdated = null;
                fileId = null;
            }
        }
        
        async function saveToDrive() {
            if (!state.isSignedIn || !state.folderId || state.isSaving) return;
            
            state.isSaving = true;
            render();
        
            try {
                const currentYear = state.currentDate.getFullYear();
                const fileName = `sns_calendar_data_${currentYear}.json`;
                
                const now = new Date().toISOString();
                const content = JSON.stringify({
                    posts: state.posts,
                    lastUpdated: now
                });
        
                const file = new Blob([content], { type: 'application/json' });
                const metadata = fileId ? {
                    name: fileName,
                    mimeType: 'application/json'
                } : {
                    name: fileName,
                    mimeType: 'application/json',
                    parents: [state.folderId]
                };
        
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', file);
        
                const url = fileId
                    ? `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart&supportsAllDrives=true`
                    : `https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&supportsAllDrives=true`;
        
                const response = await fetch(url, {
                    method: fileId ? 'PATCH' : 'POST',
                    headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
                    body: form
                });
        
                if (!response.ok) {
                    throw new Error(`‰øùÂ≠ò„Å´Â§±Êïó: ${response.status}`);
                }
        
                const result = await response.json();
                if (!fileId) {
                    fileId = result.id;
                }
        
                state.lastUpdated = now;
                showMessage('ÂÖ±Êúâ„Éâ„É©„Ç§„Éñ„Å´‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ', 'success');
        
            } catch (error) {
                console.error('‰øùÂ≠ò„Ç®„É©„Éº:', error);
                showMessage('‰øùÂ≠ò„Å´Â§±Êïó: ' + error.message, 'error');
            } finally {
                state.isSaving = false;
                render();
            }
        }

        async function updateSpreadsheetInBackground() {
            try {
                if (Object.keys(state.posts).length === 0) return;
        
                const headers = [['ÊäïÁ®øÊó•', '„Çø„Ç§„Éà„É´', 'ÊäïÁ®øÂÖà', 'ÊäïÁ®ø„ÉÜ„Ç≠„Çπ„Éà', '„ÉÅ„Çß„ÉÉ„ÇØÂÆå‰∫ÜËÄÖ', 'ÂãïÁîª„Éë„Çπ', 'ÊúÄÁµÇÊõ¥Êñ∞Êó•ÊôÇ']];
                const rows = [];
                
                Object.keys(state.posts).sort().forEach(date => {
                    state.posts[date].forEach(post => {
                        const platforms = (post.platforms || [post.platform]).map(p => {
                            const badges = { x: 'ùïè', instagram: 'Instagram', line: 'LINE', stumaga: '„Çπ„Çø„Éû„Ç¨' };
                            return badges[p] || p;
                        }).join(', ');
                        
                        const checks = (post.checks || []).join(', ');
                        const videoPaths = (post.videoPaths || []).map(v => v.path).filter(p => p).join(', ');
                        
                        rows.push([
                            date,
                            post.title || 'ÁÑ°È°å',
                            platforms,
                            post.text || '',
                            checks,
                            videoPaths,
                            new Date().toLocaleString('ja-JP')
                        ]);
                    });
                });
        
                await gapi.client.sheets.spreadsheets.values.clear({
                    spreadsheetId: SPREADSHEET_ID,
                    range: '„Ç∑„Éº„Éà1!A1:Z'
                });
        
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: '„Ç∑„Éº„Éà1!A1',
                    valueInputOption: 'RAW',
                    resource: { values: [...headers, ...rows] }
                });
        
                console.log('‚úÖ „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàËá™ÂãïÊõ¥Êñ∞ÂÆå‰∫Ü');
        
            } catch (error) {
                console.error('„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàËá™ÂãïÊõ¥Êñ∞„Ç®„É©„Éº:', error);
                // „Ç®„É©„Éº„ÅåÂá∫„Å¶„ÇÇ„É¶„Éº„Ç∂„Éº„Å´„ÅØÈÄöÁü•„Åó„Å™„ÅÑÔºà„Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„ÉâÂá¶ÁêÜ„ÅÆ„Åü„ÇÅÔºâ
            }
        }

        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white z-50 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            setTimeout(() => messageDiv.remove(), 3000);
        }

        function formatDateTime(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            return `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        }

        function formatDate(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        function getDaysInMonth(date) {
            const year = date.getFullYear();
            const month = date.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            return {
                daysInMonth: lastDay.getDate(),
                startingDayOfWeek: firstDay.getDay()
            };
        }

        async function savePost() {
            if (!state.formData.title && !state.formData.text) return;
         
            // ÁîªÂÉè„Å®ÂãïÁîª„ÇíÂàÜÈõ¢
            const imageFiles = state.formData.images.filter(file => file.type === 'image');
            const videoFiles = state.formData.images.filter(file => file.type === 'video');
         
            const newPost = {
                ...state.formData,
                id: state.editingPostId || Date.now(),
                images: imageFiles.map(file => ({
                    type: file.type,
                    name: file.name,
                    size: file.data ? file.data.length : 0,
                    data: file.data,
                    uploadDate: new Date().toISOString()
                })),
                checks: state.formData.checks || [],
                completedChecks: state.formData.completedChecks || [],
                productNumber: state.formData.productNumber || '',
                embedProduct: state.formData.embedProduct || false,
                remarks: state.formData.remarks || '',
                links: state.formData.links || []
            };
         
            const datePosts = state.posts[state.selectedDate] || [];
            if (state.editingPostId) {
                state.posts[state.selectedDate] = datePosts.map(p => p.id === state.editingPostId ? newPost : p);
            } else {
                state.posts[state.selectedDate] = [...datePosts, newPost];
                // Êñ∞Ë¶èÊäïÁ®ø„ÅÆÂ†¥Âêà„ÄÅ‰ΩúÊàê„Åó„ÅüÊäïÁ®ø„ÅÆID„ÇíË®≠ÂÆö
                state.editingPostId = newPost.id;
            }
         
            await saveToDrive();
            
            // Èñ≤Ë¶ß„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà
            state.viewMode = 'view';
            render();
        }
        
        function cancelEdit() {
            state.selectedDate = null;
            state.editingPostId = null;
            state.viewMode = 'edit';
            state.formData = {title: '', platforms: [], text: '', images: [], checks: [], completedChecks: []};
        }

        function confirmDelete(dateStr, postId) {
            if (confirm('Êú¨ÂΩì„Å´„Åì„ÅÆÊäïÁ®ø„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\n„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ')) {
                deletePost(dateStr, postId);
            }
        }

        async function deletePost(dateStr, postId) {
            const datePosts = state.posts[dateStr].filter(p => p.id !== postId);
            if (datePosts.length === 0) {
                delete state.posts[dateStr];
            } else {
                state.posts[dateStr] = datePosts;
            }
            await saveToDrive();
            cancelEdit();
            render();
        }

        function addLink() {
            if (!state.formData.links) {
                state.formData.links = [];
            }
            
            if (state.formData.links.length < 5) {
                state.formData.links.push('');
                render();
            } else {
                showMessage('„É™„É≥„ÇØÂÖà„ÅØÊúÄÂ§ß5„Å§„Åæ„ÅßËøΩÂä†„Åß„Åç„Åæ„Åô', 'error');
            }
        }
        
        function removeLink(index) {
            state.formData.links = state.formData.links.filter((_, i) => i !== index);
            render();
        }

        function openEditForm(day, postId = null) {
            const dateStr = formatDate(new Date(state.currentDate.getFullYear(), state.currentDate.getMonth(), day));
            state.selectedDate = dateStr;
        
            if (postId && state.posts[dateStr]) {
                const post = state.posts[dateStr].find(p => p.id === postId);
                if (post) {
                    state.formData = { ...post };
                    if (!state.formData.platforms && state.formData.platform) {
                        state.formData.platforms = [state.formData.platform];
                    }
                    if (!state.formData.checks) {
                        state.formData.checks = [];
                    }
                    if (!state.formData.completedChecks) {
                        state.formData.completedChecks = [];
                    }
                    if (!state.formData.productNumber) {
                        state.formData.productNumber = '';
                    }
                    if (!state.formData.embedProduct) {
                        state.formData.embedProduct = false;
                    }
                    if (!state.formData.remarks) {
                        state.formData.remarks = '';
                    }
                    if (!state.formData.links) {
                        state.formData.links = [];
                    }
                    state.editingPostId = postId;
                    state.viewMode = 'view';
                }
            } else {
                state.formData = {
                    title: '', 
                    platforms: [], 
                    text: '', 
                    images: [], 
                    checks: [],
                    productNumber: '',
                    embedProduct: false,
                    remarks: '',
                    links: ['']  // Á©∫„ÅÆ„É™„É≥„ÇØ„Çí1„Å§ËøΩÂä†
                };
                state.editingPostId = null;
                state.viewMode = 'edit';
            }
            render();
        }

        function switchToEditMode() {
            state.viewMode = 'edit';
            render();
        }

        function togglePlatform(platform) {
            if (state.formData.platforms.includes(platform)) {
                state.formData.platforms = state.formData.platforms.filter(p => p !== platform);
            } else {
                state.formData.platforms.push(platform);
            }
            render();
        }

        function handleImageSelect(e) {
            const files = Array.from(e.target.files);
            console.log('ÈÅ∏Êäû„Åï„Çå„Åü„Éï„Ç°„Ç§„É´„ÅÆÊï∞:', files.length);
            
            if (files.length === 0) return;
        
            const remainingSlots = 20 - state.formData.images.length; // 5„Åã„Çâ20„Å´Â§âÊõ¥
            const filesToProcess = files.slice(0, remainingSlots);
            let processed = 0;
            const newFiles = [];
        
            filesToProcess.forEach(file => {
                console.log('Âá¶ÁêÜ„Åô„Çã„Éï„Ç°„Ç§„É´:', file.name, '„Çø„Ç§„Éó:', file.type, '„Çµ„Ç§„Ç∫:', file.size);
        
                // 100MB„ÅÆ„Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫Âà∂Èôê„ÇíËøΩÂä†
                if (file.size > 100 * 1024 * 1024) {
                    showMessage(`„Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÅåÂ§ß„Åç„Åô„Åé„Åæ„Åô: ${file.name} (100MB‰ª•‰∏ã„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ)`, 'error');
                    return;
                }
        
                const reader = new FileReader();
                reader.onload = (event) => {
                    console.log('„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', file.name);
                    console.log('„Éá„Éº„ÇøÈï∑:', event.target.result ? event.target.result.length : '„Éá„Éº„Çø„Å™„Åó');
                    
                    newFiles.push({
                        type: file.type.startsWith('image/') ? 'image' : 'video',
                        data: event.target.result,
                        name: file.name,
                        originalFile: file
                    });
                    processed++;
                    if (processed === filesToProcess.length) {
                        state.formData.images = [...state.formData.images, ...newFiles];
                        console.log('ËøΩÂä†Âæå„ÅÆÁîªÂÉèÊï∞:', state.formData.images.length);
                        render();
                    }
                };
                reader.readAsDataURL(file);
            });
        }
        
        // removeImageÈñ¢Êï∞„Çí‰øÆÊ≠£
        function removeImage(index) {
            state.formData.images = state.formData.images.filter((_, i) => i !== index);
            render();
        }
        
        // downloadImageÈñ¢Êï∞„Çí‰øÆÊ≠£„Åó„ÄÅÂãïÁîª„ÇÇ„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÂèØËÉΩ„Å´
        function downloadImage(fileData, title, index) {
            if (!fileData || !fileData.data) {
                console.error('„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åô„Çã„Éï„Ç°„Ç§„É´„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', fileData);
                return;
            }
            const link = document.createElement('a');
            link.href = fileData.data;
            link.download = `${title || 'media'}_${index + 1}${getFileExtension(fileData)}`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function getFileExtension(file) {
            if (file.type === 'image') {
                const match = file.data.match(/^data:image\/([a-zA-Z0-9]+);/);
                return match ? `.${match[1]}` : '.png';
            }
            if (file.type === 'video') {
                const match = file.data.match(/^data:video\/([a-zA-Z0-9]+);/);
                return match ? `.${match[1]}` : '.mp4';
            }
            return '';
        }

        function goToToday() {
            state.currentDate = new Date();
            render();
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showMessage('„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ', 'success');
            });
        }

        function toggleCheckCompletion(checkText) {
            if (!state.formData.completedChecks) {
                state.formData.completedChecks = [];
            }
            
            if (state.formData.completedChecks.includes(checkText)) {
                state.formData.completedChecks = state.formData.completedChecks.filter(c => c !== checkText);
            } else {
                state.formData.completedChecks.push(checkText);
            }
            
            // Ëá™Âãï‰øùÂ≠ò
            saveToDrive();
            render();
        }

        function addViewCheck(inputId) {
            const input = document.getElementById(inputId);
            const value = input.value.trim();
            
            if (!state.formData.checks) {
                state.formData.checks = [];
            }
            
            if (value && !state.formData.checks.includes(value)) {
                state.formData.checks.push(value);
                input.value = '';
                saveToDrive(); // Ëá™Âãï‰øùÂ≠ò
                render();
            }
        }
        
        function removeViewCheck(index) {
            state.formData.checks = state.formData.checks.filter((_, i) => i !== index);
            saveToDrive(); // Ëá™Âãï‰øùÂ≠ò
            render();
        }

        function addCheckPerson() {
            const input = document.getElementById('checkPersonInput');
            const value = input.value.trim();
            
            if (!state.formData.checks) {
                state.formData.checks = [];
            }
            
            if (value && !state.formData.checks.includes(value)) {
                state.formData.checks.push(value);
                input.value = '';
                saveToDrive(); // Ëá™Âãï‰øùÂ≠ò
                render();
            }
        }
        
        function removeCheckPerson(index) {
            state.formData.checks = state.formData.checks.filter((_, i) => i !== index);
            saveToDrive(); // Ëá™Âãï‰øùÂ≠ò
            render();
        }

      function render() {
            const { daysInMonth, startingDayOfWeek } = getDaysInMonth(state.currentDate);
            const monthName = state.currentDate.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long' });
            const today = new Date();
            const isCurrentMonth = state.currentDate.getMonth() === today.getMonth() && state.currentDate.getFullYear() === today.getFullYear();

            const platformBadges = {
                x: { label: 'ùïè', color: 'bg-black' },
                instagram: { label: 'IG', color: 'bg-gradient-to-r from-purple-500 to-pink-500' },
                line: { label: 'L', color: 'bg-green-500' },
                stumaga: { label: 'M', color: 'bg-orange-500' },
                youtube: { label: 'YT', color: 'bg-red-600' }
            };

            let calendarHTML = '';
            const weekDays = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
            weekDays.forEach((day, index) => {
                const dayColor = index === 0 ? 'text-red-600' : (index === 6 ? 'text-blue-600' : 'text-gray-600');
                calendarHTML += `<div class="text-center font-bold ${dayColor} py-2">${day}</div>`;
            });
            
            for (let i = 0; i < startingDayOfWeek; i++) {
                calendarHTML += '<div class="p-2"></div>';
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = formatDate(new Date(state.currentDate.getFullYear(), state.currentDate.getMonth(), day));
                const dayPosts = state.posts[dateStr] || [];
                const isToday = isCurrentMonth && day === today.getDate();
                
                // ÊõúÊó•„ÇíË®àÁÆóÔºà0=Êó•Êõú, 6=ÂúüÊõúÔºâ
                const currentDayOfWeek = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth(), day).getDay();
                const dayColor = currentDayOfWeek === 0 ? 'text-red-600' : (currentDayOfWeek === 6 ? 'text-blue-600' : 'text-gray-700');
                const todayBorder = isToday ? 'border-blue-400 bg-blue-50' : 'border-gray-200';
            
                calendarHTML += `
                    <div class="p-2 min-h-24 border rounded-lg transition-all bg-white ${todayBorder} hover:border-blue-200">
                        <div class="font-semibold mb-2 ${dayColor}">${day}${isToday ? '<span class="ml-1 text-xs">‚óè</span>' : ''}</div>
                        <div class="space-y-1">
                            ${dayPosts.map(post => {
                                const platforms = post.platforms || [post.platform];
                                return `<div onclick="openEditForm(${day}, ${post.id})" class="text-xs bg-white p-2 rounded border border-gray-200 hover:border-blue-400 cursor-pointer transition-all hover:shadow-sm">
                                    <div class="flex items-center gap-1 flex-wrap">
                                        ${platforms.map(p => {
                                            const badge = platformBadges[p];
                                            return `<span class="${badge.color} text-white px-1 py-0.5 rounded text-[9px]">${badge.label}</span>`;
                                        }).join('')}
                                        <span class="font-semibold text-gray-700 truncate text-[11px]">${post.title || 'ÁÑ°È°å'}</span>
                                    </div>
                                </div>`;
                            }).join('')}
                            <button onclick="openEditForm(${day})" class="w-full text-[11px] text-gray-400 hover:text-gray-600 py-1 flex items-center justify-center gap-1 hover:bg-gray-50 rounded transition-colors">
                                <span>+</span> ËøΩÂä†
                            </button>
                        </div>
                    </div>
                `;
            }

            let editFormHTML = '';
            if (state.selectedDate) {
                const platformButtons = [
                    {value: 'x', label: 'ùïè', color: 'bg-black'},
                    {value: 'instagram', label: 'Instagram', color: 'bg-gradient-to-r from-purple-500 to-pink-500'},
                    {value: 'line', label: 'LINE', color: 'bg-green-500'},
                    {value: 'stumaga', label: '„Çπ„Çø„Éû„Ç¨', color: 'bg-orange-500'}
                ];

                if (state.viewMode === 'view') {
                    const platforms = state.formData.platforms || [state.formData.platform];
                    editFormHTML = `<div class="bg-white rounded-2xl shadow-xl p-4">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-3">
                                <div class="text-2xl font-bold text-gray-800">${state.selectedDate}</div>
                                <div class="flex gap-1 flex-wrap">
                                    ${platforms.map(p => {
                                        const badge = platformBadges[p];
                                        return `<span class="${badge.color} text-white px-2 py-1 rounded text-sm">${badge.label}</span>`;
                                    }).join('')}
                                </div>
                            </div>
                            <button onclick="cancelEdit(); render();" class="p-1 hover:bg-gray-100 rounded-lg transition-colors">
                                <span class="text-xl">√ó</span>
                            </button>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <div class="font-semibold text-gray-800 text-lg">${state.formData.title || 'ÁÑ°È°å'}</div>
                            </div>
                            ${state.formData.productNumber ? `
                                <div>
                                    <div class="flex items-center gap-2">
                                        <div class="text-sm flex-1">
                                            <span class="font-semibold">ÂïÜÂìÅÁï™Âè∑:</span> 
                                            <a href="https://winds-score.com/products/${state.formData.productNumber}" target="_blank" class="text-blue-600 hover:text-blue-800 underline">${state.formData.productNumber}</a>
                                            ${state.formData.embedProduct ? '<span class="ml-2 bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-xs">ÂãïÁîªÂüãËæº</span>' : ''}
                                        </div>
                                        <button onclick="copyProductUrl('${state.formData.productNumber}')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1.5 rounded-lg transition-colors text-xs whitespace-nowrap">
                                            üîó ÂïÜÂìÅURL„Ç≥„Éî„Éº
                                        </button>
                                        ${state.formData.embedProduct ? `
                                            <button onclick="findAndDownloadVideo('${state.formData.productNumber}')" title="[Google Drive > ÂÖ±Êúâ„Éâ„É©„Ç§„Éñ > 07_Â∫ÉÂ†± > YouTube > „ÉÑ„Ç§„Éº„ÉàÁî®ÂãïÁîª > ALL] ÂÜÖ„ÅÆ&quot;${state.formData.productNumber}.mp4&quot;„ÇíÊé¢„Åó„Å¶„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åô" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-1.5 rounded-lg transition-colors text-xs whitespace-nowrap">
                                                ‚¨áÔ∏è ÂãïÁîªDL
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            ` : ''}
                            <div>
                                <div class="bg-gray-50 p-2 rounded-lg rounded-b-none border border-gray-200 border-b-0 whitespace-pre-wrap text-sm max-h-32 overflow-y-auto leading-relaxed scrollbar-thin" style="line-height: 1.6; background: linear-gradient(white 30%, rgba(255,255,255,0)), linear-gradient(rgba(255,255,255,0), white 70%) 0 100%, radial-gradient(farthest-side at 50% 0, rgba(0,0,0,.2), rgba(0,0,0,0)), radial-gradient(farthest-side at 50% 100%, rgba(0,0,0,.2), rgba(0,0,0,0)) 0 100%; background-repeat: no-repeat; background-color: rgb(249 250 251); background-size: 100% 40px, 100% 40px, 100% 14px, 100% 14px; background-attachment: local, local, scroll, scroll;">${state.formData.text || '„ÉÜ„Ç≠„Çπ„Éà„Å™„Åó'}</div>
                                <button onclick="copyToClipboard(\`${state.formData.text}\`)" class="w-full flex items-center justify-center gap-2 bg-gray-200 text-gray-600 py-1.5 rounded-lg rounded-t-none hover:bg-gray-300 transition-colors text-xs border border-gray-200 border-t-0">
                                    üìã „ÉÜ„Ç≠„Çπ„Éà„Çí„Ç≥„Éî„Éº
                                </button>
                            </div>
                            ${state.formData.links && state.formData.links.length > 0 ? `
                                <div>
                                    <div class="space-y-1">
                                        ${state.formData.links.map((link, index) => `
                                            <div class="bg-blue-50 p-2 rounded-lg border border-blue-200 flex items-center gap-2">
                                                <a href="${link}" target="_blank" class="text-blue-600 hover:text-blue-800 text-xs break-all flex-1">üîó ${link}</a>
                                                <button onclick="copyToClipboard(\`${link}\`)" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs whitespace-nowrap">
                                                    „Ç≥„Éî„Éº
                                                </button>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            ${state.formData.remarks ? `
                                <div>
                                    <div class="bg-yellow-50 p-2 rounded-lg border border-yellow-200 text-sm whitespace-pre-wrap">${state.formData.remarks}</div>
                                </div>
                            ` : ''}
                            ${state.formData.images && state.formData.images.length > 0 ? `
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">„É°„Éá„Ç£„Ç¢Ôºà${state.formData.images.length}ÂÄãÔºâ</div>
                                    <div class="grid grid-cols-3 gap-2">
                                        ${state.formData.images.map((file, index) => `
                                            <div class="relative group">
                                                ${file.type === 'image' ? `
                                                    <img src="${file.data}" alt="ÁîªÂÉè ${index + 1}" class="w-full h-24 object-cover rounded-lg border border-gray-200">
                                                ` : `
                                                    <video src="${file.data}" class="w-full h-24 object-cover rounded-lg border border-gray-200" controls></video>
                                                `}
                                                <button onclick="downloadImage({data: state.formData.images[${index}].data, type: state.formData.images[${index}].type}, \`${state.formData.title || 'media'}\`, ${index})" class="absolute bottom-1 right-1 bg-blue-500 text-white px-2 py-0.5 rounded-lg hover:bg-blue-600 transition-colors shadow-lg text-xs">
                                                    ‚¨á
                                                </button>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            <div>
                                <div class="flex gap-2 mb-2">
                                    <input type="text" id="checkPersonInput" placeholder="„ÉÅ„Çß„ÉÉ„ÇØÂÆå‰∫Ü„Åó„Åü‰∫∫„ÅÆÂêçÂâç„ÇíÂÖ•Âäõ" class="flex-1 px-3 py-1.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" onkeypress="if(event.key==='Enter'){addCheckPerson(); event.preventDefault();}">
                                    <button onclick="addCheckPerson()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1.5 rounded-lg transition-colors text-xs">
                                        ËøΩÂä†
                                    </button>
                                </div>
                                ${state.formData.checks && state.formData.checks.length > 0 ? `
                                    <div class="flex gap-1 flex-wrap">
                                        ${state.formData.checks.map((person, index) => `
                                            <span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs inline-flex items-center gap-1 border border-green-300">
                                                ‚úì ${person}
                                                <button onclick="removeCheckPerson(${index})" class="text-red-500 hover:text-red-700 font-bold">√ó</button>
                                            </span>
                                        `).join('')}
                                    </div>
                                ` : '<div class="text-xs text-gray-400">„Åæ„Å†„ÉÅ„Çß„ÉÉ„ÇØÂÆå‰∫ÜËÄÖ„ÅØ„ÅÑ„Åæ„Åõ„Çì</div>'}
                            </div>
                            <div class="flex gap-2 pt-3 border-t">
                                <button onclick="switchToEditMode()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg font-semibold transition-colors shadow-md text-sm">
                                    ‚úèÔ∏è Á∑®ÈõÜ
                                </button>
                                <button onclick="confirmDelete('${state.selectedDate}', ${state.editingPostId})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg font-semibold transition-colors shadow-md text-sm">
                                    üóë
                                </button>
                            </div>
                        </div>
                    </div>`;
                } else {
                    editFormHTML = `<div class="bg-blue-50 rounded-2xl shadow-xl p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-bold text-gray-800">${state.editingPostId ? 'ÊäïÁ®ø„ÇíÁ∑®ÈõÜ' : 'Êñ∞Ë¶èÊäïÁ®ø'} - ${state.selectedDate}</h3>
                            <button onclick="cancelEdit(); render();" class="p-1 hover:bg-gray-100 rounded-lg transition-colors">
                                <span class="text-xl">√ó</span>
                            </button>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-xs font-semibold text-gray-700 mb-1">ÊäïÁ®ø„Çø„Ç§„Éà„É´</label>
                                <input type="text" value="${state.formData.title}" onchange="state.formData.title = this.value" placeholder="‰æã: Êñ∞ÂïÜÂìÅÂëäÁü•" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-700 mb-1">ÂïÜÂìÅÁï™Âè∑</label>
                                <div class="flex gap-2 items-center">
                                    <input type="text" value="${state.formData.productNumber || ''}" onchange="state.formData.productNumber = this.value" placeholder="‰æã: ABC-12345" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                    <label class="flex items-center gap-1 text-sm whitespace-nowrap">
                                        <input type="checkbox" ${state.formData.embedProduct ? 'checked' : ''} onchange="state.formData.embedProduct = this.checked" class="rounded">
                                        ÂãïÁîªÂüãËæº
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-700 mb-1">ÊäïÁ®øÂÖàSNSÔºàË§áÊï∞ÈÅ∏ÊäûÂèØÔºâ</label>
                                <div class="flex gap-2 flex-wrap">
                                    ${[
                                        {value: 'x', label: 'ùïè', color: 'bg-black'},
                                        {value: 'instagram', label: 'IG', color: 'bg-gradient-to-r from-purple-500 to-pink-500'},
                                        {value: 'line', label: 'LINE', color: 'bg-green-500'},
                                        {value: 'stumaga', label: '„Çπ„Çø„Éû„Ç¨', color: 'bg-orange-500'},
                                        {value: 'youtube', label: 'YT', color: 'bg-red-600'}
                                    ].map(platform => `
                                        <button onclick="togglePlatform('${platform.value}')" class="py-1.5 px-3 rounded-lg font-semibold text-white transition-all text-xs ${state.formData.platforms.includes(platform.value) ? `${platform.color} ring-2 ring-offset-2 ring-blue-300` : 'bg-gray-300 hover:bg-gray-400'}">
                                            ${platform.label}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-700 mb-1">ÊäïÁ®ø„ÉÜ„Ç≠„Çπ„Éà</label>
                                <textarea onchange="state.formData.text = this.value" placeholder="ÊäïÁ®ø„Åô„ÇãÊñáÁ´†„ÇíÂÖ•Âäõ..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" rows="4">${state.formData.text}</textarea>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-700 mb-1">„É™„É≥„ÇØÂÖàÔºàÊúÄÂ§ß5„Å§Ôºâ</label>
                                ${state.formData.links && state.formData.links.length > 0 ? state.formData.links.map((link, index) => `
                                    <div class="flex gap-2 mb-2">
                                        <input 
                                            type="url" 
                                            value="${link}" 
                                            onchange="state.formData.links[${index}] = this.value" 
                                            placeholder="https://example.com" 
                                            class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                        >
                                        ${state.formData.links.length > 1 ? `
                                            <button onclick="removeLink(${index})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg transition-colors text-xs">
                                                √ó
                                            </button>
                                        ` : ''}
                                        ${index === state.formData.links.length - 1 && state.formData.links.length < 5 ? `
                                            <button onclick="addLink()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1.5 rounded-lg transition-colors text-xs whitespace-nowrap">
                                                + „É™„É≥„ÇØ„ÇíËøΩÂä†
                                            </button>
                                        ` : ''}
                                    </div>
                                `).join('') : `
                                    <div class="flex gap-2 mb-2">
                                        <input 
                                            type="url" 
                                            value="" 
                                            onchange="if(!state.formData.links) state.formData.links = []; state.formData.links[0] = this.value" 
                                            placeholder="https://example.com" 
                                            class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                        >
                                        <button onclick="addLink()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1.5 rounded-lg transition-colors text-xs whitespace-nowrap">
                                            + „É™„É≥„ÇØ„ÇíËøΩÂä†
                                        </button>
                                    </div>
                                `}
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-700 mb-1">ÂÇôËÄÉ</label>
                                <textarea onchange="state.formData.remarks = this.value" placeholder="„É°„É¢„ÇÑÂÇôËÄÉ„ÇíÂÖ•Âäõ..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" rows="2">${state.formData.remarks || ''}</textarea>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-700 mb-1">ÁîªÂÉèÔºàÊúÄÂ§ß20ÊûöÔºâ<span class="ml-2 text-xs text-gray-500">${state.formData.images.length} / 20</span></label>
                                <div class="border-2 border-dashed rounded-lg p-3 text-center border-gray-300 hover:border-blue-400">
                                    ${state.formData.images.length > 0 ? `
                                        <div>
                                            <div class="grid grid-cols-3 gap-2 mb-2">
                                                ${state.formData.images.map((image, index) => `
                                                    <div class="relative group">
                                                        ${image.type === 'image' ? `
                                                            <img src="${image.data}" alt="ÁîªÂÉè ${index + 1}" class="w-full h-20 object-cover rounded-lg">
                                                        ` : `
                                                            <video src="${image.data}" class="w-full h-20 object-cover rounded-lg" controls></video>
                                                        `}
                                                        <button onclick="removeImage(${index})" class="absolute top-1 right-1 bg-red-500 text-white p-1 rounded-full hover:bg-red-600 transition-colors shadow-lg opacity-0 group-hover:opacity-100 text-xs leading-none w-5 h-5 flex items-center justify-center">
                                                            √ó
                                                        </button>
                                                    </div>
                                                `).join('')}
                                            </div>
                                            ${state.formData.images.length < 20 ? `
                                                <label class="inline-block bg-blue-500 hover:bg-blue-600 text-white px-3 py-1.5 rounded-lg cursor-pointer transition-colors text-xs">
                                                    + „Åï„Çâ„Å´ËøΩÂä†
                                                    <input type="file" accept="image/*,video/*" multiple onchange="handleImageSelect(event)" class="hidden">
                                                </label>
                                            ` : ''}
                                        </div>
                                    ` : `
                                        <div>
                                            <label class="inline-block bg-blue-500 hover:bg-blue-600 text-white px-3 py-1.5 rounded-lg cursor-pointer transition-colors text-xs">
                                                üì∏ ÁîªÂÉè„ÇíÈÅ∏Êäû
                                                <input type="file" accept="image/*,video/*" multiple onchange="handleImageSelect(event)" class="hidden">
                                            </label>
                                        </div>
                                    `}
                                </div>
                            </div>
                            <div class="flex gap-2 pt-2">
                                <button onclick="savePost()" ${state.isSaving ? 'disabled' : ''} class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg font-semibold transition-colors text-sm ${state.isSaving ? 'opacity-50 cursor-not-allowed' : ''}">
                                    ${state.isSaving ? '‚è≥ ‰øùÂ≠ò‰∏≠...' : (state.editingPostId ? 'Êõ¥Êñ∞' : '‰øùÂ≠ò')}
                                </button>
                            </div>
                        </div>
                    </div>`;
                }
            }

            document.getElementById('app').innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-3">
                        <h1 class="text-3xl font-bold text-gray-800">üì± SNSÊäïÁ®ø„Ç´„É¨„É≥„ÉÄ„Éº</h1>
                        <button onclick="exportToSpreadsheet()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg transition-colors text-xs flex items-center gap-1">
                            üìä „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàÂêåÊúü
                        </button>
                    </div>
                    <div class="flex flex-col items-end gap-1">
                        ${state.isSignedIn ? `
                            <div class="flex items-center gap-2">
                                <div class="inline-flex items-center gap-2 bg-green-100 text-green-700 px-3 py-1 rounded-lg text-xs">
                                    ‚úÖ ÂÖ±Êúâ„Éâ„É©„Ç§„ÉñÊé•Á∂öÊ∏à
                                </div>
                                <button onclick="handleSignOut()" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded-lg text-xs transition-colors">
                                    „É≠„Ç∞„Ç¢„Ç¶„Éà
                                </button>
                            </div>
                        ` : `
                            <button onclick="handleAuthClick()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-semibold transition-colors shadow-lg text-sm">
                                üîó Google Drive„Å´Êé•Á∂ö
                            </button>
                        `}
                        <div class="text-xs text-gray-400">
                            ${state.lastUpdated ? `ÊúÄÁµÇÊõ¥Êñ∞: ${formatDateTime(state.lastUpdated)}„ÄÄ` : ''}„Ç¢„Éó„É™Êõ¥Êñ∞: ${APP_VERSION}
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <div class="lg:col-span-2">
                        <div class="bg-white rounded-2xl shadow-xl p-6">
                            <div class="flex items-center justify-between mb-6">
                                <button onclick="changeMonth(-1)" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                                    ‚óÄ
                                </button>
                                <div class="flex items-center gap-3">
                                    <h2 class="text-2xl font-bold text-gray-800">${monthName}</h2>
                                    <button onclick="goToToday()" class="px-3 py-1 text-sm bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors">
                                        Êú¨Êó•
                                    </button>
                                </div>
                                <button onclick="changeMonth(1)" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                                    ‚ñ∂
                                </button>
                            </div>
                            <div class="grid grid-cols-7 gap-2">
                                ${calendarHTML}
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-1">
                        ${editFormHTML || '<div class="bg-gray-50 rounded-2xl shadow-xl p-6 text-center text-gray-500">„Ç´„É¨„É≥„ÉÄ„Éº„Åã„ÇâÊó•‰ªò„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>'}
                    </div>
                </div>
            `;
        }

        window.addEventListener('load', () => {
            gapiLoaded();
            gisLoaded();
        });
    </script>
</body>
</html>
