<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SNSæŠ•ç¨¿ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç®¡ç†</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ğŸ“±</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
</head>
<body class="bg-gradient-to-br from-purple-50 to-blue-50 min-h-screen">
    <div id="app" class="max-w-[1920px] mx-auto p-6"></div>

    <script>
        const CLIENT_ID = '417822818519-8imosvo7c9e2gem7cp0rse0vm8vrjlou.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/spreadsheets';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const FOLDER_NAME = 'SNSæŠ•ç¨¿ç®¡ç†';
        const SHARED_DRIVE_ID = '0AHJk3pS7tSEgUk9PVA';
        const TARGET_FOLDER_ID = '1I23qmcfZ_x8c15NtW54vjhKQb7waJi-E';
        const SPREADSHEET_ID = '1QOwpEbvttoE51vjBNy79IEwPEUqAPBWMXYTB9on_NIw';
        const VIDEO_FOLDER_ID = '1085XOWlyw--O2ITRwS2kum2dXKZ8s87c';
        const INSTAGRAM_APP_ID = '3688415181455366';
        const INSTAGRAM_APP_SECRET = '70c616003680a73af282234235c3b82d';
        const INSTAGRAM_ACCOUNT_ID = '17841404355630376';
        const INSTAGRAM_ACCESS_TOKEN = 'EAAQVzgup6V8BP3Y4hwDOVEm2hM0bORhqiZAJN6u4RQ169IfkJ1AoNtOVFK8JhpDsgyLKrvIqfi8F50OFGPUDnayrHbDDnSmZCgS51MV9hLWRjiJuyjIW9EjZCO3XFI4GtZCm5kZAj3I7PrY4BZCnbD1udd9vBcfyyrGgHh45nVyCLVAZBv0Dx5BXirqUW6PiI6YCVvKwFSjOECBs2gYwRVfyKIUjll4FJ7yUPZAsIqZCZB4q1ztwc0HHztqBZC6teB0pAZDZD';
        const APP_VERSION = '2025/01/22 13:30';

        let gapiInited = false;
        let gisInited = false;
        let tokenClient;
        let accessToken = null;
        let fileId = null;

        let state = {
            currentDate: new Date(),
            posts: {},
            selectedDate: null,
            editingPostId: null,
            viewMode: 'edit',
            isSignedIn: false,
            isSaving: false,
            folderId: null,
            lastUpdated: null,
            currentYear: new Date().getFullYear(),
            userName: null,
            formData: {title: '', platforms: [], text: '', images: [], checks: [], completedChecks: []}
        };

        async function findAndDownloadVideo(productNumber) {
            if (!state.isSignedIn || !productNumber) {
                showMessage('å•†å“ç•ªå·ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }
        
            try {
                showMessage('å‹•ç”»ã‚’æ¤œç´¢ä¸­...', 'success');
        
                // å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
                const response = await gapi.client.drive.files.list({
                    q: `name='${productNumber}.mp4' and '${VIDEO_FOLDER_ID}' in parents and trashed=false`,
                    fields: 'files(id, name, webContentLink)',
                    spaces: 'drive',
                    supportsAllDrives: true,
                    includeItemsFromAllDrives: true
                });
        
                if (response.result.files && response.result.files.length > 0) {
                    const fileId = response.result.files[0].id;
                    const downloadUrl = `https://drive.google.com/uc?export=download&id=${fileId}`;
                    
                    // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹
                    window.open(downloadUrl, '_blank');
                    showMessage('å‹•ç”»ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã—ãŸ', 'success');
                } else {
                    showMessage(`å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${productNumber}.mp4ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ`, 'error');
                }
            } catch (error) {
                console.error('InstagramæŠ•ç¨¿ã‚¨ãƒ©ãƒ¼:', error);
                console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', JSON.stringify(error, null, 2));
                if (error.result) {
                    console.error('API ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', error.result);
                }
                showMessage(`âŒ InstagramæŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message || error.toString() || 'Unknown error'}`, 'error');
            }
        }

        async function changeMonth(offset) {
            const oldYear = state.currentDate.getFullYear();
            state.currentDate.setMonth(state.currentDate.getMonth() + offset);
            const newYear = state.currentDate.getFullYear();
            
            // å¹´ãŒå¤‰ã‚ã£ãŸå ´åˆã®ã¿å†èª­ã¿è¾¼ã¿
            if (oldYear !== newYear && state.currentYear !== newYear) {
                state.currentYear = newYear;
                await loadYearData();
            }
            
            render();
        }
        
        function copyProductUrl(productNumber) {
            const url = `https://winds-score.com/products/${productNumber}`;
            copyToClipboard(url);
        }

        function getCurrentYearFileName() {
            const currentYear = new Date().getFullYear();
            return `sns_calendar_data_${currentYear}.json`;
        }

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                discoveryDocs: [
                    DISCOVERY_DOC,
                    'https://sheets.googleapis.com/$discovery/rest?version=v4'
                ]
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        async function uploadMediaToDrive(file) {
            if (!state.isSignedIn) return null;
        
            try {
                const metadata = {
                    name: file.name,
                    parents: [VIDEO_FOLDER_ID] // å‹•ç”»ç”¨ã®ãƒ•ã‚©ãƒ«ãƒ€IDã‚’å®šç¾©
                };
        
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', file);
        
                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&supportsAllDrives=true', {
                    method: 'POST',
                    headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
                    body: form
                });
        
                if (!response.ok) {
                    throw new Error(`ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—: ${response.status}`);
                }
        
                const result = await response.json();
                return result.id; // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ID
            } catch (error) {
                console.error('ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('ãƒ¡ãƒ‡ã‚£ã‚¢ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—', 'error');
                return null;
            }
        }

        async function exportToSpreadsheet() {
            if (!state.isSignedIn) {
                showMessage('å…ˆã«Google Driveã«æ¥ç¶šã—ã¦ãã ã•ã„', 'error');
                return;
            }
        
            if (Object.keys(state.posts).length === 0) {
                showMessage('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }
        
            try {
                showMessage('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«æ›¸ãè¾¼ã¿ä¸­...', 'success');
        
                // ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
                const headers = [['æŠ•ç¨¿æ—¥', 'ã‚¿ã‚¤ãƒˆãƒ«', 'å•†å“ç•ªå·', 'å‹•ç”»åŸ‹è¾¼', 'æŠ•ç¨¿å…ˆ', 'æŠ•ç¨¿ãƒ†ã‚­ã‚¹ãƒˆ', 'ãƒªãƒ³ã‚¯å…ˆ', 'å‚™è€ƒ', 'ãƒã‚§ãƒƒã‚¯å®Œäº†è€…', 'æœ€çµ‚æ›´æ–°æ—¥æ™‚']];
                const rows = [];
                
                Object.keys(state.posts).sort().forEach(date => {
                    state.posts[date].forEach(post => {
                        const platforms = (post.platforms || [post.platform]).map(p => {
                            const badges = {
                                x: 'ğ•',
                                instagram: 'Instagram',
                                line: 'LINE',
                                stumaga: 'ã‚¹ã‚¿ãƒã‚¬',
                                youtube: 'YouTube'
                            };
                            return badges[p] || p;
                        }).join(', ');
                        
                        const checks = (post.checks || []).join(', ');
                        const links = (post.links || []).join('\n');
                        
                        rows.push([
                            date,
                            post.title || 'ç„¡é¡Œ',
                            post.productNumber || '',
                            post.embedProduct ? 'ã¯ã„' : '',
                            platforms,
                            post.text || '',
                            links,
                            post.remarks || '',
                            checks,
                            new Date().toLocaleString('ja-JP')
                        ]);
                    });
                });
        
                // ã‚·ãƒ¼ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã¿
                await gapi.client.sheets.spreadsheets.values.clear({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'ã‚·ãƒ¼ãƒˆ1!A1:Z'
                });
        
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'ã‚·ãƒ¼ãƒˆ1!A1',
                    valueInputOption: 'RAW',
                    resource: {
                        values: [...headers, ...rows]
                    }
                });
        
                // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’å¤ªå­—ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                await gapi.client.sheets.spreadsheets.batchUpdate({
                    spreadsheetId: SPREADSHEET_ID,
                    resource: {
                        requests: [{
                            repeatCell: {
                                range: {
                                    sheetId: 0,
                                    startRowIndex: 0,
                                    endRowIndex: 1
                                },
                                cell: {
                                    userEnteredFormat: {
                                        textFormat: {
                                            bold: true
                                        }
                                    }
                                },
                                fields: 'userEnteredFormat.textFormat.bold'
                            }
                        }]
                    }
                });
        
                // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã
                window.open(`https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}`, '_blank');
                showMessage('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«æ›¸ãè¾¼ã¿ã¾ã—ãŸï¼', 'success');
        
            } catch (error) {
                console.error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæ›¸ãè¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®æ›¸ãè¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.result?.error?.message || error.message), 'error');
            }
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: ''
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                tryAutoSignIn();
            }
        }
        
        function addVideoPath() {
            if (!state.formData.videoPaths) {
                state.formData.videoPaths = [];
            }
            
            if (state.formData.videoPaths.length < 3) {
                state.formData.videoPaths.push({
                    name: `å‹•ç”» ${state.formData.videoPaths.length + 1}`,
                    path: '',
                    uploadDate: new Date().toISOString()
                });
                render();
            } else {
                showMessage('å‹•ç”»ãƒ‘ã‚¹ã¯æœ€å¤§3ã¤ã¾ã§è¿½åŠ ã§ãã¾ã™', 'error');
            }
        }

        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                accessToken = gapi.client.getToken().access_token;
                state.isSignedIn = true;
                localStorage.setItem('google_access_token', JSON.stringify(gapi.client.getToken()));
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
                await getUserInfo();
                
                await loadFromDrive();
                render();
            };
        
            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        async function tryAutoSignIn() {
            const savedToken = localStorage.getItem('google_access_token');
            if (savedToken) {
                try {
                    const token = JSON.parse(savedToken);
                    gapi.client.setToken(token);
                    accessToken = token.access_token;
                    await gapi.client.drive.files.list({
                        pageSize: 1,
                        supportsAllDrives: true
                    });
                    state.isSignedIn = true;
                    
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
                    await getUserInfo();
                    
                    await loadFromDrive();
                    render();
                } catch (error) {
                    console.log('Saved token expired');
                    localStorage.removeItem('google_access_token');
                    render();
                }
            } else {
                render();
            }
        }

        async function getUserInfo() {
            try {
                const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                    headers: {
                        'Authorization': 'Bearer ' + accessToken
                    }
                });
                const userInfo = await response.json();
                state.userName = userInfo.name || userInfo.email;
            } catch (error) {
                console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                state.userName = null;
            }
        }

        function handleSignOut() {
            gapi.client.setToken(null);
            localStorage.removeItem('google_access_token');
            accessToken = null;
            state.isSignedIn = false;
            state.userName = null;
            state.posts = {};
            state.folderId = null;
            fileId = null;
            render();
            showMessage('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ', 'success');
        }

        async function refreshTokenIfNeeded() {
            if (!state.isSignedIn) return;
            
            try {
                // ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æ€§ã‚’ãƒ†ã‚¹ãƒˆ
                await gapi.client.drive.files.list({
                    pageSize: 1,
                    supportsAllDrives: true
                });
            } catch (error) {
                console.log('Token expired, refreshing...');
                
                // ãƒˆãƒ¼ã‚¯ãƒ³ãŒæœŸé™åˆ‡ã‚Œã®å ´åˆã€å†èªè¨¼ã‚’è©¦ã¿ã‚‹
                tokenClient.callback = async (resp) => {
                    if (resp.error !== undefined) {
                        console.error('Token refresh failed:', resp);
                        showMessage('èªè¨¼ãŒåˆ‡ã‚Œã¾ã—ãŸã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚', 'error');
                        handleSignOut();
                        return;
                    }
                    accessToken = gapi.client.getToken().access_token;
                    state.isSignedIn = true;
                    localStorage.setItem('google_access_token', JSON.stringify(gapi.client.getToken()));
                    await getUserInfo();
                    showMessage('èªè¨¼ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
                    render();
                };
                
                // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãªã—ã§å†èªè¨¼ã‚’è©¦ã¿ã‚‹
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        async function loadFromDrive() {
            try {
                let folderId = null;
                console.log('ğŸ” æŒ‡å®šãƒ•ã‚©ãƒ«ãƒ€å†…ã‚’æ¤œç´¢é–‹å§‹...');
                
                const folderResponse = await gapi.client.drive.files.list({
                    q: `name='${FOLDER_NAME}' and mimeType='application/vnd.google-apps.folder' and trashed=false and '${TARGET_FOLDER_ID}' in parents`,
                    fields: 'files(id, name)',
                    spaces: 'drive',
                    supportsAllDrives: true,
                    includeItemsFromAllDrives: true,
                    corpora: 'drive',
                    driveId: SHARED_DRIVE_ID
                });
        
                if (folderResponse.result.files && folderResponse.result.files.length > 0) {
                    folderId = folderResponse.result.files[0].id;
                    console.log('âœ… æŒ‡å®šãƒ•ã‚©ãƒ«ãƒ€å†…ã§ãƒ•ã‚©ãƒ«ãƒ€ç™ºè¦‹');
                    showMessage('æŒ‡å®šãƒ•ã‚©ãƒ«ãƒ€å†…ã®ãƒ•ã‚©ãƒ«ãƒ€ã«æ¥ç¶šã—ã¾ã—ãŸ', 'success');
                } else {
                    console.log('âŒ ãƒ•ã‚©ãƒ«ãƒ€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    showMessage('ã€ŒSNSæŠ•ç¨¿ç®¡ç†ã€ãƒ•ã‚©ãƒ«ãƒ€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ç®¡ç†è€…ã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚', 'error');
                    state.isSignedIn = false;
                    handleSignOut();
                    return;
                }
        
                state.folderId = folderId;
                state.currentYear = state.currentDate.getFullYear(); // ã“ã®è¡Œã‚’è¿½åŠ 
                
                // ç¾åœ¨è¡¨ç¤ºä¸­ã®å¹´ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
                await loadYearData();
                
                // Twitter APIãƒˆãƒ¼ã‚¯ãƒ³ã‚’èª­ã¿è¾¼ã‚€
                // await loadTwitterTokens();
                
                console.log('âœ… ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†');
            } catch (error) {
                console.error('âŒ å…±æœ‰ãƒ‰ãƒ©ã‚¤ãƒ–èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('ã‚¨ãƒ©ãƒ¼: ' + (error.result?.error?.message || error.message), 'error');
            }
        }
        
        async function loadYearData() {
            if (!state.folderId) return;
            
            const currentYear = state.currentDate.getFullYear();
            const fileName = `sns_calendar_data_${currentYear}.json`;
            
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name='${fileName}' and '${state.folderId}' in parents and trashed=false`,
                    fields: 'files(id, name, modifiedTime)',
                    spaces: 'drive',
                    supportsAllDrives: true,
                    includeItemsFromAllDrives: true
                });
        
                const files = response.result.files;
                if (files && files.length > 0) {
                    fileId = files[0].id;
                    const serverModifiedTime = files[0].modifiedTime; // Driveã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ä¿å­˜
                    
                    const fileContent = await gapi.client.drive.files.get({
                        fileId: fileId,
                        alt: 'media',
                        supportsAllDrives: true
                    });
        
                    if (fileContent.body) {
                        const data = JSON.parse(fileContent.body);
                        state.posts = data.posts || {};
                        state.lastUpdated = serverModifiedTime; // modifiedTimeã‚’ä½¿ç”¨
                        console.log(`âœ… ${currentYear}å¹´ã®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æˆåŠŸ`);
                        showMessage(`${currentYear}å¹´ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`, 'success');
                    }
                } else {
                    // JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ç©ºã®ãƒ‡ãƒ¼ã‚¿ã§é–‹å§‹
                    console.log(`ğŸ“ ${currentYear}å¹´ã®JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`);
                    state.posts = {};
                    state.lastUpdated = null;
                    fileId = null;
                    showMessage(`${currentYear}å¹´ã®æ–°è¦ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã—ã¾ã™`, 'success');
                }
            } catch (error) {
                console.error('å¹´ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                state.posts = {};
                state.lastUpdated = null;
                fileId = null;
            }
        }

        async function checkForUpdates() {
            // ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æ€§ã‚’ãƒã‚§ãƒƒã‚¯
            await refreshTokenIfNeeded();
            
            try {
                const currentYear = state.currentDate.getFullYear();
                const fileName = `sns_calendar_data_${currentYear}.json`;
                
                const response = await gapi.client.drive.files.list({
                    q: `name='${fileName}' and '${state.folderId}' in parents and trashed=false`,
                    fields: 'files(id, modifiedTime)',
                    spaces: 'drive',
                    supportsAllDrives: true,
                    includeItemsFromAllDrives: true
                });
        
                if (response.result.files && response.result.files.length > 0) {
                    const serverModifiedTime = new Date(response.result.files[0].modifiedTime);
                    const localModifiedTime = state.lastUpdated ? new Date(state.lastUpdated) : new Date(0);
                    
                    // 1ç§’ä»¥ä¸Šã®å·®ãŒã‚ã‚‹å ´åˆã®ã¿ç«¶åˆã¨ã¿ãªã™ï¼ˆè‡ªåˆ†ã®ä¿å­˜ã¨ã®èª¤åˆ¤å®šã‚’é˜²ãï¼‰
                    if (serverModifiedTime.getTime() - localModifiedTime.getTime() > 1000) {
                        if (confirm('ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ\n\nâ€»ç·¨é›†ä¸­ã®å ´åˆã€ç·¨é›†å†…å®¹ã¯ä¿æŒã•ã‚Œã¾ã™ã€‚')) {
                            const currentFormData = state.selectedDate ? {...state.formData} : null;
                            const currentEditingPostId = state.editingPostId;
                            const currentViewMode = state.viewMode;
                            const currentSelectedDate = state.selectedDate;
                            
                            await loadYearData();
                            
                            // ç·¨é›†ä¸­ã ã£ãŸå ´åˆã€ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
                            if (currentSelectedDate) {
                                state.selectedDate = currentSelectedDate;
                                state.editingPostId = currentEditingPostId;
                                state.viewMode = currentViewMode;
                                if (currentFormData) {
                                    state.formData = currentFormData;
                                }
                            }
                            
                            render();
                            showMessage('æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'success');
                        }
                    }
                }
            } catch (error) {
                console.error('æ›´æ–°ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        async function saveToDrive() {
            if (!state.isSignedIn || !state.folderId || state.isSaving) return;
            
            // ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æ€§ã‚’ãƒã‚§ãƒƒã‚¯
            await refreshTokenIfNeeded();
            
            state.isSaving = true;
            render();
        
            try {
                // ä¿å­˜å‰ã«ç«¶åˆãƒã‚§ãƒƒã‚¯
                if (fileId) {
                    const checkResponse = await gapi.client.drive.files.get({
                        fileId: fileId,
                        fields: 'modifiedTime',
                        supportsAllDrives: true
                    });
                    
                    const serverModifiedTime = new Date(checkResponse.result.modifiedTime);
                    const localModifiedTime = state.lastUpdated ? new Date(state.lastUpdated) : new Date(0);
                    
                    // 1ç§’ä»¥ä¸Šã®å·®ãŒã‚ã‚‹å ´åˆã®ã¿ç«¶åˆã¨ã¿ãªã™ï¼ˆè‡ªåˆ†ã®ä¿å­˜ã¨ã®èª¤åˆ¤å®šã‚’é˜²ãï¼‰
                    if (serverModifiedTime.getTime() - localModifiedTime.getTime() > 1000) {
                        // ç·¨é›†ä¸­ã®å†…å®¹ã‚’ä¿æŒ
                        const currentFormData = {...state.formData};
                        const currentEditingPostId = state.editingPostId;
                        const currentViewMode = state.viewMode;
                        const currentSelectedDate = state.selectedDate;
                        
                        // æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•ã§èª­ã¿è¾¼ã‚€
                        await loadYearData();
                        
                        // ç”»é¢ã‚’å¾©å…ƒ
                        state.selectedDate = currentSelectedDate;
                        state.editingPostId = currentEditingPostId;
                        state.viewMode = currentViewMode;
                        state.formData = currentFormData;
                        
                        showMessage('æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚ä¿å­˜ã‚’ç¶šè¡Œã—ã¾ã™...', 'success');
                        
                        // èª­ã¿è¾¼ã‚“ã æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã«å¯¾ã—ã¦ä¿å­˜ã‚’å®Ÿè¡Œï¼ˆå†å¸°çš„ã«å®Ÿè¡Œï¼‰
                        state.isSaving = false;
                        await saveToDrive();
                        return;
                    }
                }
        
                const currentYear = state.currentDate.getFullYear();
                const fileName = `sns_calendar_data_${currentYear}.json`;
                
                const now = new Date().toISOString();
                const content = JSON.stringify({
                    posts: state.posts,
                    lastUpdated: now
                });
        
                const file = new Blob([content], { type: 'application/json' });
                const metadata = fileId ? {
                    name: fileName,
                    mimeType: 'application/json'
                } : {
                    name: fileName,
                    mimeType: 'application/json',
                    parents: [state.folderId]
                };
        
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', file);
        
                const url = fileId
                    ? `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart&supportsAllDrives=true`
                    : `https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&supportsAllDrives=true`;
        
                const response = await fetch(url, {
                    method: fileId ? 'PATCH' : 'POST',
                    headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
                    body: form
                });
        
                if (!response.ok) {
                    throw new Error(`ä¿å­˜ã«å¤±æ•—: ${response.status}`);
                }
        
                const result = await response.json();
                if (!fileId) {
                    fileId = result.id;
                }
        
                // ä¿å­˜å¾Œã«Driveã®modifiedTimeã‚’å†å–å¾—ã—ã¦åŒæœŸ
                const updatedFile = await gapi.client.drive.files.get({
                    fileId: fileId,
                    fields: 'modifiedTime',
                    supportsAllDrives: true
                });
                state.lastUpdated = updatedFile.result.modifiedTime;
                
                showMessage('å…±æœ‰ãƒ‰ãƒ©ã‚¤ãƒ–ã«ä¿å­˜ã—ã¾ã—ãŸï¼', 'success');
        
            } catch (error) {
                console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('ä¿å­˜ã«å¤±æ•—: ' + error.message, 'error');
            } finally {
                state.isSaving = false;
                render();
            }
        }

        async function updateSpreadsheetInBackground() {
            try {
                if (Object.keys(state.posts).length === 0) return;
        
                const headers = [['æŠ•ç¨¿æ—¥', 'ã‚¿ã‚¤ãƒˆãƒ«', 'æŠ•ç¨¿å…ˆ', 'æŠ•ç¨¿ãƒ†ã‚­ã‚¹ãƒˆ', 'ãƒã‚§ãƒƒã‚¯å®Œäº†è€…', 'å‹•ç”»ãƒ‘ã‚¹', 'æœ€çµ‚æ›´æ–°æ—¥æ™‚']];
                const rows = [];
                
                Object.keys(state.posts).sort().forEach(date => {
                    state.posts[date].forEach(post => {
                        const platforms = (post.platforms || [post.platform]).map(p => {
                            const badges = { x: 'ğ•', instagram: 'Instagram', line: 'LINE', stumaga: 'ã‚¹ã‚¿ãƒã‚¬' };
                            return badges[p] || p;
                        }).join(', ');
                        
                        const checks = (post.checks || []).join(', ');
                        const videoPaths = (post.videoPaths || []).map(v => v.path).filter(p => p).join(', ');
                        
                        rows.push([
                            date,
                            post.title || 'ç„¡é¡Œ',
                            platforms,
                            post.text || '',
                            checks,
                            videoPaths,
                            new Date().toLocaleString('ja-JP')
                        ]);
                    });
                });
        
                await gapi.client.sheets.spreadsheets.values.clear({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'ã‚·ãƒ¼ãƒˆ1!A1:Z'
                });
        
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'ã‚·ãƒ¼ãƒˆ1!A1',
                    valueInputOption: 'RAW',
                    resource: { values: [...headers, ...rows] }
                });
        
                console.log('âœ… ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè‡ªå‹•æ›´æ–°å®Œäº†');
        
            } catch (error) {
                console.error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè‡ªå‹•æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                // ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã‚‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯é€šçŸ¥ã—ãªã„ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ã®ãŸã‚ï¼‰
            }
        }

        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white z-50 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            setTimeout(() => messageDiv.remove(), 3000);
        }

        function formatDateTime(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            return `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        }

        function formatDate(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        function getDaysInMonth(date) {
            const year = date.getFullYear();
            const month = date.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            return {
                daysInMonth: lastDay.getDate(),
                startingDayOfWeek: firstDay.getDay()
            };
        }

        async function savePost() {
            if (!state.formData.title && !state.formData.text) return;
         
            // ç”»åƒã¨å‹•ç”»ã‚’åˆ†é›¢
            const imageFiles = state.formData.images.filter(file => file.type === 'image');
            const videoFiles = state.formData.images.filter(file => file.type === 'video');
         
            const newPost = {
                ...state.formData,
                id: state.editingPostId || Date.now(),
                images: imageFiles.map(file => ({
                    type: file.type,
                    name: file.name,
                    size: file.data ? file.data.length : 0,
                    data: file.data,
                    uploadDate: new Date().toISOString()
                })),
                checks: state.formData.checks || [],
                completedChecks: state.formData.completedChecks || [],
                productNumber: state.formData.productNumber || '',
                embedProduct: state.formData.embedProduct || false,
                remarks: state.formData.remarks || '',
                links: state.formData.links || [],
            };
         
            const datePosts = state.posts[state.selectedDate] || [];
            if (state.editingPostId) {
                // å…¨ã¦ã®æ—¥ä»˜ã‹ã‚‰è©²å½“ã™ã‚‹æŠ•ç¨¿ã‚’æ¤œç´¢
                let oldDateStr = null;
                for (const dateStr in state.posts) {
                    const foundPost = state.posts[dateStr].find(p => p.id === state.editingPostId);
                    if (foundPost) {
                        oldDateStr = dateStr;
                        break;
                    }
                }
                
                // å…ƒã®æ—¥ä»˜ã¨ç•°ãªã‚‹å ´åˆã¯ç§»å‹•
                if (oldDateStr && oldDateStr !== state.selectedDate) {
                    // å…ƒã®æ—¥ä»˜ã‹ã‚‰å‰Šé™¤
                    const oldDatePosts = state.posts[oldDateStr].filter(p => p.id !== state.editingPostId);
                    if (oldDatePosts.length === 0) {
                        delete state.posts[oldDateStr];
                    } else {
                        state.posts[oldDateStr] = oldDatePosts;
                    }
                    
                    // æ–°ã—ã„æ—¥ä»˜ã«è¿½åŠ 
                    state.posts[state.selectedDate] = [...datePosts, newPost];
                    showMessage('æŠ•ç¨¿æ—¥ã‚’å¤‰æ›´ã—ã¦ä¿å­˜ã—ã¾ã—ãŸ', 'success');
                } else {
                    // åŒã˜æ—¥ä»˜å†…ã§æ›´æ–°
                    const existingPostIndex = datePosts.findIndex(p => p.id === state.editingPostId);
                    
                    if (existingPostIndex !== -1) {
                        state.posts[state.selectedDate] = datePosts.map(p => p.id === state.editingPostId ? newPost : p);
                    } else {
                        state.posts[state.selectedDate] = [...datePosts, newPost];
                        showMessage('æŠ•ç¨¿ãŒå‰Šé™¤ã•ã‚Œã¦ã„ãŸãŸã‚ã€æ–°è¦æŠ•ç¨¿ã¨ã—ã¦ä¿å­˜ã—ã¾ã—ãŸ', 'success');
                    }
                }
            } else {
                state.posts[state.selectedDate] = [...datePosts, newPost];
                // æ–°è¦æŠ•ç¨¿ã®å ´åˆã€ä½œæˆã—ãŸæŠ•ç¨¿ã®IDã‚’è¨­å®š
                state.editingPostId = newPost.id;
            }
         
            await saveToDrive();
            
            // é–²è¦§ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
            state.viewMode = 'view';
            render();
        }
        
        function cancelEdit() {
            state.selectedDate = null;
            state.editingPostId = null;
            state.viewMode = 'edit';
            state.formData = {title: '', platforms: [], text: '', images: [], checks: [], completedChecks: []};
        }

        function confirmDelete(dateStr, postId) {
            if (confirm('æœ¬å½“ã«ã“ã®æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                deletePost(dateStr, postId);
            }
        }

        async function deletePost(dateStr, postId) {
            const datePosts = state.posts[dateStr].filter(p => p.id !== postId);
            if (datePosts.length === 0) {
                delete state.posts[dateStr];
            } else {
                state.posts[dateStr] = datePosts;
            }
            await saveToDrive();
            cancelEdit();
            render();
        }

        function addLink() {
            if (!state.formData.links) {
                state.formData.links = [];
            }
            
            if (state.formData.links.length < 5) {
                state.formData.links.push('');
                render();
            } else {
                showMessage('ãƒªãƒ³ã‚¯å…ˆã¯æœ€å¤§5ã¤ã¾ã§è¿½åŠ ã§ãã¾ã™', 'error');
            }
        }
        
        function removeLink(index) {
            state.formData.links = state.formData.links.filter((_, i) => i !== index);
            render();
        }

        function openEditForm(day, postId = null) {
            const dateStr = formatDate(new Date(state.currentDate.getFullYear(), state.currentDate.getMonth(), day));
            state.selectedDate = dateStr;
        
            if (postId && state.posts[dateStr]) {
                const post = state.posts[dateStr].find(p => p.id === postId);
                if (post) {
                    state.formData = { ...post };
                    if (!state.formData.platforms && state.formData.platform) {
                        state.formData.platforms = [state.formData.platform];
                    }
                    if (!state.formData.checks) {
                        state.formData.checks = [];
                    }
                    if (!state.formData.completedChecks) {
                        state.formData.completedChecks = [];
                    }
                    if (!state.formData.productNumber) {
                        state.formData.productNumber = '';
                    }
                    if (!state.formData.embedProduct) {
                        state.formData.embedProduct = false;
                    }
                    if (!state.formData.remarks) {
                        state.formData.remarks = '';
                    }
                    if (!state.formData.links) {
                        state.formData.links = [];
                    }
                    
                    state.editingPostId = postId;
                    state.viewMode = 'view';
                }
            } else {
                state.formData = {
                    title: '', 
                    platforms: [], 
                    text: '', 
                    images: [], 
                    checks: [],
                    productNumber: '',
                    embedProduct: false,
                    remarks: '',
                    links: [''],
                };
                state.editingPostId = null;
                state.viewMode = 'edit';
            }
            render();
        }

        function switchToEditMode() {
            state.viewMode = 'edit';
            render();
        }

        function changeSelectedDate(newDate) {
            if (!newDate || newDate === state.selectedDate) return;
            
            // æ–°ã—ã„æ—¥ä»˜ã‚’è¨­å®š
            const oldDate = state.selectedDate;
            state.selectedDate = newDate;
            
            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºã‚‚æ–°ã—ã„æ—¥ä»˜ã®æœˆã«ç§»å‹•
            const newDateObj = new Date(newDate);
            state.currentDate = new Date(newDateObj.getFullYear(), newDateObj.getMonth(), 1);
            
            render();
        }

        function togglePlatform(platform) {
            if (state.formData.platforms.includes(platform)) {
                state.formData.platforms = state.formData.platforms.filter(p => p !== platform);
            } else {
                state.formData.platforms.push(platform);
            }
            render();
        }

        function handleImageSelect(e) {
            const files = Array.from(e.target.files);
            console.log('é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®æ•°:', files.length);
            
            if (files.length === 0) return;
        
            const remainingSlots = 20 - state.formData.images.length; // 5ã‹ã‚‰20ã«å¤‰æ›´
            const filesToProcess = files.slice(0, remainingSlots);
            let processed = 0;
            const newFiles = [];
        
            filesToProcess.forEach(file => {
                console.log('å‡¦ç†ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«:', file.name, 'ã‚¿ã‚¤ãƒ—:', file.type, 'ã‚µã‚¤ã‚º:', file.size);
        
                // 100MBã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºåˆ¶é™ã‚’è¿½åŠ 
                if (file.size > 100 * 1024 * 1024) {
                    showMessage(`ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™: ${file.name} (100MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„)`, 'error');
                    return;
                }
        
                const reader = new FileReader();
                reader.onload = (event) => {
                    console.log('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†:', file.name);
                    console.log('ãƒ‡ãƒ¼ã‚¿é•·:', event.target.result ? event.target.result.length : 'ãƒ‡ãƒ¼ã‚¿ãªã—');
                    
                    newFiles.push({
                        type: file.type.startsWith('image/') ? 'image' : 'video',
                        data: event.target.result,
                        name: file.name,
                        originalFile: file
                    });
                    processed++;
                    if (processed === filesToProcess.length) {
                        state.formData.images = [...state.formData.images, ...newFiles];
                        console.log('è¿½åŠ å¾Œã®ç”»åƒæ•°:', state.formData.images.length);
                        render();
                    }
                };
                reader.readAsDataURL(file);
            });
        }
        
        // removeImageé–¢æ•°ã‚’ä¿®æ­£
        function removeImage(index) {
            state.formData.images = state.formData.images.filter((_, i) => i !== index);
            render();
        }
        
        // downloadImageé–¢æ•°ã‚’ä¿®æ­£ã—ã€å‹•ç”»ã‚‚ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½ã«
        function downloadImage(fileData, title, index) {
            if (!fileData || !fileData.data) {
                console.error('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', fileData);
                return;
            }
            const link = document.createElement('a');
            link.href = fileData.data;
            link.download = `${title || 'media'}_${index + 1}${getFileExtension(fileData)}`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function getFileExtension(file) {
            if (file.type === 'image') {
                const match = file.data.match(/^data:image\/([a-zA-Z0-9]+);/);
                return match ? `.${match[1]}` : '.png';
            }
            if (file.type === 'video') {
                const match = file.data.match(/^data:video\/([a-zA-Z0-9]+);/);
                return match ? `.${match[1]}` : '.mp4';
            }
            return '';
        }

        function goToToday() {
            state.currentDate = new Date();
            render();
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showMessage('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼', 'success');
            });
        }

        function toggleCheckCompletion(checkText) {
            if (!state.formData.completedChecks) {
                state.formData.completedChecks = [];
            }
            
            if (state.formData.completedChecks.includes(checkText)) {
                state.formData.completedChecks = state.formData.completedChecks.filter(c => c !== checkText);
            } else {
                state.formData.completedChecks.push(checkText);
            }
            
            // è‡ªå‹•ä¿å­˜
            saveToDrive();
            render();
        }

        function addViewCheck(inputId) {
            const input = document.getElementById(inputId);
            const value = input.value.trim();
            
            if (!state.formData.checks) {
                state.formData.checks = [];
            }
            
            if (value && !state.formData.checks.includes(value)) {
                state.formData.checks.push(value);
                input.value = '';
                saveToDrive(); // è‡ªå‹•ä¿å­˜
                render();
            }
        }
        
        function removeViewCheck(index) {
            state.formData.checks = state.formData.checks.filter((_, i) => i !== index);
            saveToDrive(); // è‡ªå‹•ä¿å­˜
            render();
        }

        function addCheckPerson() {
            const input = document.getElementById('checkPersonInput');
            const value = input.value.trim();
            
            if (!state.formData.checks) {
                state.formData.checks = [];
            }
            
            if (value && !state.formData.checks.includes(value)) {
                state.formData.checks.push(value);
                input.value = '';
                saveToDrive(); // è‡ªå‹•ä¿å­˜
                render();
            }
        }
        
        function removeCheckPerson(index) {
            state.formData.checks = state.formData.checks.filter((_, i) => i !== index);
            saveToDrive(); // è‡ªå‹•ä¿å­˜
            render();
        }

        async function postToX() {
            // ãƒã‚§ãƒƒã‚¯å®Œäº†è€…ãŒã„ã‚‹ã‹ç¢ºèª
            if (!state.formData.checks || state.formData.checks.length === 0) {
                showMessage('âŒ æŠ•ç¨¿å‰ã«ãƒã‚§ãƒƒã‚¯ã‚’å®Œäº†ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            // æŠ•ç¨¿å†…å®¹ã‚’æº–å‚™
            const postText = state.formData.text || '';
            
            // ãƒ†ã‚­ã‚¹ãƒˆã¾ãŸã¯ãƒ¡ãƒ‡ã‚£ã‚¢ãŒå¿…è¦
            if (!postText && !state.formData.embedProduct && (!state.formData.images || state.formData.images.length === 0)) {
                showMessage('âŒ æŠ•ç¨¿ãƒ†ã‚­ã‚¹ãƒˆã¾ãŸã¯ãƒ¡ãƒ‡ã‚£ã‚¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            const links = (state.formData.links || []).filter(l => l.trim());
            let fullText = postText;
            
            // ãƒªãƒ³ã‚¯ã‚’æ”¹è¡Œã—ã¦è¿½åŠ 
            if (links.length > 0) {
                fullText += '\n\n' + links.join('\n');
            }
            
            // 280æ–‡å­—åˆ¶é™ãƒã‚§ãƒƒã‚¯
            if (fullText.length > 280) {
                showMessage(`âŒ ãƒ†ã‚­ã‚¹ãƒˆãŒé•·ã™ãã¾ã™ï¼ˆ${fullText.length}/280æ–‡å­—ï¼‰`, 'error');
                return;
            }
            
            // å‹•ç”»åŸ‹ã‚è¾¼ã¿ã®å ´åˆã€Driveã®ãƒ•ã‚¡ã‚¤ãƒ«IDã‚’å–å¾—
            let videoFileId = null;
            if (state.formData.embedProduct && state.formData.productNumber) {
                try {
                    const response = await gapi.client.drive.files.list({
                        q: `name='${state.formData.productNumber}.mp4' and '${VIDEO_FOLDER_ID}' in parents and trashed=false`,
                        fields: 'files(id, name)',
                        spaces: 'drive',
                        supportsAllDrives: true,
                        includeItemsFromAllDrives: true
                    });
                    
                    if (response.result.files && response.result.files.length > 0) {
                        videoFileId = response.result.files[0].id;
                        console.log('âœ… å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«IDå–å¾—:', videoFileId);
                    } else {
                        showMessage(`âŒ å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${state.formData.productNumber}.mp4ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ`, 'error');
                        return;
                    }
                } catch (error) {
                    console.error('å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«IDå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                    showMessage('âŒ å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                    return;
                }
            }
            
            // æ‰‹å‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸç”»åƒã®ãƒ•ã‚¡ã‚¤ãƒ«IDã‚’æº–å‚™
            const imageFileIds = [];
            if (state.formData.images && state.formData.images.length > 0) {
                showMessage('â³ ç”»åƒã‚’Google Driveã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...', 'success');
                
                for (const image of state.formData.images) {
                    try {
                        // Base64ã‹ã‚‰Blobã«å¤‰æ›
                        const response = await fetch(image.data);
                        const blob = await response.blob();
                        
                        // Google Driveã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                        const metadata = {
                            name: `temp_${Date.now()}_${image.name}`,
                            parents: [VIDEO_FOLDER_ID]
                        };
                        
                        const form = new FormData();
                        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                        form.append('file', blob);
                        
                        const uploadResponse = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&supportsAllDrives=true', {
                            method: 'POST',
                            headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
                            body: form
                        });
                        
                        if (uploadResponse.ok) {
                            const result = await uploadResponse.json();
                            imageFileIds.push(result.id);
                            console.log('âœ… ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸ:', result.id);
                        }
                    } catch (error) {
                        console.error('ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                        showMessage('âŒ ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                        return;
                    }
                }
            }
            
            // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
            const previewText = fullText.length > 100 ? fullText.substring(0, 100) + '...' : fullText;
            let mediaText = '';
            if (videoFileId) mediaText += '\nğŸ¬ å‹•ç”»: 1å€‹';
            if (imageFileIds.length > 0) mediaText += `\nğŸ“· ç”»åƒ: ${imageFileIds.length}å€‹`;
            
            if (!confirm(`ä»¥ä¸‹ã®å†…å®¹ã§Xã«æŠ•ç¨¿ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\n\n${previewText}${mediaText}`)) {
                return;
            }
            
            try {
                showMessage('â³ Xã«æŠ•ç¨¿ä¸­...', 'success');
                
                // Google Apps Scriptã®Web APIã‚’å‘¼ã³å‡ºã™
                const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbydrnEuxFI4a8yaTcsFOPQTnXJA1Z2tEX_wZU6bU5gjS80k-r-YLoX_Fe8qgxy4UrsNgw/exec'; // â† å¾Œã§è¨­å®š
                
                const requestData = {
                    text: fullText,
                    videoFileId: videoFileId,
                    imageFileIds: imageFileIds
                };
                
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain'
                    },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('âœ… Xã«æŠ•ç¨¿ã—ã¾ã—ãŸï¼', 'success');
                } else {
                    showMessage(`âŒ XæŠ•ç¨¿ã«å¤±æ•—: ${result.error}`, 'error');
                }
                
            } catch (error) {
                console.error('XæŠ•ç¨¿ã‚¨ãƒ©ãƒ¼:', error);
                showMessage(`âŒ XæŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, 'error');
            }
        }

async function postToInstagram() {
            // ãƒã‚§ãƒƒã‚¯å®Œäº†è€…ãŒã„ã‚‹ã‹ç¢ºèª
            if (!state.formData.checks || state.formData.checks.length === 0) {
                showMessage('âŒ æŠ•ç¨¿å‰ã«ãƒã‚§ãƒƒã‚¯ã‚’å®Œäº†ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            // ç”»åƒãŒå¿…é ˆï¼ˆInstagramã¯ãƒ†ã‚­ã‚¹ãƒˆã®ã¿æŠ•ç¨¿ä¸å¯ï¼‰
            if (!state.formData.images || state.formData.images.length === 0) {
                showMessage('âŒ Instagramã«ã¯ç”»åƒãŒå¿…é ˆã§ã™', 'error');
                return;
            }
            
            // æŠ•ç¨¿å†…å®¹ã‚’æº–å‚™
            const caption = state.formData.text || '';
            
            // ãƒªãƒ³ã‚¯ã‚’è¿½åŠ 
            const links = (state.formData.links || []).filter(l => l.trim());
            let fullCaption = caption;
            if (links.length > 0) {
                fullCaption += '\n\n' + links.join('\n');
            }
            
            // 2200æ–‡å­—åˆ¶é™ãƒã‚§ãƒƒã‚¯
            if (fullCaption.length > 2200) {
                showMessage(`âŒ ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ãŒé•·ã™ãã¾ã™ï¼ˆ${fullCaption.length}/2200æ–‡å­—ï¼‰`, 'error');
                return;
            }
            
            // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
            const previewText = fullCaption.length > 100 ? fullCaption.substring(0, 100) + '...' : fullCaption;
            const mediaText = `\nğŸ“· ç”»åƒ: ${state.formData.images.length}å€‹`;
            
            if (!confirm(`ä»¥ä¸‹ã®å†…å®¹ã§Instagramã«æŠ•ç¨¿ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\n\n${previewText}${mediaText}`)) {
                return;
            }
            
            try {
                showMessage('â³ Instagramã«æŠ•ç¨¿ä¸­...', 'success');
                
                // ç”»åƒã‚’1æšãšã¤Cloudinaryã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                const imageUrls = [];
                const CLOUDINARY_CLOUD_NAME = 'duusvznln';
                const CLOUDINARY_UPLOAD_PRESET = 'instagram_upload';
                
                for (let i = 0; i < state.formData.images.length; i++) {
                    const image = state.formData.images[i];
                    
                    // Cloudinaryã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                    const cloudinaryFormData = new FormData();
                    cloudinaryFormData.append('file', image.data);
                    cloudinaryFormData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                    
                    const cloudinaryResponse = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
                        method: 'POST',
                        body: cloudinaryFormData
                    });
                    
                    if (!cloudinaryResponse.ok) {
                        const errorData = await cloudinaryResponse.json();
                        throw new Error(`ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—: ${errorData.error?.message || 'Unknown error'}`);
                    }
                    
                    const cloudinaryResult = await cloudinaryResponse.json();
                    const imageUrl = cloudinaryResult.secure_url;
                    imageUrls.push(imageUrl);
                    
                    console.log(`âœ… ç”»åƒ ${i + 1} ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸ:`, imageUrl);
                    showMessage(`â³ ç”»åƒ ${i + 1}/${state.formData.images.length} ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...`, 'success');
                }
                
                console.log('âœ… å…¨ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†ã€‚Instagram APIã¸é€ä¿¡é–‹å§‹...');
                console.log('ğŸ“ ç”»åƒURLs:', imageUrls);
                
                // Instagram Graph APIã§ãƒ¡ãƒ‡ã‚£ã‚¢ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆ
                const mediaIds = [];
                
                for (let i = 0; i < imageUrls.length; i++) {
                    const imageUrl = imageUrls[i];
                    
                    const containerUrl = state.formData.images.length === 1
                        ? `https://graph.facebook.com/v18.0/${INSTAGRAM_ACCOUNT_ID}/media?image_url=${encodeURIComponent(imageUrl)}&caption=${encodeURIComponent(fullCaption)}&access_token=${INSTAGRAM_ACCESS_TOKEN}`
                        : `https://graph.facebook.com/v18.0/${INSTAGRAM_ACCOUNT_ID}/media?image_url=${encodeURIComponent(imageUrl)}&is_carousel_item=true&access_token=${INSTAGRAM_ACCESS_TOKEN}`;
                    
                    console.log('ğŸ“ ãƒªã‚¯ã‚¨ã‚¹ãƒˆURL:', containerUrl);
                    console.log('ğŸ“ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆID:', INSTAGRAM_ACCOUNT_ID);
                    console.log('ğŸ“ ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆæœ€åˆã®20æ–‡å­—ï¼‰:', INSTAGRAM_ACCESS_TOKEN.substring(0, 20));
                    
                    const containerResponse = await fetch(containerUrl, { method: 'POST' });
                    
                    console.log('ğŸ“ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:', containerResponse.status);
                    
                    if (!containerResponse.ok) {
                        const errorData = await containerResponse.json();
                        console.error('ğŸ“ ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', errorData);
                        throw new Error(`ãƒ¡ãƒ‡ã‚£ã‚¢ã‚³ãƒ³ãƒ†ãƒŠã®ä½œæˆã«å¤±æ•—: ${JSON.stringify(errorData.error || errorData)}`);
                    }
                    
                    const containerResult = await containerResponse.json();
                    mediaIds.push(containerResult.id);
                }
                
                showMessage('â³ æŠ•ç¨¿ã‚’å…¬é–‹ä¸­...', 'success');
                
                // æŠ•ç¨¿ã‚’å…¬é–‹
                let publishUrl;
                if (state.formData.images.length === 1) {
                    // å˜ä¸€ç”»åƒæŠ•ç¨¿
                    publishUrl = `https://graph.facebook.com/v18.0/${INSTAGRAM_ACCOUNT_ID}/media_publish?creation_id=${mediaIds[0]}&access_token=${INSTAGRAM_ACCESS_TOKEN}`;
                } else {
                    // ã‚«ãƒ«ãƒ¼ã‚»ãƒ«æŠ•ç¨¿
                    const carouselUrl = `https://graph.facebook.com/v18.0/${INSTAGRAM_ACCOUNT_ID}/media?media_type=CAROUSEL&children=${mediaIds.join(',')}&caption=${encodeURIComponent(fullCaption)}&access_token=${INSTAGRAM_ACCESS_TOKEN}`;
                    const carouselResponse = await fetch(carouselUrl, { method: 'POST' });
                    
                    if (!carouselResponse.ok) {
                        const errorData = await carouselResponse.json();
                        throw new Error(`ã‚«ãƒ«ãƒ¼ã‚»ãƒ«ã®ä½œæˆã«å¤±æ•—: ${errorData.error?.message || 'Unknown error'}`);
                    }
                    
                    const carouselResult = await carouselResponse.json();
                    publishUrl = `https://graph.facebook.com/v18.0/${INSTAGRAM_ACCOUNT_ID}/media_publish?creation_id=${carouselResult.id}&access_token=${INSTAGRAM_ACCESS_TOKEN}`;
                }
                
                const publishResponse = await fetch(publishUrl, { method: 'POST' });
                
                if (!publishResponse.ok) {
                    const errorData = await publishResponse.json();
                    throw new Error(`æŠ•ç¨¿ã®å…¬é–‹ã«å¤±æ•—: ${errorData.error?.message || 'Unknown error'}`);
                }
                
                const publishResult = await publishResponse.json();
                
                showMessage('âœ… Instagramã«æŠ•ç¨¿ã—ã¾ã—ãŸï¼', 'success');
                
            } catch (error) {
                console.error('InstagramæŠ•ç¨¿ã‚¨ãƒ©ãƒ¼:', error);
                console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', JSON.stringify(error, null, 2));
                if (error.result) {
                    console.error('API ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', error.result);
                }
                showMessage(`âŒ InstagramæŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message || error.toString() || 'Unknown error'}`, 'error');
            }
        }
    
      function render() {
            const { daysInMonth, startingDayOfWeek } = getDaysInMonth(state.currentDate);
            const monthName = state.currentDate.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long' });
            const today = new Date();
            const isCurrentMonth = state.currentDate.getMonth() === today.getMonth() && state.currentDate.getFullYear() === today.getFullYear();

            const platformBadges = {
                x: { label: 'ğ•', color: 'bg-black' },
                instagram: { label: 'IG', color: 'bg-gradient-to-r from-purple-500 to-pink-500' },
                line: { label: 'L', color: 'bg-green-500' },
                stumaga: { label: 'M', color: 'bg-orange-500' },
                youtube: { label: 'YT', color: 'bg-red-600' }
            };

            let calendarHTML = '';
            const weekDays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            weekDays.forEach((day, index) => {
                const dayColor = index === 0 ? 'text-red-600' : (index === 6 ? 'text-blue-600' : 'text-gray-600');
                calendarHTML += `<div class="text-center font-bold ${dayColor} py-2">${day}</div>`;
            });
            
            for (let i = 0; i < startingDayOfWeek; i++) {
                calendarHTML += '<div class="p-2"></div>';
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = formatDate(new Date(state.currentDate.getFullYear(), state.currentDate.getMonth(), day));
                const dayPosts = state.posts[dateStr] || [];
                const isToday = isCurrentMonth && day === today.getDate();
                
                // æ›œæ—¥ã‚’è¨ˆç®—ï¼ˆ0=æ—¥æ›œ, 6=åœŸæ›œï¼‰
                const currentDayOfWeek = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth(), day).getDay();
                const dayColor = currentDayOfWeek === 0 ? 'text-red-600' : (currentDayOfWeek === 6 ? 'text-blue-600' : 'text-gray-700');
                const todayBorder = isToday ? 'border-blue-400 bg-blue-50' : 'border-gray-200';
            
                const disabledClass = state.isSignedIn ? '' : 'opacity-50 cursor-not-allowed';
                const hoverClass = state.isSignedIn ? 'hover:border-blue-200' : '';
                
                calendarHTML += `
                    <div class="p-2 min-h-24 border rounded-lg transition-all bg-white ${todayBorder} ${hoverClass} ${disabledClass}">
                        <div class="font-semibold mb-2 ${dayColor}">${day}${isToday ? '<span class="ml-1 text-xs">â—</span>' : ''}</div>
                        <div class="space-y-1">
                            ${dayPosts.map(post => {
                                const platforms = post.platforms || [post.platform];
                                const clickHandler = state.isSignedIn ? `onclick="openEditForm(${day}, ${post.id})"` : `onclick="showMessage('å…ˆã«Google Driveã«æ¥ç¶šã—ã¦ãã ã•ã„', 'error')"`;
                                const postHoverClass = state.isSignedIn ? 'hover:border-blue-400 cursor-pointer hover:shadow-sm' : 'cursor-not-allowed';
                                return `<div ${clickHandler} class="text-xs bg-white p-2 rounded border border-gray-200 ${postHoverClass} transition-all">
                                    <div class="flex items-center gap-1 flex-wrap">
                                        ${platforms.map(p => {
                                            const badge = platformBadges[p];
                                            return `<span class="${badge.color} text-white px-1 py-0.5 rounded text-[9px]">${badge.label}</span>`;
                                        }).join('')}
                                        <span class="font-semibold text-gray-700 truncate text-[11px]">${post.title || 'ç„¡é¡Œ'}</span>
                                    </div>
                                </div>`;
                            }).join('')}
                            <button ${state.isSignedIn ? `onclick="openEditForm(${day})"` : `onclick="showMessage('å…ˆã«Google Driveã«æ¥ç¶šã—ã¦ãã ã•ã„', 'error')"`} class="w-full text-[11px] ${state.isSignedIn ? 'text-gray-400 hover:text-gray-600 hover:bg-gray-50 cursor-pointer' : 'text-gray-300 cursor-not-allowed'} py-1 flex items-center justify-center gap-1 rounded transition-colors">
                                <span>+</span> è¿½åŠ 
                            </button>
                        </div>
                    </div>
                `;
            }

            let editFormHTML = '';
            if (state.selectedDate) {
                const platformButtons = [
                    {value: 'x', label: 'ğ•', color: 'bg-black'},
                    {value: 'instagram', label: 'Instagram', color: 'bg-gradient-to-r from-purple-500 to-pink-500'},
                    {value: 'line', label: 'LINE', color: 'bg-green-500'},
                    {value: 'stumaga', label: 'ã‚¹ã‚¿ãƒã‚¬', color: 'bg-orange-500'}
                ];

                if (state.viewMode === 'view') {
                    const platforms = state.formData.platforms || [state.formData.platform];
                    editFormHTML = `<div class="bg-white rounded-2xl shadow-xl p-4">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-3">
                                <div class="text-2xl font-bold text-gray-800">${state.selectedDate}</div>
                                <div class="flex gap-1 flex-wrap">
                                    ${platforms.map(p => {
                                        const badge = platformBadges[p];
                                        return `<span class="${badge.color} text-white px-2 py-1 rounded text-sm">${badge.label}</span>`;
                                    }).join('')}
                                </div>
                            </div>
                            <button onclick="cancelEdit(); render();" class="p-1 hover:bg-gray-100 rounded-lg transition-colors">
                                <span class="text-xl">Ã—</span>
                            </button>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <div class="font-semibold text-gray-800 text-lg">${state.formData.title || 'ç„¡é¡Œ'}</div>
                            </div>
                            ${state.formData.productNumber ? `
                                <div>
                                    <div class="flex items-center gap-2">
                                        <div class="text-sm flex-1">
                                            <span class="font-semibold">å•†å“ç•ªå·:</span> 
                                            <a href="https://winds-score.com/products/${state.formData.productNumber}" target="_blank" class="text-blue-600 hover:text-blue-800 underline">${state.formData.productNumber}</a>
                                            ${state.formData.embedProduct ? '<span class="ml-2 bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-xs">å‹•ç”»åŸ‹è¾¼</span>' : ''}
                                        </div>
                                        <button onclick="copyProductUrl('${state.formData.productNumber}')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1.5 rounded-lg transition-colors text-xs whitespace-nowrap">
                                            ğŸ”— å•†å“URLã‚³ãƒ”ãƒ¼
                                        </button>
                                        ${state.formData.embedProduct ? `
                                            <button onclick="findAndDownloadVideo('${state.formData.productNumber}')" title="[Google Drive > å…±æœ‰ãƒ‰ãƒ©ã‚¤ãƒ– > 07_åºƒå ± > YouTube > ãƒ„ã‚¤ãƒ¼ãƒˆç”¨å‹•ç”» > ALL] å†…ã®&quot;${state.formData.productNumber}.mp4&quot;ã‚’æ¢ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-1.5 rounded-lg transition-colors text-xs whitespace-nowrap">
                                                â¬‡ï¸ å‹•ç”»DL
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            ` : ''}
                            <div>
                                <div class="bg-gray-50 p-2 rounded-lg rounded-b-none border border-gray-200 border-b-0 whitespace-pre-wrap text-sm leading-relaxed">${state.formData.text || 'ãƒ†ã‚­ã‚¹ãƒˆãªã—'}</div>
                                <button onclick="copyToClipboard(\`${state.formData.text}\`)" class="w-full flex items-center justify-center gap-2 bg-gray-200 text-gray-600 py-1.5 rounded-lg rounded-t-none hover:bg-gray-300 transition-colors text-xs border border-gray-200 border-t-0">
                                    ğŸ“‹ ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼
                                </button>
                            </div>
                            ${state.formData.links && state.formData.links.length > 0 ? `
                                <div>
                                    <div class="space-y-1">
                                        ${state.formData.links.map((link, index) => `
                                            <div class="bg-blue-50 p-2 rounded-lg border border-blue-200 flex items-center gap-2">
                                                <a href="${link}" target="_blank" class="text-blue-600 hover:text-blue-800 text-xs break-all flex-1">ğŸ”— ${link}</a>
                                                <button onclick="copyToClipboard(\`${link}\`)" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs whitespace-nowrap">
                                                    ã‚³ãƒ”ãƒ¼
                                                </button>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            ${state.formData.remarks ? `
                                <div>
                                    <div class="bg-yellow-50 p-2 rounded-lg border border-yellow-200 text-sm whitespace-pre-wrap">${state.formData.remarks}</div>
                                </div>
                            ` : ''}
                            ${state.formData.images && state.formData.images.length > 0 ? `
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">ãƒ¡ãƒ‡ã‚£ã‚¢ï¼ˆ${state.formData.images.length}å€‹ï¼‰</div>
                                    <div class="grid grid-cols-3 gap-2">
                                        ${state.formData.images.map((file, index) => `
                                            <div class="relative group">
                                                ${file.type === 'image' ? `
                                                    <img src="${file.data}" alt="ç”»åƒ ${index + 1}" class="w-full h-24 object-cover rounded-lg border border-gray-200">
                                                ` : `
                                                    <video src="${file.data}" class="w-full h-24 object-cover rounded-lg border border-gray-200" controls></video>
                                                `}
                                                <button onclick="downloadImage({data: state.formData.images[${index}].data, type: state.formData.images[${index}].type}, \`${state.formData.title || 'media'}\`, ${index})" class="absolute bottom-1 right-1 bg-blue-500 text-white px-2 py-0.5 rounded-lg hover:bg-blue-600 transition-colors shadow-lg text-xs">
                                                    â¬‡
                                                </button>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            <div>
                                <div class="flex gap-2 mb-2">
                                    <input type="text" id="checkPersonInput" placeholder="ãƒã‚§ãƒƒã‚¯å®Œäº†ã—ãŸäººã®åå‰ã‚’å…¥åŠ›" class="flex-1 px-3 py-1.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" onkeypress="if(event.key==='Enter'){addCheckPerson(); event.preventDefault();}">
                                    <button onclick="addCheckPerson()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1.5 rounded-lg transition-colors text-xs">
                                        è¿½åŠ 
                                    </button>
                                </div>
                                ${state.formData.checks && state.formData.checks.length > 0 ? `
                                    <div class="flex gap-1 flex-wrap">
                                        ${state.formData.checks.map((person, index) => `
                                            <span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs inline-flex items-center gap-1 border border-green-300">
                                                âœ“ ${person}
                                                <button onclick="removeCheckPerson(${index})" class="text-red-500 hover:text-red-700 font-bold">Ã—</button>
                                            </span>
                                        `).join('')}
                                    </div>
                                ` : '<div class="text-xs text-gray-400">ã¾ã ãƒã‚§ãƒƒã‚¯å®Œäº†è€…ã¯ã„ã¾ã›ã‚“</div>'}
                            </div>
                            <div class="flex gap-2 pt-3 border-t">
                                <button onclick="switchToEditMode()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg font-semibold transition-colors shadow-md text-sm">
                                    âœï¸ ç·¨é›†
                                </button>
                                <button onclick="confirmDelete('${state.selectedDate}', ${state.editingPostId})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg font-semibold transition-colors shadow-md text-sm">
                                    ğŸ—‘
                                </button>
                            </div>
                            ${platforms.includes('x') ? '<div class="pt-2"><button onclick="postToX()" class="w-full bg-black hover:bg-gray-800 text-white py-2 rounded-lg font-semibold transition-colors shadow-md text-sm">ğ• ã«æŠ•ç¨¿</button></div>' : ''}
                            ${platforms.includes('instagram') ? '<div class="pt-2"><button onclick="postToInstagram()" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white py-2 rounded-lg font-semibold transition-colors shadow-md text-sm">Instagram ã«æŠ•ç¨¿ï¼ˆãƒ†ã‚¹ãƒˆå‰ï¼‰</button></div>' : ''}
                        </div>
                    </div>`;
                } else {
                    editFormHTML = `<div class="bg-blue-50 rounded-2xl shadow-xl p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-bold text-gray-800">${state.editingPostId ? 'æŠ•ç¨¿ã‚’ç·¨é›†' : 'æ–°è¦æŠ•ç¨¿'} - ${state.selectedDate}</h3>
                            <button onclick="cancelEdit(); render();" class="p-1 hover:bg-gray-100 rounded-lg transition-colors">
                                <span class="text-xl">Ã—</span>
                            </button>
                        </div>
                        <div class="space-y-3">
                            ${state.editingPostId ? `
                            <div>
                                <label class="block text-xs font-semibold text-gray-700 mb-1">æŠ•ç¨¿æ—¥</label>
                                <input type="date" value="${state.selectedDate}" onchange="changeSelectedDate(this.value)" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                            </div>
                            ` : ''}
                            <div>
                                <label class="block text-xs font-semibold text-gray-700 mb-1">æŠ•ç¨¿ã‚¿ã‚¤ãƒˆãƒ«</label>
                                <input type="text" value="${state.formData.title}" onchange="state.formData.title = this.value" placeholder="ä¾‹: æ–°å•†å“å‘ŠçŸ¥" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-700 mb-1">å•†å“ç•ªå·</label>
                                <div class="flex gap-2 items-center">
                                    <input type="text" value="${state.formData.productNumber || ''}" onchange="state.formData.productNumber = this.value" placeholder="ä¾‹: ABC-12345" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                    <label class="flex items-center gap-1 text-sm whitespace-nowrap">
                                        <input type="checkbox" ${state.formData.embedProduct ? 'checked' : ''} onchange="state.formData.embedProduct = this.checked" class="rounded">
                                        å‹•ç”»åŸ‹è¾¼
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-700 mb-1">æŠ•ç¨¿å…ˆSNSï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
                                <div class="flex gap-2 flex-wrap">
                                    ${[
                                        {value: 'x', label: 'ğ•', color: 'bg-black'},
                                        {value: 'instagram', label: 'IG', color: 'bg-gradient-to-r from-purple-500 to-pink-500'},
                                        {value: 'line', label: 'LINE', color: 'bg-green-500'},
                                        {value: 'stumaga', label: 'ã‚¹ã‚¿ãƒã‚¬', color: 'bg-orange-500'},
                                        {value: 'youtube', label: 'YT', color: 'bg-red-600'}
                                    ].map(platform => `
                                        <button onclick="togglePlatform('${platform.value}')" class="py-1.5 px-3 rounded-lg font-semibold text-white transition-all text-xs ${state.formData.platforms.includes(platform.value) ? `${platform.color} ring-2 ring-offset-2 ring-blue-300` : 'bg-gray-300 hover:bg-gray-400'}">
                                            ${platform.label}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-700 mb-1">æŠ•ç¨¿ãƒ†ã‚­ã‚¹ãƒˆ</label>
                                <textarea onchange="state.formData.text = this.value" placeholder="æŠ•ç¨¿ã™ã‚‹æ–‡ç« ã‚’å…¥åŠ›..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" rows="4">${state.formData.text}</textarea>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-700 mb-1">ãƒªãƒ³ã‚¯å…ˆï¼ˆæœ€å¤§5ã¤ï¼‰</label>
                                ${state.formData.links && state.formData.links.length > 0 ? state.formData.links.map((link, index) => `
                                    <div class="flex gap-2 mb-2">
                                        <input 
                                            type="url" 
                                            value="${link}" 
                                            onchange="state.formData.links[${index}] = this.value" 
                                            placeholder="https://example.com" 
                                            class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                        >
                                        ${state.formData.links.length > 1 ? `
                                            <button onclick="removeLink(${index})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg transition-colors text-xs">
                                                Ã—
                                            </button>
                                        ` : ''}
                                        ${index === state.formData.links.length - 1 && state.formData.links.length < 5 ? `
                                            <button onclick="addLink()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1.5 rounded-lg transition-colors text-xs whitespace-nowrap">
                                                + ãƒªãƒ³ã‚¯ã‚’è¿½åŠ 
                                            </button>
                                        ` : ''}
                                    </div>
                                `).join('') : `
                                    <div class="flex gap-2 mb-2">
                                        <input 
                                            type="url" 
                                            value="" 
                                            onchange="if(!state.formData.links) state.formData.links = []; state.formData.links[0] = this.value" 
                                            placeholder="https://example.com" 
                                            class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                        >
                                        <button onclick="addLink()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1.5 rounded-lg transition-colors text-xs whitespace-nowrap">
                                            + ãƒªãƒ³ã‚¯ã‚’è¿½åŠ 
                                        </button>
                                    </div>
                                `}
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-700 mb-1">å‚™è€ƒ</label>
                                <textarea onchange="state.formData.remarks = this.value" placeholder="ãƒ¡ãƒ¢ã‚„å‚™è€ƒã‚’å…¥åŠ›..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" rows="2">${state.formData.remarks || ''}</textarea>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-700 mb-1">ç”»åƒï¼ˆæœ€å¤§20æšï¼‰<span class="ml-2 text-xs text-gray-500">${state.formData.images.length} / 20</span></label>
                                <div class="border-2 border-dashed rounded-lg p-3 text-center border-gray-300 hover:border-blue-400">
                                    ${state.formData.images.length > 0 ? `
                                        <div>
                                            <div class="grid grid-cols-3 gap-2 mb-2">
                                                ${state.formData.images.map((image, index) => `
                                                    <div class="relative group">
                                                        ${image.type === 'image' ? `
                                                            <img src="${image.data}" alt="ç”»åƒ ${index + 1}" class="w-full h-20 object-cover rounded-lg">
                                                        ` : `
                                                            <video src="${image.data}" class="w-full h-20 object-cover rounded-lg" controls></video>
                                                        `}
                                                        <button onclick="removeImage(${index})" class="absolute top-1 right-1 bg-red-500 text-white p-1 rounded-full hover:bg-red-600 transition-colors shadow-lg opacity-0 group-hover:opacity-100 text-xs leading-none w-5 h-5 flex items-center justify-center">
                                                            Ã—
                                                        </button>
                                                    </div>
                                                `).join('')}
                                            </div>
                                            ${state.formData.images.length < 20 ? `
                                                <label class="inline-block bg-blue-500 hover:bg-blue-600 text-white px-3 py-1.5 rounded-lg cursor-pointer transition-colors text-xs">
                                                    + ã•ã‚‰ã«è¿½åŠ 
                                                    <input type="file" accept="image/*,video/*" multiple onchange="handleImageSelect(event)" class="hidden">
                                                </label>
                                            ` : ''}
                                        </div>
                                    ` : `
                                        <div>
                                            <label class="inline-block bg-blue-500 hover:bg-blue-600 text-white px-3 py-1.5 rounded-lg cursor-pointer transition-colors text-xs">
                                                ğŸ“¸ ç”»åƒã‚’é¸æŠ
                                                <input type="file" accept="image/*,video/*" multiple onchange="handleImageSelect(event)" class="hidden">
                                            </label>
                                        </div>
                                    `}
                                </div>
                            </div>
                            <div class="flex gap-2 pt-2">
                                <button onclick="savePost()" ${state.isSaving ? 'disabled' : ''} class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg font-semibold transition-colors text-sm ${state.isSaving ? 'opacity-50 cursor-not-allowed' : ''}">
                                    ${state.isSaving ? 'â³ ä¿å­˜ä¸­...' : (state.editingPostId ? 'æ›´æ–°' : 'ä¿å­˜')}
                                </button>
                            </div>
                        </div>
                    </div>`;
                }
            }

            document.getElementById('app').innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-3">
                        <h1 class="text-3xl font-bold text-gray-800">ğŸ“± SNSæŠ•ç¨¿ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h1>
                        <button onclick="exportToSpreadsheet()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg transition-colors text-xs flex items-center gap-1">
                            ğŸ“Š ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆåŒæœŸ
                        </button>
                    </div>
                    <div class="flex flex-col items-end gap-1">
                        ${state.isSignedIn ? `
                            <div class="flex items-center gap-2">
                                ${state.userName ? `<div class="text-xs text-gray-600">ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${state.userName}</div>` : ''}
                                <div class="inline-flex items-center gap-2 bg-green-100 text-green-700 px-3 py-1 rounded-lg text-xs">
                                    âœ… å…±æœ‰ãƒ‰ãƒ©ã‚¤ãƒ–æ¥ç¶šæ¸ˆ
                                </div>
                                <button onclick="handleSignOut()" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded-lg text-xs transition-colors">
                                    ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                                </button>
                            </div>
                        ` : `
                            <button onclick="handleAuthClick()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-semibold transition-colors shadow-lg text-sm">
                                ğŸ”— Google Driveã«æ¥ç¶š
                            </button>
                        `}
                        <div class="text-xs text-gray-400">
                            ${state.lastUpdated ? `æœ€çµ‚æ›´æ–°: ${formatDateTime(state.lastUpdated)}ã€€` : ''}ã‚¢ãƒ—ãƒªæ›´æ–°: ${APP_VERSION}
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <div class="lg:col-span-2">
                        <div class="bg-white rounded-2xl shadow-xl p-6">
                            <div class="flex items-center justify-between mb-6">
                                <button onclick="changeMonth(-1)" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                                    â—€
                                </button>
                                <div class="flex items-center gap-3">
                                    <h2 class="text-2xl font-bold text-gray-800">${monthName}</h2>
                                    <button onclick="goToToday()" class="px-3 py-1 text-sm bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors">
                                        æœ¬æ—¥
                                    </button>
                                </div>
                                <button onclick="changeMonth(1)" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                                    â–¶
                                </button>
                            </div>
                            <div class="grid grid-cols-7 gap-2">
                                ${calendarHTML}
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-1">
                        ${editFormHTML || '<div class="bg-gray-50 rounded-2xl shadow-xl p-6 text-center text-gray-500">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„</div>'}
                    </div>
                </div>
            `;
        }

        window.addEventListener('load', () => {
            gapiLoaded();
            gisLoaded();
            
            // 30åˆ†ã”ã¨ã«ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æ€§ã‚’ãƒã‚§ãƒƒã‚¯
            setInterval(async () => {
                if (state.isSignedIn) {
                    await refreshTokenIfNeeded();
                }
            }, 1800000); // 1800000ms = 30åˆ†
            
            // 3åˆ†ã”ã¨ã«æ›´æ–°ã‚’ãƒã‚§ãƒƒã‚¯
            setInterval(async () => {
                if (state.isSignedIn && !state.isSaving) {
                    await checkForUpdates();
                }
            }, 180000); // 180000ms = 3åˆ†
        });
    </script>
</body>
</html>
