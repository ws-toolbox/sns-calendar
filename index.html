<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SNSæŠ•ç¨¿ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç®¡ç†</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body class="bg-gradient-to-br from-purple-50 to-blue-50 min-h-screen">
  <div id="app" class="max-w-[1920px] mx-auto p-6"></div>

  <script>
    const CLIENT_ID = '417822818519-8imosvo7c9e2gem7cp0rse0vm8vrjlou.apps.googleusercontent.com';
    const SCOPES = 'https://www.googleapis.com/auth/drive';
    const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
    const FILE_NAME = 'sns_calendar_data.json';
    const FOLDER_NAME = 'SNSæŠ•ç¨¿ç®¡ç†';
    const SHARED_DRIVE_ID = '1-ri6H6rEmyhBb6GRKKlpMgnIP9SbDBaL';
    const APP_VERSION = '2025/01/15 16:40'; // ã‚¢ãƒ—ãƒªã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ—¥æ™‚

    let gapiInited = false;
    let gisInited = false;
    let tokenClient;
    let accessToken = null;
    let fileId = null;

    // ã‚¢ãƒ—ãƒªã®çŠ¶æ…‹
    let state = {
      currentDate: new Date(),
      posts: {},
      selectedDate: null,
      editingPostId: null,
      viewMode: 'edit', // 'edit' or 'view'
      isSignedIn: false,
      isSaving: false, // ä¿å­˜ä¸­ãƒ•ãƒ©ã‚°
      folderId: null,
      lastUpdated: null,
      formData: {
        title: '',
        platform: 'x',
        text: '',
        images: []
      }
    };

    // GAPIåˆæœŸåŒ–
    function gapiLoaded() {
      gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
      await gapi.client.init({
        discoveryDocs: [DISCOVERY_DOC],
      });
      gapiInited = true;
      maybeEnableButtons();
    }

    // GISåˆæœŸåŒ–
    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: '',
      });
      gisInited = true;
      maybeEnableButtons();
    }

    function maybeEnableButtons() {
      if (gapiInited && gisInited) {
        tryAutoSignIn();
      }
    }

    // Google Driveèªè¨¼
    function handleAuthClick() {
      tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) {
          throw (resp);
        }
        accessToken = gapi.client.getToken().access_token;
        state.isSignedIn = true;
        
        // ãƒˆãƒ¼ã‚¯ãƒ³ã‚’localStorageã«ä¿å­˜
        localStorage.setItem('google_access_token', JSON.stringify(gapi.client.getToken()));
        
        await loadFromDrive();
        render();
      };

      if (gapi.client.getToken() === null) {
        tokenClient.requestAccessToken({prompt: 'consent'});
      } else {
        tokenClient.requestAccessToken({prompt: ''});
      }
    }

    // ä¿å­˜ã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã§è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³
    async function tryAutoSignIn() {
      const savedToken = localStorage.getItem('google_access_token');
      if (savedToken) {
        try {
          const token = JSON.parse(savedToken);
          gapi.client.setToken(token);
          accessToken = token.access_token;
          
          // ãƒˆãƒ¼ã‚¯ãƒ³ãŒæœ‰åŠ¹ã‹ç¢ºèª
          await gapi.client.drive.files.list({ pageSize: 1 });
          
          state.isSignedIn = true;
          await loadFromDrive();
          render();
        } catch (error) {
          console.log('Saved token expired, need to re-authenticate');
          localStorage.removeItem('google_access_token');
          render();
        }
      }
    }

    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½
    function handleSignOut() {
      gapi.client.setToken(null);
      localStorage.removeItem('google_access_token');
      accessToken = null;
      state.isSignedIn = false;
      state.posts = {};
      state.folderId = null;
      fileId = null;
      render();
      showMessage('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ', 'success');
    }

    // Google Driveã‹ã‚‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    async function loadFromDrive() {
      try {
        let folderId = null;
        
        // ã¾ãšã€ãƒã‚¤ãƒ‰ãƒ©ã‚¤ãƒ–å†…ã®ã€ŒSNSæŠ•ç¨¿ç®¡ç†ã€ãƒ•ã‚©ãƒ«ãƒ€ã‚’æ¤œç´¢
        const myDriveFolderResponse = await gapi.client.drive.files.list({
          q: `name='${FOLDER_NAME}' and mimeType='application/vnd.google-apps.folder' and trashed=false and 'me' in owners`,
          fields: 'files(id, name)',
          spaces: 'drive'
        });

        if (myDriveFolderResponse.result.files && myDriveFolderResponse.result.files.length > 0) {
          folderId = myDriveFolderResponse.result.files[0].id;
          console.log('Found folder in My Drive');
        } else {
          // ãƒã‚¤ãƒ‰ãƒ©ã‚¤ãƒ–ã«ãªã‘ã‚Œã°ã€å…±æœ‰ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ¤œç´¢
          const sharedFolderResponse = await gapi.client.drive.files.list({
            q: `name='${FOLDER_NAME}' and mimeType='application/vnd.google-apps.folder' and trashed=false and sharedWithMe=true`,
            fields: 'files(id, name, owners)',
            spaces: 'drive'
          });

          if (sharedFolderResponse.result.files && sharedFolderResponse.result.files.length > 0) {
            folderId = sharedFolderResponse.result.files[0].id;
            const ownerName = sharedFolderResponse.result.files[0].owners?.[0]?.displayName || 'ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼';
            console.log('Found shared folder');
            showMessage(`${ownerName}ã•ã‚“ãŒå…±æœ‰ã—ã¦ã„ã‚‹ã€ŒSNSæŠ•ç¨¿ç®¡ç†ã€ãƒ•ã‚©ãƒ«ãƒ€ã«æ¥ç¶šã—ã¾ã—ãŸ`, 'success');
          } else {
            // ã©ã¡ã‚‰ã«ã‚‚ãªã‘ã‚Œã°ã€ãƒã‚¤ãƒ‰ãƒ©ã‚¤ãƒ–ã«æ–°è¦ä½œæˆ
            const folderMetadata = {
              name: FOLDER_NAME,
              mimeType: 'application/vnd.google-apps.folder'
            };
            
            const folderCreateResponse = await gapi.client.drive.files.create({
              resource: folderMetadata,
              fields: 'id'
            });
            
            folderId = folderCreateResponse.result.id;
            showMessage('ãƒã‚¤ãƒ‰ãƒ©ã‚¤ãƒ–ã«ã€ŒSNSæŠ•ç¨¿ç®¡ç†ã€ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¾ã—ãŸ', 'success');
          }
        }

        // ãƒ•ã‚©ãƒ«ãƒ€å†…ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
        const response = await gapi.client.drive.files.list({
          q: `name='${FILE_NAME}' and '${folderId}' in parents and trashed=false`,
          fields: 'files(id, name)',
          spaces: 'drive'
        });

        const files = response.result.files;
        if (files && files.length > 0) {
          fileId = files[0].id;
          const fileContent = await gapi.client.drive.files.get({
            fileId: fileId,
            alt: 'media'
          });
          
          if (fileContent.body) {
            const data = JSON.parse(fileContent.body);
            state.posts = data.posts || {};
            state.lastUpdated = data.lastUpdated || null;
            showMessage('Google Driveã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'success');
          }
        }
        
        // ãƒ•ã‚©ãƒ«ãƒ€IDã‚’ä¿å­˜ï¼ˆå¾Œã§ä¿å­˜æ™‚ã«ä½¿ç”¨ï¼‰
        state.folderId = folderId;
        
      } catch (error) {
        console.error('Error loading from Drive:', error);
        showMessage('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
      }
    }

    // Google Driveã¸ä¿å­˜
    async function saveToDrive() {
      if (!state.isSignedIn) {
        showMessage('å…ˆã«Google Driveã«æ¥ç¶šã—ã¦ãã ã•ã„', 'error');
        return;
      }

      if (!state.folderId) {
        showMessage('ãƒ•ã‚©ãƒ«ãƒ€æƒ…å ±ã®å–å¾—ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„', 'error');
        return;
      }

      if (state.isSaving) {
        return; // æ—¢ã«ä¿å­˜ä¸­ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
      }

      state.isSaving = true;
      render(); // ä¿å­˜ä¸­è¡¨ç¤ºã‚’æ›´æ–°

      try {
        const now = new Date().toISOString();
        const content = JSON.stringify({
          posts: state.posts,
          lastUpdated: now
        });

        const file = new Blob([content], { type: 'application/json' });
        
        // æ–°è¦ä½œæˆã¨æ›´æ–°ã§metadataã‚’åˆ†ã‘ã‚‹
        const metadata = fileId 
          ? { name: FILE_NAME, mimeType: 'application/json' }  // æ›´æ–°æ™‚ã¯parentsã‚’å«ã‚ãªã„
          : { name: FILE_NAME, mimeType: 'application/json', parents: [state.folderId] };  // æ–°è¦ä½œæˆæ™‚ã®ã¿parentsã‚’å«ã‚ã‚‹

        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
        form.append('file', file);

        const url = fileId 
          ? `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart&supportsAllDrives=true`
          : `https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&supportsAllDrives=true`;

        console.log('Saving to Drive, URL:', url);
        console.log('File ID:', fileId);
        console.log('Folder ID:', state.folderId);

        const method = fileId ? 'PATCH' : 'POST';

        const response = await fetch(url, {
          method: method,
          headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
          body: form,
        });

        if (!response.ok) {
          const errorText = await response.text();
          console.error('Save error:', errorText);
          throw new Error(`ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ${response.status}`);
        }

        const result = await response.json();
        if (!fileId) {
          fileId = result.id;
        }

        state.lastUpdated = now;
        showMessage('Google Driveã«ä¿å­˜ã—ã¾ã—ãŸï¼', 'success');
      } catch (error) {
        console.error('Error saving to Drive:', error);
        showMessage('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
      } finally {
        state.isSaving = false;
        render();
      }
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    function showMessage(message, type) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white z-50 ${
        type === 'success' ? 'bg-green-500' : 'bg-red-500'
      }`;
      messageDiv.textContent = message;
      document.body.appendChild(messageDiv);
      setTimeout(() => messageDiv.remove(), 3000);
    }

    // æ—¥æ™‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatDateTime(isoString) {
      if (!isoString) return '';
      const date = new Date(isoString);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${year}/${month}/${day} ${hours}:${minutes}`;
    }

    // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatDate(date) {
      return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
    }

    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æƒ…å ±å–å¾—
    function getDaysInMonth(date) {
      const year = date.getFullYear();
      const month = date.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      return {
        daysInMonth: lastDay.getDate(),
        startingDayOfWeek: firstDay.getDay()
      };
    }

    // æŠ•ç¨¿ä¿å­˜
    async function savePost() {
      if (!state.formData.title && !state.formData.text) return;
      
      const newPost = {
        ...state.formData,
        id: state.editingPostId || Date.now()
      };

      const datePosts = state.posts[state.selectedDate] || [];
      
      if (state.editingPostId) {
        state.posts[state.selectedDate] = datePosts.map(p => 
          p.id === state.editingPostId ? newPost : p
        );
      } else {
        state.posts[state.selectedDate] = [...datePosts, newPost];
      }
      
      await saveToDrive();
      cancelEdit();
      render();
    }

    // ç·¨é›†ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    function cancelEdit() {
      state.selectedDate = null;
      state.editingPostId = null;
      state.viewMode = 'edit';
      state.formData = {
        title: '',
        platform: 'x',
        text: '',
        images: []
      };
    }

    // æŠ•ç¨¿å‰Šé™¤
    async function deletePost(dateStr, postId) {
      const datePosts = state.posts[dateStr].filter(p => p.id !== postId);
      if (datePosts.length === 0) {
        delete state.posts[dateStr];
      } else {
        state.posts[dateStr] = datePosts;
      }
      await saveToDrive();
      cancelEdit();
      render();
    }

    // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º
    function openEditForm(day, postId = null) {
      const dateStr = formatDate(new Date(state.currentDate.getFullYear(), state.currentDate.getMonth(), day));
      state.selectedDate = dateStr;
      
      if (postId && state.posts[dateStr]) {
        const post = state.posts[dateStr].find(p => p.id === postId);
        if (post) {
          state.formData = { ...post };
          state.editingPostId = postId;
          state.viewMode = 'view'; // ç™»éŒ²æ¸ˆã¿æŠ•ç¨¿ã‚’é–‹ã„ãŸå ´åˆã¯é–²è¦§ãƒ¢ãƒ¼ãƒ‰
        }
      } else {
        state.formData = {
          title: '',
          platform: 'x',
          text: '',
          images: []
        };
        state.editingPostId = null;
        state.viewMode = 'edit'; // æ–°è¦ä½œæˆã®å ´åˆã¯ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
      }
      
      render();
    }
    
    // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
    function switchToEditMode() {
      state.viewMode = 'edit';
      render();
    }

    // ç”»åƒå‡¦ç†
    function handleImageSelect(e) {
      const files = Array.from(e.target.files);
      if (files.length === 0) return;
      
      const remainingSlots = 5 - state.formData.images.length;
      const filesToProcess = files.slice(0, remainingSlots);
      
      let processed = 0;
      const newImages = [];
      
      filesToProcess.forEach(file => {
        const reader = new FileReader();
        reader.onload = (event) => {
          newImages.push(event.target.result);
          processed++;
          
          if (processed === filesToProcess.length) {
            state.formData.images = [...state.formData.images, ...newImages];
            render();
          }
        };
        reader.readAsDataURL(file);
      });
    }

    function removeImage(index) {
      state.formData.images = state.formData.images.filter((_, i) => i !== index);
      render();
    }

    function downloadImage(imageData, title, index) {
      const link = document.createElement('a');
      link.href = imageData;
      link.download = `${title || 'image'}_${index + 1}.png`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        showMessage('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼', 'success');
      });
    }

    // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function render() {
      const { daysInMonth, startingDayOfWeek } = getDaysInMonth(state.currentDate);
      const monthName = state.currentDate.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long' });
      const today = new Date();
      const isCurrentMonth = state.currentDate.getMonth() === today.getMonth() && 
                            state.currentDate.getFullYear() === today.getFullYear();

      const platformBadges = {
        x: { label: 'ğ•', color: 'bg-black' },
        instagram: { label: 'IG', color: 'bg-gradient-to-r from-purple-500 to-pink-500' },
        line: { label: 'LINE', color: 'bg-green-500' }
      };

      let calendarHTML = '';
      const weekDays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
      
      weekDays.forEach(day => {
        calendarHTML += `<div class="text-center font-bold text-gray-600 py-2">${day}</div>`;
      });

      for (let i = 0; i < startingDayOfWeek; i++) {
        calendarHTML += '<div class="p-2"></div>';
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = formatDate(new Date(state.currentDate.getFullYear(), state.currentDate.getMonth(), day));
        const dayPosts = state.posts[dateStr] || [];
        const hasPosts = dayPosts.length > 0;
        const isToday = isCurrentMonth && day === today.getDate();

        calendarHTML += `
          <div class="p-2 min-h-24 border rounded-lg transition-all ${
            isToday 
              ? 'bg-yellow-100 border-yellow-400 ring-2 ring-yellow-300' 
              : hasPosts 
                ? 'bg-blue-50 border-blue-300' 
                : 'bg-white border-gray-200 hover:border-blue-200'
          }">
            <div class="font-semibold mb-2 ${isToday ? 'text-yellow-700' : 'text-gray-700'}">
              ${day}${isToday ? '<span class="ml-1 text-xs">â—</span>' : ''}
            </div>
            <div class="space-y-1">
              ${dayPosts.map(post => {
                const badge = platformBadges[post.platform];
                return `
                  <div onclick="openEditForm(${day}, ${post.id})" 
                       class="text-xs bg-white p-2 rounded border border-gray-200 hover:border-blue-400 cursor-pointer transition-all hover:shadow-sm">
                    <div class="flex items-center gap-1">
                      <span class="${badge.color} text-white px-1.5 py-0.5 rounded text-[10px]">${badge.label}</span>
                      <span class="font-semibold text-gray-700 truncate">${post.title || 'ç„¡é¡Œ'}</span>
                    </div>
                  </div>
                `;
              }).join('')}
              <button onclick="openEditForm(${day})" 
                      class="w-full text-xs text-blue-500 hover:text-blue-700 py-1 flex items-center justify-center gap-1 hover:bg-blue-50 rounded transition-colors">
                <span>+</span> è¿½åŠ 
              </button>
            </div>
          </div>
        `;
      }

      let editFormHTML = '';
      if (state.selectedDate) {
        const platformButtons = [
          { value: 'x', label: 'ğ•', color: 'bg-black' },
          { value: 'instagram', label: 'Instagram', color: 'bg-gradient-to-r from-purple-500 to-pink-500' },
          { value: 'line', label: 'LINE', color: 'bg-green-500' }
        ];

        if (state.viewMode === 'view') {
          // é–²è¦§ãƒ¢ãƒ¼ãƒ‰
          const badge = platformBadges[state.formData.platform];
          editFormHTML = `
            <div class="bg-white rounded-2xl shadow-xl p-6">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800">æŠ•ç¨¿è©³ç´°</h3>
                <button onclick="cancelEdit(); render();" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                  <span class="text-2xl">Ã—</span>
                </button>
              </div>

              <div class="space-y-4">
                <div>
                  <div class="text-sm text-gray-500 mb-1">æŠ•ç¨¿æ—¥</div>
                  <div class="font-semibold text-gray-800">${state.selectedDate}</div>
                </div>

                <div>
                  <div class="text-sm text-gray-500 mb-1">ã‚¿ã‚¤ãƒˆãƒ«</div>
                  <div class="font-semibold text-gray-800">${state.formData.title || 'ç„¡é¡Œ'}</div>
                </div>

                <div>
                  <div class="text-sm text-gray-500 mb-1">æŠ•ç¨¿å…ˆ</div>
                  <span class="${badge.color} text-white px-3 py-1 rounded text-sm">${badge.label}</span>
                </div>

                <div>
                  <div class="text-sm text-gray-500 mb-1">æŠ•ç¨¿ãƒ†ã‚­ã‚¹ãƒˆ</div>
                  <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 whitespace-pre-wrap">${state.formData.text || 'ãƒ†ã‚­ã‚¹ãƒˆãªã—'}</div>
                  <button onclick="copyToClipboard(state.formData.text)"
                          class="mt-2 w-full flex items-center justify-center gap-2 bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition-colors">
                    ğŸ“‹ ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼
                  </button>
                </div>

                ${state.formData.images && state.formData.images.length > 0 ? `
                  <div>
                    <div class="text-sm text-gray-500 mb-2">ç”»åƒï¼ˆ${state.formData.images.length}æšï¼‰</div>
                    <div class="grid grid-cols-2 gap-3">
                      ${state.formData.images.map((image, index) => `
                        <div class="relative">
                          <img src="${image}" alt="ç”»åƒ ${index + 1}" class="w-full h-40 object-cover rounded-lg border border-gray-200">
                          <button onclick="downloadImage('${image}', state.formData.title, ${index})"
                                  class="absolute bottom-2 right-2 bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600 transition-colors shadow-lg text-sm">
                            â¬‡ ä¿å­˜
                          </button>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                ` : ''}

                <div class="flex gap-3 pt-4 border-t">
                  <button onclick="switchToEditMode()"
                          class="flex-1 bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg font-semibold transition-colors">
                    âœï¸ ç·¨é›†
                  </button>
                  <button onclick="deletePost('${state.selectedDate}', ${state.editingPostId})"
                          class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                    ğŸ—‘ å‰Šé™¤
                  </button>
                </div>
              </div>
            </div>
          `;
        } else {
          // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
          editFormHTML = `
            <div class="bg-white rounded-2xl shadow-xl p-6">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800">
                  ${state.editingPostId ? 'æŠ•ç¨¿ã‚’ç·¨é›†' : 'æ–°è¦æŠ•ç¨¿'} - ${state.selectedDate}
                </h3>
                <button onclick="cancelEdit(); render();" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                  <span class="text-2xl">Ã—</span>
                </button>
              </div>

              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">æŠ•ç¨¿ã‚¿ã‚¤ãƒˆãƒ«</label>
                  <input type="text" id="titleInput" value="${state.formData.title}" 
                         onchange="state.formData.title = this.value"
                         placeholder="ä¾‹: æ–°å•†å“å‘ŠçŸ¥"
                         class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">æŠ•ç¨¿å…ˆSNS</label>
                  <div class="flex gap-2">
                    ${platformButtons.map(platform => `
                      <button onclick="state.formData.platform = '${platform.value}'; render();"
                              class="flex-1 py-2 px-3 rounded-lg font-semibold text-white transition-all text-sm ${
                                state.formData.platform === platform.value
                                  ? `${platform.color} ring-2 ring-offset-2 ring-blue-300`
                                  : 'bg-gray-300 hover:bg-gray-400'
                              }">
                        ${platform.label}
                      </button>
                    `).join('')}
                  </div>
                </div>

                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">æŠ•ç¨¿ãƒ†ã‚­ã‚¹ãƒˆ</label>
                  <textarea id="textInput" onchange="state.formData.text = this.value"
                            placeholder="æŠ•ç¨¿ã™ã‚‹æ–‡ç« ã‚’å…¥åŠ›...&#10;&#10;ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚‚ã“ã“ã«ç›´æ¥è¨˜è¿°ã§ãã¾ã™ï¼"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            rows="6">${state.formData.text}</textarea>
                </div>

                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    ç”»åƒï¼ˆæœ€å¤§5æšï¼‰
                    <span class="ml-2 text-xs text-gray-500">${state.formData.images.length} / 5</span>
                  </label>
                  <div class="border-2 border-dashed rounded-lg p-4 text-center border-gray-300 hover:border-blue-400">
                    ${state.formData.images.length > 0 ? `
                      <div>
                        <div class="grid grid-cols-3 gap-2 mb-3">
                          ${state.formData.images.map((image, index) => `
                            <div class="relative group">
                              <img src="${image}" alt="ç”»åƒ ${index + 1}" class="w-full h-24 object-cover rounded-lg">
                              <button onclick="removeImage(${index})"
                                      class="absolute top-1 right-1 bg-red-500 text-white p-1 rounded-full hover:bg-red-600 transition-colors shadow-lg opacity-0 group-hover:opacity-100">
                                Ã—
                              </button>
                            </div>
                          `).join('')}
                        </div>
                        ${state.formData.images.length < 5 ? `
                          <label class="inline-block bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg cursor-pointer transition-colors text-sm">
                            + ã•ã‚‰ã«è¿½åŠ 
                            <input type="file" accept="image/*" multiple onchange="handleImageSelect(event)" class="hidden">
                          </label>
                        ` : ''}
                      </div>
                    ` : `
                      <div>
                        <p class="text-gray-600 mb-2 text-sm">ğŸ“¸ ç”»åƒã‚’é¸æŠ</p>
                        <label class="inline-block bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg cursor-pointer transition-colors text-sm">
                          ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                          <input type="file" accept="image/*" multiple onchange="handleImageSelect(event)" class="hidden">
                        </label>
                      </div>
                    `}
                  </div>
                </div>

                <div class="flex gap-3 pt-2">
                  <button onclick="savePost()" 
                          ${state.isSaving ? 'disabled' : ''}
                          class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg font-semibold transition-colors ${state.isSaving ? 'opacity-50 cursor-not-allowed' : ''}">
                    ${state.isSaving ? 'â³ ä¿å­˜ä¸­...' : (state.editingPostId ? 'æ›´æ–°' : 'ä¿å­˜')}
                  </button>
                </div>
              </div>
            </div>
          `;
        }
      }

      document.getElementById('app').innerHTML = `
        <div class="flex items-center justify-between mb-4">
          <h1 class="text-4xl font-bold text-gray-800">ğŸ“± SNSæŠ•ç¨¿ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h1>
          <div class="text-right text-xs text-gray-400">
            ã‚¢ãƒ—ãƒªæ›´æ–°: ${APP_VERSION}
          </div>
        </div>
        
        ${state.lastUpdated ? `
          <div class="text-right text-sm text-gray-500 mb-2">
            ãƒ‡ãƒ¼ã‚¿æœ€çµ‚æ›´æ–°: ${formatDateTime(state.lastUpdated)}
          </div>
        ` : ''}
        
        <div class="mb-4 text-center">
          ${!state.isSignedIn ? `
            <button onclick="handleAuthClick()" 
                    class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors shadow-lg">
              ğŸ”— Google Driveã«æ¥ç¶š
            </button>
            <p class="text-sm text-gray-600 mt-2">ãƒ‡ãƒ¼ã‚¿ã‚’Google Driveã«è‡ªå‹•ä¿å­˜ã—ã¾ã™</p>
          ` : `
            <div class="inline-flex items-center gap-4">
              <div class="inline-flex items-center gap-2 bg-green-100 text-green-700 px-4 py-2 rounded-lg">
                âœ… Google Driveã«æ¥ç¶šæ¸ˆã¿ - è‡ªå‹•ä¿å­˜ãŒæœ‰åŠ¹ã§ã™
              </div>
              <button onclick="handleSignOut()" 
                      class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
              </button>
            </div>
          `}
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="lg:col-span-2">
            <div class="bg-white rounded-2xl shadow-xl p-6">
              <div class="flex items-center justify-between mb-6">
                <button onclick="state.currentDate.setMonth(state.currentDate.getMonth() - 1); render();" 
                        class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                  â—€
                </button>
                <h2 class="text-2xl font-bold text-gray-800">${monthName}</h2>
                <button onclick="state.currentDate.setMonth(state.currentDate.getMonth() + 1); render();" 
                        class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                  â–¶
                </button>
              </div>

              <div class="grid grid-cols-7 gap-2">
                ${calendarHTML}
              </div>
            </div>
          </div>

          <div class="lg:col-span-1">
            ${editFormHTML || '<div class="bg-gray-50 rounded-2xl shadow-xl p-6 text-center text-gray-500">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„</div>'}
          </div>
        </div>
      `;
    }

    // åˆæœŸåŒ–
    window.addEventListener('load', () => {
      gapiLoaded();
      gisLoaded();
      render();
    });
  </script>
</body>
</html>
