<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SNSÊäïÁ®ø„Ç´„É¨„É≥„ÉÄ„ÉºÁÆ°ÁêÜ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
</head>
<body class="bg-gradient-to-br from-purple-50 to-blue-50 min-h-screen">
    <div id="app" class="max-w-[1920px] mx-auto p-6"></div>

    <script>
        const CLIENT_ID = '417822818519-8imosvo7c9e2gem7cp0rse0vm8vrjlou.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/drive';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const FILE_NAME = getCurrentYearFileName();
        const FOLDER_NAME = 'SNSÊäïÁ®øÁÆ°ÁêÜ';
        const SHARED_DRIVE_ID = '0AHJk3pS7tSEgUk9PVA';
        const TARGET_FOLDER_ID = '1I23qmcfZ_x8c15NtW54vjhKQb7waJi-E';
        const APP_VERSION = '2025/01/15 15:10';

        let gapiInited = false;
        let gisInited = false;
        let tokenClient;
        let accessToken = null;
        let fileId = null;

        let state = {
            currentDate: new Date(),
            posts: {},
            selectedDate: null,
            editingPostId: null,
            viewMode: 'edit',
            isSignedIn: false,
            isSaving: false,
            folderId: null,
            lastUpdated: null,
            formData: {title: '', platforms: [], text: '', images: [], checks: [], completedChecks: []}
        };

        function getCurrentYearFileName() {
            const currentYear = new Date().getFullYear();
            return `sns_calendar_data_${currentYear}.json`;
        }

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                discoveryDocs: [DISCOVERY_DOC]
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        async function uploadMediaToDrive(file) {
            if (!state.isSignedIn) return null;
        
            try {
                const metadata = {
                    name: file.name,
                    parents: [VIDEO_FOLDER_ID] // ÂãïÁîªÁî®„ÅÆ„Éï„Ç©„É´„ÉÄID„ÇíÂÆöÁæ©
                };
        
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', file);
        
                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&supportsAllDrives=true', {
                    method: 'POST',
                    headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
                    body: form
                });
        
                if (!response.ok) {
                    throw new Error(`„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Å´Â§±Êïó: ${response.status}`);
                }
        
                const result = await response.json();
                return result.id; // „Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Åü„Éï„Ç°„Ç§„É´„ÅÆID
            } catch (error) {
                console.error('„É°„Éá„Ç£„Ç¢„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Ç®„É©„Éº:', error);
                showMessage('„É°„Éá„Ç£„Ç¢„ÅÆ„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Å´Â§±Êïó', 'error');
                return null;
            }
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: ''
            });
            gisInited = true;
            maybeEnableButtons();
        }
        
        // Êñ∞„Åó„ÅÑÈñ¢Êï∞„ÇíËøΩÂä†
        async function ensureMediaFolderExists() {
            if (!state.isSignedIn) return;
        
            try {
                const folderResponse = await gapi.client.drive.files.list({
                    q: `name='${VIDEO_MEDIA_FOLDER_NAME}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                    spaces: 'drive',
                    supportsAllDrives: true
                });
        
                if (folderResponse.result.files && folderResponse.result.files.length > 0) {
                    VIDEO_FOLDER_ID = folderResponse.result.files[0].id;
                } else {
                    const folderCreateResponse = await gapi.client.drive.files.create({
                        resource: {
                            name: VIDEO_MEDIA_FOLDER_NAME,
                            mimeType: 'application/vnd.google-apps.folder'
                        },
                        fields: 'id'
                    });
                    VIDEO_FOLDER_ID = folderCreateResponse.result.id;
                }
            } catch (error) {
                console.error('„É°„Éá„Ç£„Ç¢„Éï„Ç©„É´„ÉÄ‰ΩúÊàê„Ç®„É©„Éº:', error);
            }
        }

        function addVideoPath() {
            if (!state.formData.videoPaths) {
                state.formData.videoPaths = [];
            }
            
            if (state.formData.videoPaths.length < 3) {
                state.formData.videoPaths.push({
                    name: `ÂãïÁîª ${state.formData.videoPaths.length + 1}`,
                    path: '',
                    uploadDate: new Date().toISOString()
                });
                render();
            } else {
                showMessage('ÂãïÁîª„Éë„Çπ„ÅØÊúÄÂ§ß3„Å§„Åæ„ÅßËøΩÂä†„Åß„Åç„Åæ„Åô', 'error');
            }
        }
        
        // handleAuthClickÈñ¢Êï∞„ÅÆ‰øÆÊ≠£
        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                accessToken = gapi.client.getToken().access_token;
                state.isSignedIn = true;
                localStorage.setItem('google_access_token', JSON.stringify(gapi.client.getToken()));
                await ensureMediaFolderExists(); // „Éï„Ç©„É´„ÉÄ‰ΩúÊàêÂá¶ÁêÜ„ÇíËøΩÂä†
                await loadFromDrive();
                render();
            };
        
            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }
        
        // Èñ¢Êï∞ËøΩÂä†„ÅÆÂâç„Å´„ÄÅ„Åì„Çå„Çâ„ÅÆÂÆöÊï∞„ÇíËøΩÂä†
        const VIDEO_MEDIA_FOLDER_NAME = 'SNSÊäïÁ®ø„É°„Éá„Ç£„Ç¢';
        let VIDEO_FOLDER_ID = null;

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                tryAutoSignIn();
            }
        }

        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                accessToken = gapi.client.getToken().access_token;
                state.isSignedIn = true;
                localStorage.setItem('google_access_token', JSON.stringify(gapi.client.getToken()));
                await loadFromDrive();
                render();
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        async function tryAutoSignIn() {
            const savedToken = localStorage.getItem('google_access_token');
            if (savedToken) {
                try {
                    const token = JSON.parse(savedToken);
                    gapi.client.setToken(token);
                    accessToken = token.access_token;
                    await gapi.client.drive.files.list({
                        pageSize: 1,
                        supportsAllDrives: true
                    });
                    state.isSignedIn = true;
                    await loadFromDrive();
                    render();
                } catch (error) {
                    console.log('Saved token expired');
                    localStorage.removeItem('google_access_token');
                    render();
                }
            } else {
                render();
            }
        }

        function handleSignOut() {
            gapi.client.setToken(null);
            localStorage.removeItem('google_access_token');
            accessToken = null;
            state.isSignedIn = false;
            state.posts = {};
            state.folderId = null;
            fileId = null;
            render();
            showMessage('„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü', 'success');
        }

        async function loadFromDrive() {
            try {
                let folderId = null;
                console.log('üîç ÊåáÂÆö„Éï„Ç©„É´„ÉÄÂÜÖ„ÇíÊ§úÁ¥¢ÈñãÂßã...');
                
                const folderResponse = await gapi.client.drive.files.list({
                    q: `name='${FOLDER_NAME}' and mimeType='application/vnd.google-apps.folder' and trashed=false and '${TARGET_FOLDER_ID}' in parents`,
                    fields: 'files(id, name)',
                    spaces: 'drive',
                    supportsAllDrives: true,
                    includeItemsFromAllDrives: true,
                    corpora: 'drive',
                    driveId: SHARED_DRIVE_ID
                });

                if (folderResponse.result.files && folderResponse.result.files.length > 0) {
                    folderId = folderResponse.result.files[0].id;
                    console.log('‚úÖ ÊåáÂÆö„Éï„Ç©„É´„ÉÄÂÜÖ„Åß„Éï„Ç©„É´„ÉÄÁô∫Ë¶ã');
                    showMessage('ÊåáÂÆö„Éï„Ç©„É´„ÉÄÂÜÖ„ÅÆ„Éï„Ç©„É´„ÉÄ„Å´Êé•Á∂ö„Åó„Åæ„Åó„Åü', 'success');
                } else {
                    console.log('üìù „Éï„Ç©„É´„ÉÄÊú™Áô∫Ë¶ã„ÄÅÊåáÂÆö„Éï„Ç©„É´„ÉÄ„Å´Êñ∞Ë¶è‰ΩúÊàê...');
                    const folderCreateResponse = await gapi.client.drive.files.create({
                        resource: {
                            name: FOLDER_NAME,
                            mimeType: 'application/vnd.google-apps.folder',
                            parents: [TARGET_FOLDER_ID]
                        },
                        supportsAllDrives: true,
                        fields: 'id'
                    });
                    folderId = folderCreateResponse.result.id;
                    console.log('‚úÖ ÊåáÂÆö„Éï„Ç©„É´„ÉÄ„Å´„Éï„Ç©„É´„ÉÄ‰ΩúÊàêÂÆå‰∫Ü');
                    showMessage('ÊåáÂÆö„Éï„Ç©„É´„ÉÄ„Å´„ÄåSNSÊäïÁ®øÁÆ°ÁêÜ„Äç„Éï„Ç©„É´„ÉÄ„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü', 'success');
                }

                const response = await gapi.client.drive.files.list({
                    q: `name='${FILE_NAME}' and '${folderId}' in parents and trashed=false`,
                    fields: 'files(id, name)',
                    spaces: 'drive',
                    supportsAllDrives: true,
                    includeItemsFromAllDrives: true
                });

                const files = response.result.files;
                if (files && files.length > 0) {
                    fileId = files[0].id;
                    const fileContent = await gapi.client.drive.files.get({
                        fileId: fileId,
                        alt: 'media',
                        supportsAllDrives: true
                    });

                    if (fileContent.body) {
                        const data = JSON.parse(fileContent.body);
                        state.posts = data.posts || {};
                        state.lastUpdated = data.lastUpdated || null;
                        console.log('‚úÖ ÂÖ±Êúâ„Éâ„É©„Ç§„Éñ„Åã„Çâ„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÊàêÂäü');
                        showMessage('ÂÖ±Êúâ„Éâ„É©„Ç§„Éñ„Åã„Çâ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü', 'success');
                    }
                }

                state.folderId = folderId;
                console.log('‚úÖ „Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÂÆå‰∫Ü');
            } catch (error) {
                console.error('‚ùå ÂÖ±Êúâ„Éâ„É©„Ç§„ÉñË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                showMessage('„Ç®„É©„Éº: ' + (error.result?.error?.message || error.message), 'error');
            }
        }

      async function saveToDrive() {
            if (!state.isSignedIn || !state.folderId || state.isSaving) return;
            
            state.isSaving = true;
            render();

            try {
                const now = new Date().toISOString();
                const content = JSON.stringify({
                    posts: state.posts,
                    lastUpdated: now
                });

                const file = new Blob([content], { type: 'application/json' });
                const metadata = fileId ? {
                    name: FILE_NAME,
                    mimeType: 'application/json'
                } : {
                    name: FILE_NAME,
                    mimeType: 'application/json',
                    parents: [state.folderId]
                };

                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', file);

                const url = fileId
                    ? `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart&supportsAllDrives=true`
                    : `https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&supportsAllDrives=true`;

                const response = await fetch(url, {
                    method: fileId ? 'PATCH' : 'POST',
                    headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
                    body: form
                });

                if (!response.ok) {
                    throw new Error(`‰øùÂ≠ò„Å´Â§±Êïó: ${response.status}`);
                }

                const result = await response.json();
                if (!fileId) {
                    fileId = result.id;
                }

                state.lastUpdated = now;
                showMessage('ÂÖ±Êúâ„Éâ„É©„Ç§„Éñ„Å´‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ', 'success');
            } catch (error) {
                console.error('‰øùÂ≠ò„Ç®„É©„Éº:', error);
                showMessage('‰øùÂ≠ò„Å´Â§±Êïó: ' + error.message, 'error');
            } finally {
                state.isSaving = false;
                render();
            }
        }

        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white z-50 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            setTimeout(() => messageDiv.remove(), 3000);
        }

        function formatDateTime(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            return `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        }

        function formatDate(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        function getDaysInMonth(date) {
            const year = date.getFullYear();
            const month = date.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            return {
                daysInMonth: lastDay.getDate(),
                startingDayOfWeek: firstDay.getDay()
            };
        }

        async function savePost() {
            if (!state.formData.title && !state.formData.text) return;
         
            // ÁîªÂÉè„Å®ÂãïÁîª„ÇíÂàÜÈõ¢
            const imageFiles = state.formData.images.filter(file => file.type === 'image');
            const videoFiles = state.formData.images.filter(file => file.type === 'video');
         
            const newPost = {
                ...state.formData,
                id: state.editingPostId || Date.now(),
                images: imageFiles.map(file => ({
                    type: file.type,
                    name: file.name,
                    size: file.data ? file.data.length : 0,
                    data: file.data,
                    uploadDate: new Date().toISOString()
                })),
                videoPaths: state.formData.videoPaths ? state.formData.videoPaths.filter(path => path.path.trim() !== '').map(path => ({
                    name: path.name,
                    path: path.path.trim(),
                    uploadDate: new Date().toISOString()
                })) : [],
                checks: state.formData.checks || [],
                completedChecks: state.formData.completedChecks || []
            };
         
            const datePosts = state.posts[state.selectedDate] || [];
            if (state.editingPostId) {
                state.posts[state.selectedDate] = datePosts.map(p => p.id === state.editingPostId ? newPost : p);
            } else {
                state.posts[state.selectedDate] = [...datePosts, newPost];
            }
         
            await saveToDrive();
            cancelEdit();
            render();
        }
        
        function cancelEdit() {
            state.selectedDate = null;
            state.editingPostId = null;
            state.viewMode = 'edit';
            state.formData = {title: '', platforms: [], text: '', images: [], checks: [], completedChecks: []};
        }

        async function deletePost(dateStr, postId) {
            const datePosts = state.posts[dateStr].filter(p => p.id !== postId);
            if (datePosts.length === 0) {
                delete state.posts[dateStr];
            } else {
                state.posts[dateStr] = datePosts;
            }
            await saveToDrive();
            cancelEdit();
            render();
        }

        function openEditForm(day, postId = null) {
            const dateStr = formatDate(new Date(state.currentDate.getFullYear(), state.currentDate.getMonth(), day));
            state.selectedDate = dateStr;

            if (postId && state.posts[dateStr]) {
                const post = state.posts[dateStr].find(p => p.id === postId);
                if (post) {
                    state.formData = { ...post };
                    if (!state.formData.platforms && state.formData.platform) {
                        state.formData.platforms = [state.formData.platform];
                    }
                    if (!state.formData.checks) {
                        state.formData.checks = [];
                    }
                    if (!state.formData.completedChecks) {
                        state.formData.completedChecks = [];
                    }
                    state.editingPostId = postId;
                    state.viewMode = 'view';
                }
            } else {
                state.formData = {title: '', platforms: [], text: '', images: [], checks: []};
                state.editingPostId = null;
                state.viewMode = 'edit';
            }
            render();
        }

        function switchToEditMode() {
            state.viewMode = 'edit';
            render();
        }

        function togglePlatform(platform) {
            if (state.formData.platforms.includes(platform)) {
                state.formData.platforms = state.formData.platforms.filter(p => p !== platform);
            } else {
                state.formData.platforms.push(platform);
            }
            render();
        }

        function handleImageSelect(e) {
            const files = Array.from(e.target.files);
            console.log('ÈÅ∏Êäû„Åï„Çå„Åü„Éï„Ç°„Ç§„É´„ÅÆÊï∞:', files.length);
            
            if (files.length === 0) return;
        
            const remainingSlots = 5 - state.formData.images.length;
            const filesToProcess = files.slice(0, remainingSlots);
            let processed = 0;
            const newFiles = [];
        
            filesToProcess.forEach(file => {
                console.log('Âá¶ÁêÜ„Åô„Çã„Éï„Ç°„Ç§„É´:', file.name, '„Çø„Ç§„Éó:', file.type, '„Çµ„Ç§„Ç∫:', file.size);
        
                // 100MB„ÅÆ„Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫Âà∂Èôê„ÇíËøΩÂä†
                if (file.size > 100 * 1024 * 1024) {
                    showMessage(`„Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÅåÂ§ß„Åç„Åô„Åé„Åæ„Åô: ${file.name} (100MB‰ª•‰∏ã„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ)`, 'error');
                    return;
                }
        
                const reader = new FileReader();
                reader.onload = (event) => {
                    console.log('„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', file.name);
                    console.log('„Éá„Éº„ÇøÈï∑:', event.target.result ? event.target.result.length : '„Éá„Éº„Çø„Å™„Åó');
                    
                    newFiles.push({
                        type: file.type.startsWith('image/') ? 'image' : 'video',
                        data: event.target.result,
                        name: file.name,
                        originalFile: file  // „Ç™„É™„Ç∏„Éä„É´„ÅÆ„Éï„Ç°„Ç§„É´„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Çí‰øùÊåÅ
                    });
                    processed++;
                    if (processed === filesToProcess.length) {
                        state.formData.images = [...state.formData.images, ...newFiles];
                        console.log('ËøΩÂä†Âæå„ÅÆÁîªÂÉèÊï∞:', state.formData.images.length);
                        render();
                    }
                };
                reader.readAsDataURL(file);
            });
        }
        
        // removeImageÈñ¢Êï∞„Çí‰øÆÊ≠£
        function removeImage(index) {
            state.formData.images = state.formData.images.filter((_, i) => i !== index);
            render();
        }
        
        // downloadImageÈñ¢Êï∞„Çí‰øÆÊ≠£„Åó„ÄÅÂãïÁîª„ÇÇ„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÂèØËÉΩ„Å´
        function downloadImage(fileData, title, index) {
            if (!fileData || !fileData.data) {
                console.error('„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åô„Çã„Éï„Ç°„Ç§„É´„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', fileData);
                return;
            }
            const link = document.createElement('a');
            link.href = fileData.data;
            link.download = `${title || 'media'}_${index + 1}${getFileExtension(fileData)}`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function getFileExtension(file) {
            if (file.type === 'image') {
                const match = file.data.match(/^data:image\/([a-zA-Z0-9]+);/);
                return match ? `.${match[1]}` : '.png';
            }
            if (file.type === 'video') {
                const match = file.data.match(/^data:video\/([a-zA-Z0-9]+);/);
                return match ? `.${match[1]}` : '.mp4';
            }
            return '';
        }

        function goToToday() {
            state.currentDate = new Date();
            render();
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showMessage('„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ', 'success');
            });
        }

        function toggleCheckCompletion(checkText) {
            if (!state.formData.completedChecks) {
                state.formData.completedChecks = [];
            }
            
            if (state.formData.completedChecks.includes(checkText)) {
                state.formData.completedChecks = state.formData.completedChecks.filter(c => c !== checkText);
            } else {
                state.formData.completedChecks.push(checkText);
            }
            
            // Ëá™Âãï‰øùÂ≠ò
            saveToDrive();
            render();
        }

        function addViewCheck(inputId) {
            const input = document.getElementById(inputId);
            const value = input.value.trim();
            
            if (!state.formData.checks) {
                state.formData.checks = [];
            }
            
            if (value && !state.formData.checks.includes(value)) {
                state.formData.checks.push(value);
                input.value = '';
                saveToDrive(); // Ëá™Âãï‰øùÂ≠ò
                render();
            }
        }
        
        function removeViewCheck(index) {
            state.formData.checks = state.formData.checks.filter((_, i) => i !== index);
            saveToDrive(); // Ëá™Âãï‰øùÂ≠ò
            render();
        }

      function render() {
            const { daysInMonth, startingDayOfWeek } = getDaysInMonth(state.currentDate);
            const monthName = state.currentDate.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long' });
            const today = new Date();
            const isCurrentMonth = state.currentDate.getMonth() === today.getMonth() && state.currentDate.getFullYear() === today.getFullYear();

            const platformBadges = {
                x: { label: 'ùïè', color: 'bg-black' },
                instagram: { label: 'IG', color: 'bg-gradient-to-r from-purple-500 to-pink-500' },
                line: { label: 'L', color: 'bg-green-500' },
                stumaga: { label: 'M', color: 'bg-orange-500' }
            };

            let calendarHTML = '';
            const weekDays = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
            weekDays.forEach(day => {
                calendarHTML += `<div class="text-center font-bold text-gray-600 py-2">${day}</div>`;
            });

            for (let i = 0; i < startingDayOfWeek; i++) {
                calendarHTML += '<div class="p-2"></div>';
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = formatDate(new Date(state.currentDate.getFullYear(), state.currentDate.getMonth(), day));
                const dayPosts = state.posts[dateStr] || [];
                const isToday = isCurrentMonth && day === today.getDate();

                calendarHTML += `
                    <div class="p-2 min-h-24 border rounded-lg transition-all bg-white border-gray-200 hover:border-blue-200">
                        <div class="font-semibold mb-2 ${isToday ? 'text-blue-600' : 'text-gray-700'}">${day}${isToday ? '<span class="ml-1 text-xs">‚óè</span>' : ''}</div>
                        <div class="space-y-1">
                            ${dayPosts.map(post => {
                                const platforms = post.platforms || [post.platform];
                                return `<div onclick="openEditForm(${day}, ${post.id})" class="text-xs bg-white p-2 rounded border border-gray-200 hover:border-blue-400 cursor-pointer transition-all hover:shadow-sm">
                                    <div class="flex items-center gap-1 flex-wrap">
                                        ${platforms.map(p => {
                                            const badge = platformBadges[p];
                                            return `<span class="${badge.color} text-white px-1 py-0.5 rounded text-[9px]">${badge.label}</span>`;
                                        }).join('')}
                                        <span class="font-semibold text-gray-700 truncate text-[11px]">${post.title || 'ÁÑ°È°å'}</span>
                                    </div>
                                </div>`;
                            }).join('')}
                            <button onclick="openEditForm(${day})" class="w-full text-[11px] text-gray-400 hover:text-gray-600 py-1 flex items-center justify-center gap-1 hover:bg-gray-50 rounded transition-colors">
                                <span>+</span> ËøΩÂä†
                            </button>
                        </div>
                    </div>
                `;
            }

            let editFormHTML = '';
            if (state.selectedDate) {
                const platformButtons = [
                    {value: 'x', label: 'ùïè', color: 'bg-black'},
                    {value: 'instagram', label: 'Instagram', color: 'bg-gradient-to-r from-purple-500 to-pink-500'},
                    {value: 'line', label: 'LINE', color: 'bg-green-500'},
                    {value: 'stumaga', label: '„Çπ„Çø„Éû„Ç¨', color: 'bg-orange-500'}
                ];

                if (state.viewMode === 'view') {
                    const platforms = state.formData.platforms || [state.formData.platform];
                    editFormHTML = `<div class="bg-white rounded-2xl shadow-xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold text-gray-800">ÊäïÁ®øË©≥Á¥∞</h3>
                            <button onclick="cancelEdit(); render();" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                                <span class="text-2xl">√ó</span>
                            </button>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <div class="text-sm text-gray-500 mb-1">ÊäïÁ®øÊó•</div>
                                <div class="font-semibold text-gray-800">${state.selectedDate}</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-500 mb-1">„Çø„Ç§„Éà„É´</div>
                                <div class="font-semibold text-gray-800">${state.formData.title || 'ÁÑ°È°å'}</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-500 mb-1">ÊäïÁ®øÂÖà</div>
                                <div class="flex gap-2 flex-wrap">
                                    ${platforms.map(p => {
                                        const badge = platformBadges[p];
                                        return `<span class="${badge.color} text-white px-3 py-1 rounded text-sm">${badge.label}</span>`;
                                    }).join('')}
                                </div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-500 mb-1">ÊäïÁ®ø„ÉÜ„Ç≠„Çπ„Éà</div>
                                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 whitespace-pre-wrap">${state.formData.text || '„ÉÜ„Ç≠„Çπ„Éà„Å™„Åó'}</div>
                                <button onclick="copyToClipboard(\`${state.formData.text}\`)" class="mt-2 w-full flex items-center justify-center gap-2 bg-gray-100 text-gray-500 py-2 rounded-lg hover:bg-gray-200 transition-colors text-sm">
                                    üìã „ÉÜ„Ç≠„Çπ„Éà„Çí„Ç≥„Éî„Éº
                                </button>
                            </div>
                            ${state.formData.checks && state.formData.checks.length > 0 ? `
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">„ÉÅ„Çß„ÉÉ„ÇØ</label>
                                    <div class="flex gap-2 mb-2">
                                        <input type="text" id="viewCheckInput" placeholder="„ÉÅ„Çß„ÉÉ„ÇØÊ∏à„Åø„ÅÆÂêçÂâç„ÇíÂÖ•Âäõ" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" onkeypress="if(event.key==='Enter'){addViewCheck('viewCheckInput'); event.preventDefault();}">
                                        <button onclick="addViewCheck('viewCheckInput')" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                                            ËøΩÂä†
                                        </button>
                                    </div>
                                    ${state.formData.checks && state.formData.checks.length > 0 ? `
                                        <div class="flex gap-2 flex-wrap">
                                            ${state.formData.checks.map((check, index) => `
                                                <span class="bg-gray-200 text-gray-700 px-3 py-1 rounded text-sm inline-flex items-center gap-2">
                                                    ${check}
                                                    <button onclick="removeViewCheck(${index})" class="text-red-500 hover:text-red-700 font-bold">√ó</button>
                                                </span>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}
                            ${state.formData.images && state.formData.images.length > 0 ? `
                                <div>
                                    <div class="text-sm text-gray-500 mb-2">„É°„Éá„Ç£„Ç¢Ôºà${state.formData.images.length}Êûö/ÂãïÁîªÔºâ</div>
                                    <div class="grid grid-cols-2 gap-3">
                                        ${state.formData.images.map((file, index) => `
                                            <div class="relative group">
                                                ${file.type === 'image' ? `
                                                    <img src="${file.data}" alt="ÁîªÂÉè ${index + 1}" class="w-full h-40 object-cover rounded-lg border border-gray-200">
                                                ` : `
                                                    <video src="${file.data}" class="w-full h-40 object-cover rounded-lg border border-gray-200" controls></video>
                                                `}
                                                <button onclick="downloadImage({data: state.formData.images[${index}].data, type: state.formData.images[${index}].type}, \`${state.formData.title || 'media'}\`, ${index})" class="absolute bottom-2 right-2 bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600 transition-colors shadow-lg text-sm">
                                                    ‚¨á ‰øùÂ≠ò
                                                </button>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            ${state.formData.videoPaths && state.formData.videoPaths.length > 0 ? `
                                <div>
                                    <div class="text-sm text-gray-500 mb-2">ÂãïÁîª„Éë„ÇπÔºà${state.formData.videoPaths.length}Êú¨Ôºâ</div>
                                    <div class="space-y-2">
                                        ${state.formData.videoPaths.map((videoPath, index) => `
                                            <div class="bg-gray-100 p-2 rounded-lg">
                                                <div class="text-sm font-semibold">${videoPath.name}</div>
                                                <div class="text-xs text-gray-600">${videoPath.path || '„Éë„Çπ„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì'}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            <div class="flex gap-3 pt-4 border-t">
                                <button onclick="switchToEditMode()" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white py-3 rounded-lg font-semibold transition-colors shadow-md">
                                    ‚úèÔ∏è Á∑®ÈõÜ„Åô„Çã
                                </button>
                                <button onclick="deletePost('${state.selectedDate}', ${state.editingPostId})" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-3 rounded-lg font-semibold transition-colors shadow-md">
                                    üóë ÂâäÈô§„Åô„Çã
                                </button>
                            </div>
                        </div>
                    </div>`;
                } else {
                    editFormHTML = `<div class="bg-white rounded-2xl shadow-xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold text-gray-800">${state.editingPostId ? 'ÊäïÁ®ø„ÇíÁ∑®ÈõÜ' : 'Êñ∞Ë¶èÊäïÁ®ø'} - ${state.selectedDate}</h3>
                            <button onclick="cancelEdit(); render();" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                                <span class="text-2xl">√ó</span>
                            </button>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">ÊäïÁ®ø„Çø„Ç§„Éà„É´</label>
                                <input type="text" value="${state.formData.title}" onchange="state.formData.title = this.value" placeholder="‰æã: Êñ∞ÂïÜÂìÅÂëäÁü•" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">ÊäïÁ®øÂÖàSNSÔºàË§áÊï∞ÈÅ∏ÊäûÂèØÔºâ</label>
                                <div class="grid grid-cols-2 gap-2">
                                    ${platformButtons.map(platform => `
                                        <button onclick="togglePlatform('${platform.value}')" class="py-2 px-3 rounded-lg font-semibold text-white transition-all text-sm ${state.formData.platforms.includes(platform.value) ? `${platform.color} ring-2 ring-offset-2 ring-blue-300` : 'bg-gray-300 hover:bg-gray-400'}">
                                            ${platform.label}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">ÊäïÁ®ø„ÉÜ„Ç≠„Çπ„Éà</label>
                                <textarea onchange="state.formData.text = this.value" placeholder="ÊäïÁ®ø„Åô„ÇãÊñáÁ´†„ÇíÂÖ•Âäõ..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" rows="6">${state.formData.text}</textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">ÁîªÂÉèÔºàÊúÄÂ§ß5ÊûöÔºâ<span class="ml-2 text-xs text-gray-500">${state.formData.images.length} / 5</span></label>
                                <div class="border-2 border-dashed rounded-lg p-4 text-center border-gray-300 hover:border-blue-400">
                                    ${state.formData.images.length > 0 ? `
                                        <div>
                                            <div class="grid grid-cols-3 gap-2 mb-3">
                                                ${state.formData.images.map((image, index) => `
                                                    <div class="relative group">
                                                        ${image.type === 'image' ? `
                                                            <img src="${image.data}" alt="ÁîªÂÉè ${index + 1}" class="w-full h-24 object-cover rounded-lg">
                                                        ` : `
                                                            <video src="${image.data}" class="w-full h-24 object-cover rounded-lg" controls></video>
                                                        `}
                                                        <button onclick="removeImage(${index})" class="absolute top-1 right-1 bg-red-500 text-white p-1 rounded-full hover:bg-red-600 transition-colors shadow-lg opacity-0 group-hover:opacity-100">
                                                            √ó
                                                        </button>
                                                    </div>
                                                `).join('')}
                                            </div>
                                            ${state.formData.images.length < 5 ? `
                                                <label class="inline-block bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg cursor-pointer transition-colors text-sm">
                                                    + „Åï„Çâ„Å´ËøΩÂä†
                                                    <input type="file" accept="image/*,video/*" multiple onchange="handleImageSelect(event)" class="hidden">
                                                </label>
                                            ` : ''}
                                        </div>
                                    ` : `
                                        <div>
                                            <label class="inline-block bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg cursor-pointer transition-colors text-sm">
                                                üì∏ ÁîªÂÉè/ÂãïÁîª„ÇíÈÅ∏Êäû
                                                <input type="file" accept="image/*,video/*" multiple onchange="handleImageSelect(event)" class="hidden">
                                            </label>
                                        </div>
                                    `}
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">ÂãïÁîª„Éë„ÇπÔºàÊúÄÂ§ß3„Å§Ôºâ</label>
                                ${state.formData.videoPaths && state.formData.videoPaths.length > 0 ? state.formData.videoPaths.map((videoPath, index) => `
                                    <div class="mb-2">
                                        <input 
                                            type="text" 
                                            value="${videoPath.path}" 
                                            onchange="state.formData.videoPaths[${index}].path = this.value" 
                                            placeholder="ÂãïÁîª„ÅÆ„Éï„Ç°„Ç§„É´„Éë„Çπ„Åæ„Åü„ÅØURL" 
                                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        >
                                    </div>
                                `).join('') : ''}
                                <button onclick="addVideoPath()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                                    ÂãïÁîª„Éë„Çπ„ÇíËøΩÂä†
                                </button>
                            </div>
                            <div class="flex gap-3 pt-2">
                                <button onclick="savePost()" ${state.isSaving ? 'disabled' : ''} class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg font-semibold transition-colors ${state.isSaving ? 'opacity-50 cursor-not-allowed' : ''}">
                                    ${state.isSaving ? '‚è≥ ‰øùÂ≠ò‰∏≠...' : (state.editingPostId ? 'Êõ¥Êñ∞' : '‰øùÂ≠ò')}
                                </button>
                            </div>
                        </div>
                    </div>`;
                }
            }

            document.getElementById('app').innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <h1 class="text-3xl font-bold text-gray-800">üì± SNSÊäïÁ®ø„Ç´„É¨„É≥„ÉÄ„Éº</h1>
                    <div class="flex flex-col items-end gap-1">
                        ${state.isSignedIn ? `
                            <div class="flex items-center gap-2">
                                <div class="inline-flex items-center gap-2 bg-green-100 text-green-700 px-3 py-1 rounded-lg text-xs">
                                    ‚úÖ ÂÖ±Êúâ„Éâ„É©„Ç§„ÉñÊé•Á∂öÊ∏à
                                </div>
                                <button onclick="handleSignOut()" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded-lg text-xs transition-colors">
                                    „É≠„Ç∞„Ç¢„Ç¶„Éà
                                </button>
                            </div>
                        ` : `
                            <button onclick="handleAuthClick()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-semibold transition-colors shadow-lg text-sm">
                                üîó Google Drive„Å´Êé•Á∂ö
                            </button>
                        `}
                        ${state.lastUpdated ? `<div class="text-xs text-gray-400">ÊúÄÁµÇÊõ¥Êñ∞: ${formatDateTime(state.lastUpdated)}</div>` : ''}
                        <div class="text-xs text-gray-400">„Ç¢„Éó„É™Êõ¥Êñ∞: ${APP_VERSION}</div>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <div class="lg:col-span-2">
                        <div class="bg-white rounded-2xl shadow-xl p-6">
                            <div class="flex items-center justify-between mb-6">
                                <button onclick="state.currentDate.setMonth(state.currentDate.getMonth() - 1); render();" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                                    ‚óÄ
                                </button>
                                <div class="flex items-center gap-3">
                                    <h2 class="text-2xl font-bold text-gray-800">${monthName}</h2>
                                    <button onclick="goToToday()" class="px-3 py-1 text-sm bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors">
                                        Êú¨Êó•
                                    </button>
                                </div>
                                <button onclick="state.currentDate.setMonth(state.currentDate.getMonth() + 1); render();" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                                    ‚ñ∂
                                </button>
                            </div>
                            <div class="grid grid-cols-7 gap-2">
                                ${calendarHTML}
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-1">
                        ${editFormHTML || '<div class="bg-gray-50 rounded-2xl shadow-xl p-6 text-center text-gray-500">„Ç´„É¨„É≥„ÉÄ„Éº„Åã„ÇâÊó•‰ªò„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>'}
                    </div>
                </div>
            `;
        }

        window.addEventListener('load', () => {
            gapiLoaded();
            gisLoaded();
        });
    </script>
</body>
</html>
