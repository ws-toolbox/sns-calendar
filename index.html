<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SNS投稿カレンダー管理（共有ドライブ対応・UI改善）</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body class="bg-gradient-to-br from-purple-50 to-blue-50 min-h-screen">
  <div id="app" class="max-w-[1920px] mx-auto p-6"></div>
  <script>
    const CLIENT_ID = '417822818519-8imosvo7c9e2gem7cp0rse0vm8vrjlou.apps.googleusercontent.com';
    const SCOPES = 'https://www.googleapis.com/auth/drive';
    const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';

    const FILE_NAME = 'sns_calendar_data.json';
    const FOLDER_NAME = 'SNS投稿管理';
    const SHARED_DRIVE_ID = '0AHJk3pS7tSEgUk9PVA';
    const PARENT_FOLDER_ID = '1I23qmcfZ_x8c15NtW54vjhKQb7waJi-E';
    const APP_VERSION = '2025/10/14 12:40';

    const PLATFORM_BADGES = {
      x: { label: 'X', color: 'bg-black' },
      ig: { label: 'IG', color: 'bg-gradient-to-r from-purple-500 to-pink-500' },
      l: { label: 'L', color: 'bg-green-500' },
      m: { label: 'M', color: 'bg-blue-600' },
    };

    let gapiInited = false;
    let gisInited = false;
    let tokenClient;
    let accessToken = null;
    let fileId = null;

    let state = {
      currentDate: new Date(),
      posts: {},
      selectedDate: null,
      editingPostId: null,
      viewMode: 'edit',
      isSignedIn: false,
      isSaving: false,
      folderId: null,
      lastUpdated: null,
      formData: { title: '', platforms: ['x'], text: '', images: [] },
    };

    function gapiLoaded() { gapi.load('client', initializeGapiClient); }
    async function initializeGapiClient() { await gapi.client.init({ discoveryDocs: [DISCOVERY_DOC] }); gapiInited = true; maybeEnableButtons(); }
    function gisLoaded() { tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: '' }); gisInited = true; maybeEnableButtons(); }
    function maybeEnableButtons() { if (gapiInited && gisInited) { tryAutoSignIn(); } }

    function handleAuthClick() {
      tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) throw(resp);
        accessToken = gapi.client.getToken().access_token;
        state.isSignedIn = true;
        localStorage.setItem('google_access_token', JSON.stringify(gapi.client.getToken()));
        await loadFromDrive();
        render();
      };
      if (gapi.client.getToken() === null) { tokenClient.requestAccessToken({ prompt: 'consent' }); }
      else { tokenClient.requestAccessToken({ prompt: '' }); }
    }

    async function tryAutoSignIn() {
      const saved = localStorage.getItem('google_access_token');
      if (saved) {
        try {
          const token = JSON.parse(saved);
          gapi.client.setToken(token);
          accessToken = token.access_token;
          await gapi.client.drive.files.list({ pageSize: 1, supportsAllDrives: true });
          state.isSignedIn = true;
          await loadFromDrive();
          render();
        } catch (e) {
          localStorage.removeItem('google_access_token');
          render();
        }
      } else {
        render();
      }
    }

    function handleSignOut() {
      gapi.client.setToken(null);
      localStorage.removeItem('google_access_token');
      accessToken = null;
      state.isSignedIn = false;
      state.posts = {};
      state.folderId = null;
      fileId = null;
      render();
      showMessage('ログアウトしました', 'success');
    }

    async function loadFromDrive() {
      try {
        // フォルダ探索（PARENT_FOLDER_ID 直下）
        const folderSearch = await gapi.client.drive.files.list({
          q: `name='${FOLDER_NAME}' and mimeType='application/vnd.google-apps.folder' and trashed=false and '${PARENT_FOLDER_ID}' in parents`,
          fields: 'files(id, name)',
          supportsAllDrives: true,
          includeItemsFromAllDrives: true,
          corpora: 'drive',
          driveId: SHARED_DRIVE_ID,
        });
        let folderId;
        if (folderSearch.result.files && folderSearch.result.files.length > 0) {
          folderId = folderSearch.result.files[0].id;
        } else {
          const created = await gapi.client.drive.files.create({
            resource: { name: FOLDER_NAME, mimeType: 'application/vnd.google-apps.folder', parents: [PARENT_FOLDER_ID] },
            supportsAllDrives: true, fields: 'id'
          });
          folderId = created.result.id;
        }
        state.folderId = folderId;

        // データファイル検索
        const fileSearch = await gapi.client.drive.files.list({
          q: `name='${FILE_NAME}' and '${folderId}' in parents and trashed=false`,
          fields: 'files(id, name)',
          supportsAllDrives: true,
          includeItemsFromAllDrives: true,
          corpora: 'drive',
          driveId: SHARED_DRIVE_ID,
        });
        if (fileSearch.result.files && fileSearch.result.files.length > 0) {
          fileId = fileSearch.result.files[0].id;
          const fileContent = await gapi.client.drive.files.get({ fileId, alt: 'media', supportsAllDrives: true });
          if (fileContent.body) {
            const data = JSON.parse(fileContent.body);
            const loadedPosts = data.posts || {};
            for (const d of Object.keys(loadedPosts)) {
              loadedPosts[d] = (loadedPosts[d] || []).map(p => {
                if (p.platform && !p.platforms) {
                  return { ...p, platforms: [mapLegacyPlatform(p.platform)], platform: undefined };
                }
                if (p.platforms) {
                  return { ...p, platforms: p.platforms.map(mapLegacyPlatform) };
                }
                return p;
              });
            }
            state.posts = loadedPosts;
            state.lastUpdated = data.lastUpdated || null;
          }
        }
      } catch (error) {
        showMessage('エラー: ' + (error.result?.error?.message || error.message), 'error');
      }
    }

    function mapLegacyPlatform(key) {
      if (key === 'instagram') return 'ig';
      if (key === 'line') return 'l';
      if (key === 'x' || key === 'ig' || key === 'l' || key === 'm') return key;
      return 'x';
    }

    async function saveToDrive() {
      if (!state.isSignedIn || !state.folderId || state.isSaving) return;
      state.isSaving = true; render();
      try {
        const now = new Date().toISOString();
        const content = JSON.stringify({ posts: state.posts, lastUpdated: now });
        const file = new Blob([content], { type: 'application/json' });
        const metadata = fileId ? { name: FILE_NAME, mimeType: 'application/json' } : { name: FILE_NAME, mimeType: 'application/json', parents: [state.folderId] };
        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
        form.append('file', file);
        const url = fileId ? `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart&supportsAllDrives=true` : `https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&supportsAllDrives=true`;
        const response = await fetch(url, { method: fileId ? 'PATCH' : 'POST', headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }), body: form });
        if (!response.ok) throw new Error(`保存に失敗: ${response.status}`);
        const result = await response.json();
        if (!fileId) fileId = result.id;
        state.lastUpdated = now;
        showMessage('共有ドライブに保存しました！', 'success');
      } catch (e) {
        showMessage('保存に失敗: ' + e.message, 'error');
      } finally {
        state.isSaving = false; render();
      }
    }

    async function savePost() {
      if (!state.formData.title && !state.formData.text) return;
      const newPost = { ...state.formData, id: state.editingPostId || Date.now() };
      const datePosts = state.posts[state.selectedDate] || [];
      if (state.editingPostId) state.posts[state.selectedDate] = datePosts.map(p => p.id === state.editingPostId ? newPost : p);
      else state.posts[state.selectedDate] = [...datePosts, newPost];
      await saveToDrive();
      cancelEdit();
      render();
    }

    function cancelEdit() { state.selectedDate = null; state.editingPostId = null; state.viewMode = 'edit'; state.formData = { title: '', platforms: ['x'], text: '', images: [] }; }

    async function deletePost(dateStr, postId) { const datePosts = (state.posts[dateStr] || []).filter(p => p.id !== postId); if (datePosts.length === 0) delete state.posts[dateStr]; else state.posts[dateStr] = datePosts; await saveToDrive(); cancelEdit(); render(); }

    function openEditForm(day, postId = null) {
      const dateStr = formatDate(new Date(state.currentDate.getFullYear(), state.currentDate.getMonth(), day));
      state.selectedDate = dateStr;
      if (postId && state.posts[dateStr]) {
        const post = state.posts[dateStr].find(p => p.id === postId);
        if (post) {
          const platforms = post.platforms || (post.platform ? [mapLegacyPlatform(post.platform)] : ['x']);
          state.formData = { ...post, platforms };
          state.editingPostId = postId;
          state.viewMode = 'view';
        }
      } else {
        state.formData = { title: '', platforms: ['x'], text: '', images: [] };
        state.editingPostId = null;
        state.viewMode = 'edit';
      }
      render();
    }

    function switchToEditMode() { state.viewMode = 'edit'; render(); }

    function handleImageSelect(e) {
      const files = Array.from(e.target.files);
      if (files.length === 0) return;
      const remaining = 5 - state.formData.images.length;
      const filesToProcess = files.slice(0, remaining);
      let processed = 0; const newImages = [];
      filesToProcess.forEach(file => {
        const reader = new FileReader();
        reader.onload = (ev) => { newImages.push(ev.target.result); processed++; if (processed === filesToProcess.length) { state.formData.images = [...state.formData.images, ...newImages]; render(); } };
        reader.readAsDataURL(file);
      });
    }
    function removeImage(index) { state.formData.images = state.formData.images.filter((_, i) => i !== index); render(); }
    function downloadImage(imageData, title, index) { const link = document.createElement('a'); link.href = imageData; link.download = `${title || 'image'}_${index + 1}.png`; document.body.appendChild(link); link.click(); document.body.removeChild(link); }

    function copyToClipboard(text) { navigator.clipboard.writeText(text).then(() => { showMessage('コピーしました！', 'success'); }); }

    function formatDateTime(isoString) { if (!isoString) return ''; const date = new Date(isoString); return `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`; }
    function formatDate(date) { return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`; }
    function getDaysInMonth(date) { const y = date.getFullYear(); const m = date.getMonth(); const first = new Date(y, m, 1); const last = new Date(y, m + 1, 0); return { daysInMonth: last.getDate(), startingDayOfWeek: first.getDay() }; }

    function renderPlatformBadges(platforms) { return (platforms || []).map(p => { const b = PLATFORM_BADGES[p] || PLATFORM_BADGES.x; return `<span class="${b.color} text-white px-1 py-[1px] rounded text-[10px] leading-none">${b.label}</span>`; }).join('<span class="text-gray-300 text-[10px] px-0.5">·</span>'); }

    function render() {
      const { daysInMonth, startingDayOfWeek } = getDaysInMonth(state.currentDate);
      const monthName = state.currentDate.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long' });
      const today = new Date();
      const isCurrentMonth = state.currentDate.getMonth() === today.getMonth() && state.currentDate.getFullYear() === today.getFullYear();

      const totalCells = 42; const leading = startingDayOfWeek; const trailing = totalCells - (leading + daysInMonth);
      const cells = []; for (let i = 0; i < leading; i++) cells.push({ type: 'blank' }); for (let d = 1; d <= daysInMonth; d++) cells.push({ type: 'day', day: d }); for (let i = 0; i < trailing; i++) cells.push({ type: 'blank' });

      const weekDays = ['日', '月', '火', '水', '木', '金', '土'];
      const weekHeader = weekDays.map(d => `<div class="text-center font-bold text-gray-600 py-1 text-sm">${d}</div>`).join('');

      const daysHTML = cells.map(cell => {
        if (cell.type === 'blank') return `<div class="border rounded-lg bg-white border-gray-200 p-1"></div>`;
        const day = cell.day;
        const dateStr = formatDate(new Date(state.currentDate.getFullYear(), state.currentDate.getMonth(), day));
        const dayPosts = state.posts[dateStr] || [];
        const isToday = isCurrentMonth && day === today.getDate();
        const cls = `border rounded-lg transition-all flex flex-col ${isToday ? 'bg-yellow-100 border-yellow-400 ring-1 ring-yellow-300' : 'bg-white border-gray-200 hover:border-blue-200'}`;
        const postsHTML = dayPosts.map(post => `
          <div data-open="${day}|${post.id}" class="mt-1 text-[11px] bg-white p-1 rounded border border-gray-200 hover:border-blue-400 cursor-pointer transition-all">
            <div class="flex items-center gap-1">
              <span class="flex items-center gap-1">${renderPlatformBadges(post.platforms)}</span>
              <span class="font-semibold text-gray-700 truncate">${post.title || '無題'}</span>
            </div>
          </div>`).join('');
        return `<div class="${cls} p-1">
          <div class="flex items-center justify-between">
            <div class="font-semibold ${isToday ? 'text-yellow-700' : 'text-gray-700'} text-sm">${day}${isToday ? '<span class="ml-1 text-[10px]">●</span>' : ''}</div>
            <button data-add="${day}" class="text-[11px] text-gray-500 hover:text-gray-700 px-1 rounded transition-colors">＋</button>
          </div>
          <div class="flex-1 overflow-hidden">${postsHTML}</div>
        </div>`;
      }).join('');

      let editFormHTML = '';
      const platformBtns = [ {v:'x',l:'X',c:'bg-black'}, {v:'ig',l:'IG',c:'bg-gradient-to-r from-purple-500 to-pink-500'}, {v:'l',l:'L',c:'bg-green-500'}, {v:'m',l:'M',c:'bg-blue-600'} ];
      if (state.selectedDate) {
        if (state.viewMode === 'view') {
          editFormHTML = `
          <div class="bg-white rounded-2xl shadow p-4 h-full flex flex-col">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-lg font-bold text-gray-800">投稿詳細</h3>
              <button id="closeDetail" class="p-1 hover:bg-gray-100 rounded-lg transition-colors"><span class="text-xl">×</span></button>
            </div>
            <div class="space-y-3 text-sm flex-1 overflow-hidden">
              <div><div class="text-gray-500 mb-1">投稿日</div><div class="font-semibold text-gray-800">${state.selectedDate}</div></div>
              <div><div class="text-gray-500 mb-1">タイトル</div><div class="font-semibold text-gray-800">${state.formData.title || '無題'}</div></div>
              <div><div class="text-gray-500 mb-1">投稿先</div><div class="flex gap-1">${renderPlatformBadges(state.formData.platforms)}</div></div>
              <div class="min-h-0">
                <div class="text-gray-500 mb-1">投稿テキスト</div>
                <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 whitespace-pre-wrap h-28 overflow-auto">${state.formData.text || 'テキストなし'}</div>
                <button id="copyBtn" class="mt-2 w-full flex items-center justify-center gap-2 bg-gray-300 text-gray-800 py-2 rounded-lg hover:bg-gray-400 transition-colors">📋 テキストをコピー</button>
              </div>
              ${state.formData.images && state.formData.images.length > 0 ? `
              <div class="min-h-0">
                <div class="text-gray-500 mb-1">画像（${state.formData.images.length}枚）</div>
                <div class="grid grid-cols-2 gap-2 max-h-40 overflow-auto">
                  ${state.formData.images.map((img, i) => `
                  <div class="relative">
                    <img src="${img}" alt="画像 ${i + 1}" class="w-full h-28 object-cover rounded-lg border border-gray-200">
                    <button class="dl-btn absolute bottom-1 right-1 bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600" data-src="${img}" data-title="${state.formData.title || ''}" data-index="${i}">⬇</button>
                  </div>`).join('')}
                </div>
              </div>` : ''}
              <div class="flex gap-2 pt-2 border-t">
                <button id="editBtn" class="flex-1 border border-green-600 text-green-700 hover:bg-green-50 py-2 rounded-lg font-semibold transition-colors">✏️ 編集</button>
                <button id="deleteBtn" class="border border-red-600 text-red-700 hover:bg-red-50 px-4 py-2 rounded-lg font-semibold transition-colors">🗑 削除</button>
              </div>
            </div>
          </div>`;
        } else {
          editFormHTML = `
          <div class="bg-white rounded-2xl shadow p-4 h-full flex flex-col">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-lg font-bold text-gray-800">${state.editingPostId ? '投稿を編集' : '新規投稿'} - ${state.selectedDate}</h3>
              <button id="closeEdit" class="p-1 hover:bg-gray-100 rounded-lg transition-colors"><span class="text-xl">×</span></button>
            </div>
            <div class="space-y-3 text-sm flex-1 overflow-hidden">
              <div><label class="block font-semibold text-gray-700 mb-1">投稿タイトル</label><input id="titleInput" type="text" value="${state.formData.title}" placeholder="例: 新商品告知" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" /></div>
              <div><label class="block font-semibold text-gray-700 mb-1">投稿先（複数選択可）</label>
                <div class="grid grid-cols-4 gap-2">
                  ${platformBtns.map(p => { const active = (state.formData.platforms||[]).includes(p.v); const base='w-full py-2 px-3 rounded-lg font-semibold text-white text-sm transition-all'; return `<button type="button" class="plat-btn ${active?'active':''} ${active?p.c:'bg-gray-300 hover:bg-gray-400'}" data-v="${p.v}" data-c="${p.c}">${p.l}</button>`; }).join('')}
                </div>
              </div>
              <div class="min-h-0"><label class="block font-semibold text-gray-700 mb-1">投稿テキスト</label>
                <textarea id="textArea" placeholder="投稿する文章を入力..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 h-28">${state.formData.text || ''}</textarea>
                <button id="copyBtnEdit" class="mt-2 w-full flex items-center justify-center gap-2 bg-gray-300 text-gray-800 py-2 rounded-lg hover:bg-gray-400 transition-colors">📋 テキストをコピー</button>
              </div>
              <div class="min-h-0"><label class="block font-semibold text-gray-700 mb-1">画像（最大5枚）<span class="ml-2 text-xs text-gray-500">${state.formData.images.length} / 5</span></label>
                <div class="border-2 border-dashed rounded-lg p-3 text-center border-gray-300 hover:border-blue-400">
                  ${(state.formData.images.length>0)?`
                  <div>
                    <div class="grid grid-cols-3 gap-2 mb-2">
                      ${state.formData.images.map((img,i)=>`<div class="relative group"><img src="${img}" class="w-full h-20 object-cover rounded-lg" /><button class="rm-img absolute top-1 right-1 bg-red-500 text-white p-1 rounded-full hover:bg-red-600 transition-colors shadow-lg" data-i="${i}">×</button></div>`).join('')}
                    </div>
                    ${(state.formData.images.length<5)?`<label class="inline-block bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg cursor-pointer transition-colors text-xs">+ さらに追加<input id="imgInputMore" type="file" accept="image/*" multiple class="hidden" /></label>`:''}
                  </div>`:`
                  <div><p class="text-gray-600 mb-2 text-sm">📸 画像を選択</p><label class="inline-block bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg cursor-pointer transition-colors text-xs">ファイルを選択<input id="imgInput" type="file" accept="image/*" multiple class="hidden" /></label></div>`}
                </div>
              </div>
              <div class="pt-1"><button id="saveBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg font-semibold transition-colors ${state.isSaving ? 'opacity-50 cursor-not-allowed' : ''}">${state.isSaving ? '⏳ 保存中...' : (state.editingPostId ? '更新' : '保存')}</button></div>
            </div>
          </div>`;
        }
      }

      const headerHeight = 140;
      const layoutHeight = window.innerHeight - headerHeight;
      document.getElementById('app').innerHTML = `
        <div class="flex items-center justify-between mb-1">
          <h1 class="text-2xl font-bold text-gray-800">📱 SNS投稿カレンダー</h1>
          <div class="flex items-center gap-2">
            <button id="todayBtn" class="text-xs px-2 py-1 border border-gray-300 rounded-lg hover:bg-gray-100">本日に戻る</button>
            <div class="text-right text-[10px] text-gray-400">アプリ更新: ${APP_VERSION}</div>
          </div>
        </div>
        ${state.lastUpdated ? `<div class="text-right text-[10px] text-gray-500 mb-1">データ最終更新: ${formatDateTime(state.lastUpdated)}</div>` : ''}
        <div class="mb-2 text-center">
          ${!state.isSignedIn ? `
            <button id="authBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-1.5 rounded-lg font-semibold transition-colors shadow text-sm">🔗 Google Driveに接続</button>
            <p class="text-[10px] text-gray-600 mt-0.5">データを共有ドライブに自動保存します</p>`
          : `
            <div class="inline-flex items-center gap-2">
              <div class="inline-flex items-center gap-2 bg-green-100 text-green-700 px-2 py-0.5 rounded-lg text-xs">✅ 共有ドライブに接続済み</div>
              <button id="logoutBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-2 py-1 rounded-lg text-[10px] transition-colors">ログアウト</button>
            </div>`}
        </div>
        <div class="grid grid-cols-3 gap-3" style="height:${layoutHeight}px;">
          <div class="col-span-2 bg-white rounded-2xl shadow p-3 flex flex-col overflow-hidden">
            <div class="flex items-center justify-between mb-2">
              <button id="prevBtn" class="p-1 hover:bg-gray-100 rounded-lg transition-colors">◀</button>
              <h2 class="text-lg font-bold text-gray-800">${monthName}</h2>
              <button id="nextBtn" class="p-1 hover:bg-gray-100 rounded-lg transition-colors">▶</button>
            </div>
            <div class="grid grid-cols-7 gap-1 text-xs mb-1">${weekHeader}</div>
            <div class="grid grid-cols-7 gap-1 flex-1" style="grid-template-rows: repeat(6, minmax(0, 1fr));">${daysHTML}</div>
          </div>
          <div class="overflow-hidden">${editFormHTML || '<div class="h-full flex items-center justify-center text-gray-500 bg-white rounded-2xl shadow p-3">カレンダーから日付を選択してください</div>'}</div>
        </div>`;

      // イベント委譲（安定化のため inline on* を使わない）
      const app = document.getElementById('app');
      app.querySelector('#todayBtn')?.addEventListener('click', goToday);
      app.querySelector('#authBtn')?.addEventListener('click', handleAuthClick);
      app.querySelector('#logoutBtn')?.addEventListener('click', handleSignOut);
      app.querySelector('#prevBtn')?.addEventListener('click', () => { state.currentDate.setMonth(state.currentDate.getMonth() - 1); render(); });
      app.querySelector('#nextBtn')?.addEventListener('click', () => { state.currentDate.setMonth(state.currentDate.getMonth() + 1); render(); });

      app.querySelectorAll('[data-add]')?.forEach(btn => btn.addEventListener('click', () => { const day = parseInt(btn.getAttribute('data-add'), 10); openEditForm(day); }));
      app.querySelectorAll('[data-open]')?.forEach(div => div.addEventListener('click', () => { const [d, id] = div.getAttribute('data-open').split('|'); openEditForm(parseInt(d,10), parseInt(id,10)); }));

      app.querySelector('#closeDetail')?.addEventListener('click', () => { cancelEdit(); render(); });
      app.querySelector('#editBtn')?.addEventListener('click', () => { switchToEditMode(); });
      app.querySelector('#deleteBtn')?.addEventListener('click', () => { deletePost(state.selectedDate, state.editingPostId); });
      app.querySelector('#copyBtn')?.addEventListener('click', () => { copyToClipboard(state.formData.text); });

      app.querySelector('#closeEdit')?.addEventListener('click', () => { cancelEdit(); render(); });
      app.querySelector('#titleInput')?.addEventListener('input', (e) => { state.formData.title = e.target.value; });
      app.querySelector('#textArea')?.addEventListener('input', (e) => { state.formData.text = e.target.value; });
      app.querySelector('#copyBtnEdit')?.addEventListener('click', () => { copyToClipboard(state.formData.text); });
      app.querySelector('#saveBtn')?.addEventListener('click', () => { if (!state.isSaving) savePost(); });

      app.querySelectorAll('.plat-btn')?.forEach(btn => btn.addEventListener('click', () => {
        const v = btn.getAttribute('data-v'); const c = btn.getAttribute('data-c');
        const set = new Set(state.formData.platforms || []);
        if (set.has(v)) { set.delete(v); btn.classList.remove('active'); btn.classList.remove(...c.split(' ')); btn.classList.add('bg-gray-300'); }
        else { set.add(v); btn.classList.add('active'); btn.classList.remove('bg-gray-300'); btn.classList.add(...c.split(' ')); }
        state.formData.platforms = Array.from(set);
      }));

      app.querySelector('#imgInput')?.addEventListener('change', handleImageSelect);
      app.querySelector('#imgInputMore')?.addEventListener('change', handleImageSelect);
      app.querySelectorAll('.rm-img')?.forEach(btn => btn.addEventListener('click', () => { const i = parseInt(btn.getAttribute('data-i'),10); removeImage(i); }));
      app.querySelectorAll('.dl-btn')?.forEach(btn => btn.addEventListener('click', () => { const src = btn.getAttribute('data-src'); const title = btn.getAttribute('data-title') || ''; const i = parseInt(btn.getAttribute('data-index'),10); downloadImage(src, title, i); }));
    }

    function goToday() { const t = new Date(); state.currentDate = new Date(t.getFullYear(), t.getMonth(), 1); render(); }

    function showMessage(message, type) { const messageDiv = document.createElement('div'); messageDiv.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white z-50 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`; messageDiv.textContent = message; document.body.appendChild(messageDiv); setTimeout(() => messageDiv.remove(), 3000); }

    window.addEventListener('load', () => { gapiLoaded(); gisLoaded(); });
  </script>
</body>
</html>
