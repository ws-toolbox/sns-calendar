<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SNSæŠ•ç¨¿ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç®¡ç†ï¼ˆå…±æœ‰ãƒ‰ãƒ©ã‚¤ãƒ–å¯¾å¿œãƒ»UIæ”¹å–„ï¼‰</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body class="bg-gradient-to-br from-purple-50 to-blue-50 min-h-screen">
  <div id="app" class="max-w-[1920px] mx-auto p-6"></div>
  <script>
    // =============================
    // â˜… è¨­å®šï¼ˆç½®ãæ›ãˆOKï¼‰
    // =============================
    const CLIENT_ID = '417822818519-8imosvo7c9e2gem7cp0rse0vm8vrjlou.apps.googleusercontent.com';
    const SCOPES = 'https://www.googleapis.com/auth/drive';
    const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';

    const FILE_NAME = 'sns_calendar_data.json';
    const FOLDER_NAME = 'SNSæŠ•ç¨¿ç®¡ç†'; // è¦ªãƒ•ã‚©ãƒ«ãƒ€ï¼ˆä¸‹ã«ã“ã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆï¼‰

    // å…±æœ‰ãƒ‰ãƒ©ã‚¤ãƒ–IDï¼ˆ0A ã§å§‹ã¾ã‚‹ï¼‰
    const SHARED_DRIVE_ID = '0AHJk3pS7tSEgUk9PVA';
    // å…±æœ‰ãƒ‰ãƒ©ã‚¤ãƒ–å†…ã®æ—¢å­˜ã®è¦ªãƒ•ã‚©ãƒ«ãƒ€IDï¼ˆã“ã®ä¸­ã« FOLDER_NAME ã‚’ä½œæˆï¼‰
    const PARENT_FOLDER_ID = '1I23qmcfZ_x8c15NtW54vjhKQb7waJi-E';

    const APP_VERSION = '2025/10/14 22:00';

    // =============================
    // å†…éƒ¨çŠ¶æ…‹
    // =============================
    let gapiInited = false;
    let gisInited = false;
    let tokenClient;
    let accessToken = null;
    let fileId = null;

    // ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ å®šç¾©ï¼ˆè¤‡æ•°é¸æŠå¯¾å¿œ + ã€ŒM(ã‚¹ã‚¿ãƒã‚¬)ã€ã€ŒL(Line ã¯ L)ã€ï¼‰
    const PLATFORM_BADGES = {
      x: { label: 'X', color: 'bg-black' },
      ig: { label: 'IG', color: 'bg-gradient-to-r from-purple-500 to-pink-500' },
      l: { label: 'L', color: 'bg-green-500' },
      m: { label: 'M', color: 'bg-blue-600' }, // ã‚¹ã‚¿ãƒã‚¬ç”¨ï¼ˆè‰²ã¯ä»»æ„ï¼‰
    };

    let state = {
      currentDate: new Date(),
      posts: {},
      selectedDate: null,
      editingPostId: null,
      viewMode: 'edit',
      isSignedIn: false,
      isSaving: false,
      folderId: null,        // FOLDER_NAME ã®ãƒ•ã‚©ãƒ«ãƒ€ID
      lastUpdated: null,
      formData: { title: '', platforms: ['x'], text: '', images: [] }, // â† è¤‡æ•°é¸æŠã«
    };

    // =============================
    // GAPI / GIS åˆæœŸåŒ–
    // =============================
    function gapiLoaded() { gapi.load('client', initializeGapiClient); }
    async function initializeGapiClient() {
      await gapi.client.init({ discoveryDocs: [DISCOVERY_DOC] });
      gapiInited = true; maybeEnableButtons();
    }
    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: '' });
      gisInited = true; maybeEnableButtons();
    }
    function maybeEnableButtons() { if (gapiInited && gisInited) { tryAutoSignIn(); } }

    function handleAuthClick() {
      tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) throw(resp);
        accessToken = gapi.client.getToken().access_token;
        state.isSignedIn = true;
        localStorage.setItem('google_access_token', JSON.stringify(gapi.client.getToken()));
        await loadFromDrive();
        render();
      };
      if (gapi.client.getToken() === null) {
        tokenClient.requestAccessToken({ prompt: 'consent' });
      } else {
        tokenClient.requestAccessToken({ prompt: '' });
      }
    }

    async function tryAutoSignIn() {
      const savedToken = localStorage.getItem('google_access_token');
      if (savedToken) {
        try {
          const token = JSON.parse(savedToken);
          gapi.client.setToken(token);
          accessToken = token.access_token;
          await gapi.client.drive.files.list({ pageSize: 1, supportsAllDrives: true });
          state.isSignedIn = true;
          await loadFromDrive();
          render();
        } catch (e) {
          console.log('Saved token expired');
          localStorage.removeItem('google_access_token');
          render();
        }
      } else {
        render();
      }
    }

    function handleSignOut() {
      gapi.client.setToken(null);
      localStorage.removeItem('google_access_token');
      accessToken = null;
      state.isSignedIn = false;
      state.posts = {};
      state.folderId = null;
      fileId = null;
      render();
      showMessage('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ', 'success');
    }

    // =============================
    // Drive èª­ã¿è¾¼ã¿ / ä½œæˆï¼ˆå…±æœ‰ãƒ‰ãƒ©ã‚¤ãƒ–å†…ã®æ—¢å­˜ãƒ•ã‚©ãƒ«ãƒ€é…ä¸‹ã« FOLDER_NAME ã‚’ä½œã‚‹ï¼‰
    // =============================
    async function loadFromDrive() {
      try {
        // å…±æœ‰ãƒ‰ãƒ©ã‚¤ãƒ–å­˜åœ¨ãƒã‚§ãƒƒã‚¯ï¼ˆä»»æ„ï¼‰
        try { await gapi.client.drive.drives.get({ driveId: SHARED_DRIVE_ID }); } catch (e) { console.warn('ãƒ‰ãƒ©ã‚¤ãƒ–æ¤œè¨¼å¤±æ•—:', e); }

        // è¦ªãƒ•ã‚©ãƒ«ãƒ€(PARENT_FOLDER_ID)é…ä¸‹ã« FOLDER_NAME ãŒã‚ã‚‹ã‹ï¼Ÿ
        const folderSearch = await gapi.client.drive.files.list({
          q: `name='${FOLDER_NAME}' and mimeType='application/vnd.google-apps.folder' and trashed=false and '${PARENT_FOLDER_ID}' in parents`,
          fields: 'files(id, name)',
          supportsAllDrives: true,
          includeItemsFromAllDrives: true,
          corpora: 'drive',
          driveId: SHARED_DRIVE_ID,
        });

        let folderId;
        if (folderSearch.result.files && folderSearch.result.files.length > 0) {
          folderId = folderSearch.result.files[0].id;
          showMessage('å…±æœ‰ãƒ‰ãƒ©ã‚¤ãƒ–ã®æŒ‡å®šãƒ•ã‚©ãƒ«ãƒ€é…ä¸‹ã§ãƒ•ã‚©ãƒ«ãƒ€ã‚’æ¤œå‡ºã—ã¾ã—ãŸ', 'success');
        } else {
          // ç„¡ã‘ã‚Œã°ä½œæˆï¼ˆè¦ªã¯æ—¢å­˜ã® PARENT_FOLDER_IDï¼‰
          const folderCreate = await gapi.client.drive.files.create({
            resource: {
              name: FOLDER_NAME,
              mimeType: 'application/vnd.google-apps.folder',
              parents: [PARENT_FOLDER_ID],
            },
            supportsAllDrives: true,
            fields: 'id',
          });
          folderId = folderCreate.result.id;
          showMessage('å…±æœ‰ãƒ‰ãƒ©ã‚¤ãƒ–ã®æŒ‡å®šãƒ•ã‚©ãƒ«ãƒ€å†…ã«ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¾ã—ãŸ', 'success');
        }
        state.folderId = folderId;

        // ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®æœ‰ç„¡ãƒã‚§ãƒƒã‚¯
        const fileSearch = await gapi.client.drive.files.list({
          q: `name='${FILE_NAME}' and '${folderId}' in parents and trashed=false`,
          fields: 'files(id, name)',
          supportsAllDrives: true,
          includeItemsFromAllDrives: true,
          corpora: 'drive',
          driveId: SHARED_DRIVE_ID,
        });

        if (fileSearch.result.files && fileSearch.result.files.length > 0) {
          fileId = fileSearch.result.files[0].id;
          const fileContent = await gapi.client.drive.files.get({ fileId, alt: 'media', supportsAllDrives: true });
          if (fileContent.body) {
            const data = JSON.parse(fileContent.body);
            // æ—§ãƒ‡ãƒ¼ã‚¿ã®å˜ä¸€ platform ã‚’è¤‡æ•° platforms ã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ãƒˆ
            const loadedPosts = data.posts || {};
            for (const d of Object.keys(loadedPosts)) {
              loadedPosts[d] = (loadedPosts[d] || []).map(p => {
                if (p.platform && !p.platforms) {
                  const mapped = mapLegacyPlatform(p.platform);
                  return { ...p, platforms: [mapped], platform: undefined };
                }
                // Lã®æ—§ã‚­ãƒ¼(line)â†’lã€Instagramâ†’ig ãªã©ã‚‚è£œæ­£
                if (p.platforms) {
                  const fixed = p.platforms.map(mapLegacyPlatform);
                  return { ...p, platforms: fixed };
                }
                return p;
              });
            }
            state.posts = loadedPosts;
            state.lastUpdated = data.lastUpdated || null;
            showMessage('å…±æœ‰ãƒ‰ãƒ©ã‚¤ãƒ–ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'success');
          }
        }
      } catch (error) {
        console.error('å…±æœ‰ãƒ‰ãƒ©ã‚¤ãƒ–èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        showMessage('ã‚¨ãƒ©ãƒ¼: ' + (error.result?.error?.message || error.message), 'error');
      }
    }

    function mapLegacyPlatform(key) {
      // æ—§ã‚­ãƒ¼ã‚’æ–°ã‚­ãƒ¼ã«å¯„ã›ã‚‹
      if (key === 'instagram') return 'ig';
      if (key === 'line') return 'l';
      if (key === 'x' || key === 'ig' || key === 'l' || key === 'm') return key;
      return 'x';
    }

    async function saveToDrive() {
      if (!state.isSignedIn || !state.folderId || state.isSaving) return;
      state.isSaving = true; render();
      try {
        const now = new Date().toISOString();
        const content = JSON.stringify({ posts: state.posts, lastUpdated: now });
        const file = new Blob([content], { type: 'application/json' });
        const metadata = fileId
          ? { name: FILE_NAME, mimeType: 'application/json' }
          : { name: FILE_NAME, mimeType: 'application/json', parents: [state.folderId] };

        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
        form.append('file', file);

        const url = fileId
          ? `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart&supportsAllDrives=true`
          : `https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&supportsAllDrives=true`;

        const response = await fetch(url, {
          method: fileId ? 'PATCH' : 'POST',
          headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
          body: form,
        });
        if (!response.ok) throw new Error(`ä¿å­˜ã«å¤±æ•—: ${response.status}`);
        const result = await response.json();
        if (!fileId) fileId = result.id;
        state.lastUpdated = now;
        showMessage('å…±æœ‰ãƒ‰ãƒ©ã‚¤ãƒ–ã«ä¿å­˜ã—ã¾ã—ãŸï¼', 'success');
      } catch (error) {
        console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        showMessage('ä¿å­˜ã«å¤±æ•—: ' + error.message, 'error');
      } finally {
        state.isSaving = false;
        render();
      }
    }

    // =============================
    // æŠ•ç¨¿ CRUD
    // =============================
    async function savePost() {
      if (!state.formData.title && !state.formData.text) return;
      const newPost = { ...state.formData, id: state.editingPostId || Date.now() };
      const datePosts = state.posts[state.selectedDate] || [];
      if (state.editingPostId) {
        state.posts[state.selectedDate] = datePosts.map(p => p.id === state.editingPostId ? newPost : p);
      } else {
        state.posts[state.selectedDate] = [...datePosts, newPost];
      }
      await saveToDrive();
      cancelEdit();
      render();
    }

    function cancelEdit() {
      state.selectedDate = null;
      state.editingPostId = null;
      state.viewMode = 'edit';
      state.formData = { title: '', platforms: ['x'], text: '', images: [] };
    }

    async function deletePost(dateStr, postId) {
      const datePosts = (state.posts[dateStr] || []).filter(p => p.id !== postId);
      if (datePosts.length === 0) delete state.posts[dateStr]; else state.posts[dateStr] = datePosts;
      await saveToDrive();
      cancelEdit();
      render();
    }

    function openEditForm(day, postId = null) {
      const dateStr = formatDate(new Date(state.currentDate.getFullYear(), state.currentDate.getMonth(), day));
      state.selectedDate = dateStr;
      if (postId && state.posts[dateStr]) {
        const post = state.posts[dateStr].find(p => p.id === postId);
        if (post) {
          // äº’æ›
          const platforms = post.platforms || (post.platform ? [mapLegacyPlatform(post.platform)] : ['x']);
          state.formData = { ...post, platforms };
          state.editingPostId = postId;
          state.viewMode = 'view';
        }
      } else {
        state.formData = { title: '', platforms: ['x'], text: '', images: [] };
        state.editingPostId = null;
        state.viewMode = 'edit';
      }
      render();
    }

    function switchToEditMode() { state.viewMode = 'edit'; render(); }

    // ç”»åƒå‡¦ç†ï¼ˆæ®ãˆç½®ãï¼‰
    function handleImageSelect(e) {
      const files = Array.from(e.target.files);
      if (files.length === 0) return;
      const remaining = 5 - state.formData.images.length;
      const filesToProcess = files.slice(0, remaining);
      let processed = 0;
      const newImages = [];
      filesToProcess.forEach(file => {
        const reader = new FileReader();
        reader.onload = (event) => {
          newImages.push(event.target.result);
          processed++;
          if (processed === filesToProcess.length) {
            state.formData.images = [...state.formData.images, ...newImages];
            render();
          }
        };
        reader.readAsDataURL(file);
      });
    }
    function removeImage(index) { state.formData.images = state.formData.images.filter((_, i) => i !== index); render(); }
    function downloadImage(imageData, title, index) {
      const link = document.createElement('a');
      link.href = imageData;
      link.download = `${title || 'image'}_${index + 1}.png`;
      document.body.appendChild(link); link.click(); document.body.removeChild(link);
    }

    // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰
    function copyToClipboard(text) { navigator.clipboard.writeText(text).then(() => { showMessage('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼', 'success'); }); }

    // =============================
    // UI ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    // =============================
    function formatDateTime(isoString) {
      if (!isoString) return '';
      const date = new Date(isoString);
      return `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
    }
    function formatDate(date) { return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`; }
    function getDaysInMonth(date) {
      const year = date.getFullYear();
      const month = date.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      return { daysInMonth: lastDay.getDate(), startingDayOfWeek: firstDay.getDay() };
    }

    function renderPlatformBadges(platforms) {
      return (platforms || []).map(p => {
        const badge = PLATFORM_BADGES[p] || PLATFORM_BADGES.x;
        return `<span class="${badge.color} text-white px-1 py-[1px] rounded text-[10px] leading-none">${badge.label}</span>`;
      }).join('<span class="text-gray-300 text-[10px] px-0.5">Â·</span>');
    }

    function render() {
      const { daysInMonth, startingDayOfWeek } = getDaysInMonth(state.currentDate);
      const monthName = state.currentDate.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long' });
      const today = new Date();
      const isCurrentMonth = state.currentDate.getMonth() === today.getMonth() && state.currentDate.getFullYear() === today.getFullYear();

      // === 6é€±å›ºå®šã®42ãƒã‚¹ã‚’ç”Ÿæˆã—ã¦ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å®‰å®šåŒ–ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä¸è¦æƒ³å®šï¼‰ ===
      const totalCells = 42; // 7åˆ—Ã—6è¡Œ
      const leadingBlanks = startingDayOfWeek;
      const trailingBlanks = totalCells - (leadingBlanks + daysInMonth);

      const cells = [];
      for (let i = 0; i < leadingBlanks; i++) cells.push({ type: 'blank' });
      for (let d = 1; d <= daysInMonth; d++) cells.push({ type: 'day', day: d });
      for (let i = 0; i < trailingBlanks; i++) cells.push({ type: 'blank' });

      const weekDays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
      const weekHeader = weekDays.map(day => `<div class="text-center font-bold text-gray-600 py-1 text-sm">${day}</div>`).join('');

      const daysHTML = cells.map(cell => {
        if (cell.type === 'blank') {
          return `<div class="border rounded-lg bg-white border-gray-200 p-1"></div>`;
        }
        const day = cell.day;
        const dateStr = formatDate(new Date(state.currentDate.getFullYear(), state.currentDate.getMonth(), day));
        const dayPosts = state.posts[dateStr] || [];
        const isToday = isCurrentMonth && day === today.getDate();
        const dayClasses = `border rounded-lg transition-all flex flex-col ${isToday ? 'bg-yellow-100 border-yellow-400 ring-1 ring-yellow-300' : 'bg-white border-gray-200 hover:border-blue-200'}`;
        const postsHTML = dayPosts.map(post => `
          <div onclick="openEditForm(${day}, ${post.id})" class="mt-1 text-[11px] bg-white p-1 rounded border border-gray-200 hover:border-blue-400 cursor-pointer transition-all">
            <div class="flex items-center gap-1">
              <span class="flex items-center gap-1">${renderPlatformBadges(post.platforms)}</span>
              <span class="font-semibold text-gray-700 truncate">${post.title || 'ç„¡é¡Œ'}</span>
            </div>
          </div>`).join('');
        return `<div class="${dayClasses} p-1">
          <div class="flex items-center justify-between">
            <div class="font-semibold ${isToday ? 'text-yellow-700' : 'te = getDaysInMonth(state.currentDate);
      const monthName = state.currentDate.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long' });
      const today = new Date();
      const isCurrentMonth = state.currentDate.getMonth() === today.getMonth() && state.currentDate.getFullYear() === today.getFullYear();

      let calendarHTML = '';
      const weekDays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
      weekDays.forEach(day => { calendarHTML += `<div class="text-center font-bold text-gray-600 py-2">${day}</div>`; });
      for (let i = 0; i < startingDayOfWeek; i++) calendarHTML += '<div class="p-2"></div>';

      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = formatDate(new Date(state.currentDate.getFullYear(), state.currentDate.getMonth(), day));
        const dayPosts = state.posts[dateStr] || [];
        const isToday = isCurrentMonth && day === today.getDate();

        // â˜… äºˆå®šæœ‰ã‚Šã®è‰²ä»˜ã‘ã‚’ã‚„ã‚ã¦ãƒ•ãƒ©ãƒƒãƒˆã«ï¼ˆè¦æœ›ï¼‰
        const dayClasses = `p-2 min-h-24 border rounded-lg transition-all ${isToday ? 'bg-yellow-100 border-yellow-400 ring-2 ring-yellow-300' : 'bg-white border-gray-200 hover:border-blue-200'}`;

        calendarHTML += `<div class="${dayClasses}">
          <div class="font-semibold mb-2 ${isToday ? 'text-yellow-700' : 'text-gray-700'}">${day}${isToday ? '<span class="ml-1 text-xs">â—</span>' : ''}</div>
          <div class="space-y-1">
            ${dayPosts.map(post => `
              <div onclick="openEditForm(${day}, ${post.id})" class="text-xs bg-white p-2 rounded border border-gray-200 hover:border-blue-400 cursor-pointer transition-all hover:shadow-sm">
                <div class="flex items-center gap-1">
                  <span class="flex items-center gap-1">${renderPlatformBadges(post.platforms)}</span>
                  <span class="font-semibold text-gray-700 truncate">${post.title || 'ç„¡é¡Œ'}</span>
                </div>
              </div>`).join('')}
            <button onclick="openEditForm(${day})" class="w-full text-xs text-gray-500 hover:text-gray-700 py-1 flex items-center justify-center gap-1 hover:bg-gray-50 rounded transition-colors">
              <span class="text-sm">ï¼‹</span> è¿½åŠ 
            </button>
          </div>
        </div>`;
      }

      // å³ãƒšã‚¤ãƒ³ï¼ˆç·¨é›† or è©³ç´°ï¼‰
      let editFormHTML = '';
      if (state.selectedDate) {
        const platformButtons = [
          { value: 'x', label: 'X', color: 'bg-black' },
          { value: 'ig', label: 'IG', color: 'bg-gradient-to-r from-purple-500 to-pink-500' },
          { value: 'l', label: 'L', color: 'bg-green-500' },
          { value: 'm', label: 'M', color: 'bg-blue-600' },
        ];

        if (state.viewMode === 'view') {
          editFormHTML = `
          <div class="bg-white rounded-2xl shadow-xl p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-bold text-gray-800">æŠ•ç¨¿è©³ç´°</h3>
              <button onclick="cancelEdit(); render();" class="p-2 hover:bg-gray-100 rounded-lg transition-colors"><span class="text-2xl">Ã—</span></button>
            </div>
            <div class="space-y-4">
              <div>
                <div class="text-sm text-gray-500 mb-1">æŠ•ç¨¿æ—¥</div>
                <div class="font-semibold text-gray-800">${state.selectedDate}</div>
              </div>
              <div>
                <div class="text-sm text-gray-500 mb-1">ã‚¿ã‚¤ãƒˆãƒ«</div>
                <div class="font-semibold text-gray-800">${state.formData.title || 'ç„¡é¡Œ'}</div>
              </div>
              <div>
                <div class="text-sm text-gray-500 mb-1">æŠ•ç¨¿å…ˆ</div>
                <div class="flex gap-1">${renderPlatformBadges(state.formData.platforms)}</div>
              </div>
              <div>
                <div class="text-sm text-gray-500 mb-1">æŠ•ç¨¿ãƒ†ã‚­ã‚¹ãƒˆ</div>
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 whitespace-pre-wrap">${state.formData.text || 'ãƒ†ã‚­ã‚¹ãƒˆãªã—'}</div>
                <!-- â˜… ã‚³ãƒ”ãƒ¼ã¯æ§ãˆã‚ãªã‚°ãƒ¬ãƒ¼ -->
                <button onclick="copyToClipboard(state.formData.text)" class="mt-2 w-full flex items-center justify-center gap-2 bg-gray-300 text-gray-800 py-2 rounded-lg hover:bg-gray-400 transition-colors">ğŸ“‹ ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼</button>
              </div>
              ${state.formData.images && state.formData.images.length > 0 ? `
              <div>
                <div class="text-sm text-gray-500 mb-2">ç”»åƒï¼ˆ${state.formData.images.length}æšï¼‰</div>
                <div class="grid grid-cols-2 gap-3">
                  ${state.formData.images.map((image, index) => `
                  <div class="relative">
                    <img src="${image}" alt="ç”»åƒ ${index + 1}" class="w-full h-40 object-cover rounded-lg border border-gray-200">
                    <button onclick="downloadImage('${image}', state.formData.title, ${index})" class="absolute bottom-2 right-2 bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600 transition-colors shadow-lg text-sm">â¬‡ ä¿å­˜</button>
                  </div>`).join('')}
                </div>
              </div>` : ''}

              <div class="flex gap-3 pt-4 border-t">
                <!-- â˜… ç·¨é›†ãƒ»å‰Šé™¤ã¯ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ã§å·®åˆ¥åŒ– -->
                <button onclick="switchToEditMode()" class="flex-1 border border-green-600 text-green-700 hover:bg-green-50 py-3 rounded-lg font-semibold transition-colors">âœï¸ ç·¨é›†</button>
                <button onclick="deletePost('${state.selectedDate}', ${state.editingPostId})" class="border border-red-600 text-red-700 hover:bg-red-50 px-6 py-3 rounded-lg font-semibold transition-colors">ğŸ—‘ å‰Šé™¤</button>
              </div>
            </div>
          </div>`;
        } else {
          // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
          editFormHTML = `
          <div class="bg-white rounded-2xl shadow-xl p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-bold text-gray-800">${state.editingPostId ? 'æŠ•ç¨¿ã‚’ç·¨é›†' : 'æ–°è¦æŠ•ç¨¿'} - ${state.selectedDate}</h3>
              <button onclick="cancelEdit(); render();" class="p-2 hover:bg-gray-100 rounded-lg transition-colors"><span class="text-2xl">Ã—</span></button>
            </div>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">æŠ•ç¨¿ã‚¿ã‚¤ãƒˆãƒ«</label>
                <input type="text" value="${state.formData.title}" onchange="state.formData.title = this.value" placeholder="ä¾‹: æ–°å•†å“å‘ŠçŸ¥" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">æŠ•ç¨¿å…ˆï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
                <div class="grid grid-cols-4 gap-2">
                  ${platformButtons.map(p => {
                    const active = state.formData.platforms.includes(p.value);
                    const base = 'w-full py-2 px-3 rounded-lg font-semibold text-white text-sm transition-all';
                    return `<button type="button" onclick="togglePlatform('${p.value}')" class="${base} ${active ? `${p.color} ring-2 ring-offset-2 ring-blue-300` : 'bg-gray-300 hover:bg-gray-400'}">${p.label}</button>`;
                  }).join('')}
                </div>
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">æŠ•ç¨¿ãƒ†ã‚­ã‚¹ãƒˆ</label>
                <textarea onchange="state.formData.text = this.value" placeholder="æŠ•ç¨¿ã™ã‚‹æ–‡ç« ã‚’å…¥åŠ›..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" rows="6">${state.formData.text || ''}</textarea>
                <button onclick="copyToClipboard(state.formData.text)" class="mt-2 w-full flex items-center justify-center gap-2 bg-gray-300 text-gray-800 py-2 rounded-lg hover:bg-gray-400 transition-colors">ğŸ“‹ ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼</button>
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">ç”»åƒï¼ˆæœ€å¤§5æšï¼‰<span class="ml-2 text-xs text-gray-500">${state.formData.images.length} / 5</span></label>
                <div class="border-2 border-dashed rounded-lg p-4 text-center border-gray-300 hover:border-blue-400">
                  ${state.formData.images.length > 0 ? `
                  <div>
                    <div class="grid grid-cols-3 gap-2 mb-3">
                      ${state.formData.images.map((image, index) => `
                        <div class="relative group">
                          <img src="${image}" alt="ç”»åƒ ${index + 1}" class="w-full h-24 object-cover rounded-lg" />
                          <button onclick="removeImage(${index})" class="absolute top-1 right-1 bg-red-500 text-white p-1 rounded-full hover:bg-red-600 transition-colors shadow-lg opacity-0 group-hover:opacity-100">Ã—</button>
                        </div>`).join('')}
                    </div>
                    ${state.formData.images.length < 5 ? `
                      <label class="inline-block bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg cursor-pointer transition-colors text-sm">+ ã•ã‚‰ã«è¿½åŠ 
                        <input type="file" accept="image/*" multiple onchange="handleImageSelect(event)" class="hidden" />
                      </label>` : ''}
                  </div>` : `
                  <div>
                    <p class="text-gray-600 mb-2 text-sm">ğŸ“¸ ç”»åƒã‚’é¸æŠ</p>
                    <label class="inline-block bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg cursor-pointer transition-colors text-sm">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                      <input type="file" accept="image/*" multiple onchange="handleImageSelect(event)" class="hidden" />
                    </label>
                  </div>`}
                </div>
              </div>
              <div class="flex gap-3 pt-2">
                <button onclick="savePost()" ${state.isSaving ? 'disabled' : ''} class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg font-semibold transition-colors ${state.isSaving ? 'opacity-50 cursor-not-allowed' : ''}">${state.isSaving ? 'â³ ä¿å­˜ä¸­...' : (state.editingPostId ? 'æ›´æ–°' : 'ä¿å­˜')}</button>
              </div>
            </div>
          </div>`;
        }
      }

      // ç”»é¢å…¨ä½“
      document.getElementById('app').innerHTML = `
        <div class="flex items-center justify-between mb-4">
          <h1 class="text-4xl font-bold text-gray-800">ğŸ“± SNSæŠ•ç¨¿ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h1>
          <div class="flex items-center gap-2">
            <button onclick="goToday()" class="text-sm px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-100">æœ¬æ—¥ã«æˆ»ã‚‹</button>
            <div class="text-right text-xs text-gray-400">ã‚¢ãƒ—ãƒªæ›´æ–°: ${APP_VERSION}</div>
          </div>
        </div>
        ${state.lastUpdated ? `<div class="text-right text-sm text-gray-500 mb-2">ãƒ‡ãƒ¼ã‚¿æœ€çµ‚æ›´æ–°: ${formatDateTime(state.lastUpdated)}</div>` : ''}

        <div class="mb-4 text-center">
          ${!state.isSignedIn ? `
            <button onclick="handleAuthClick()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors shadow-lg">ğŸ”— Google Driveã«æ¥ç¶š</button>
            <p class="text-sm text-gray-600 mt-2">ãƒ‡ãƒ¼ã‚¿ã‚’å…±æœ‰ãƒ‰ãƒ©ã‚¤ãƒ–ã«è‡ªå‹•ä¿å­˜ã—ã¾ã™</p>`
          : `
            <div class="inline-flex items-center gap-4">
              <div class="inline-flex items-center gap-2 bg-green-100 text-green-700 px-4 py-2 rounded-lg">âœ… å…±æœ‰ãƒ‰ãƒ©ã‚¤ãƒ–ã«æ¥ç¶šæ¸ˆã¿ - è‡ªå‹•ä¿å­˜ãŒæœ‰åŠ¹ã§ã™</div>
              <button onclick="handleSignOut()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm transition-colors">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>`}
        </div>

        <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
          <div class="flex items-center justify-between">
            <button onclick="state.currentDate.setMonth(state.currentDate.getMonth() - 1); render();" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">â—€</button>
            <h2 class="text-2xl font-bold text-gray-800">${monthName}</h2>
            <button onclick="state.currentDate.setMonth(state.currentDate.getMonth() + 1); render();" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">â–¶</button>
          </div>
          <div class="grid grid-cols-7 gap-2 mt-6">${calendarHTML}</div>
        </div>

        <div class="${state.selectedDate ? 'block' : ''}">${editFormHTML || '<div class="bg-gray-50 rounded-2xl shadow-xl p-6 text-center text-gray-500">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„</div>'}</div>
      `;
    }

    function togglePlatform(value) {
      const set = new Set(state.formData.platforms || []);
      if (set.has(value)) set.delete(value); else set.add(value);
      state.formData.platforms = Array.from(set);
      render();
    }

    function goToday() {
      const t = new Date();
      state.currentDate = new Date(t.getFullYear(), t.getMonth(), 1);
      render();
    }

    // ãƒˆãƒ¼ã‚¹ãƒˆ
    function showMessage(message, type) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white z-50 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
      messageDiv.textContent = message; document.body.appendChild(messageDiv);
      setTimeout(() => messageDiv.remove(), 3000);
    }

    // èµ·å‹•
    window.addEventListener('load', () => { gapiLoaded(); gisLoaded(); });
  </script>
</body>
</html>
